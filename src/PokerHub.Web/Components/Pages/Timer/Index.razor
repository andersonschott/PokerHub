@page "/timer/{TournamentId:guid}"
@rendermode InteractiveServer
@implements IAsyncDisposable
@inject ITournamentService TournamentService
@inject IPrizeTableService PrizeTableService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Timer - @(_tournamentName ?? "Torneio")</PageTitle>

@{
    var isMobile = _screenWidth < 900;
    var isSmallMobile = _screenWidth < 480;

    // Main container style - desktop sizes increased 130% for TV visibility
    var containerStyle = "display: grid; min-height: 100vh; color: #fff; font-family: 'Space Grotesk', 'Segoe UI', sans-serif; cursor: pointer; user-select: none; overflow: hidden; " +
        $"padding: {(isMobile ? "16px" : "32px")}; gap: {(isMobile ? "12px" : "32px")}; " +
        $"background: linear-gradient(135deg, {(_isBreak ? "#1a2a1a 0%, #1a3320 50%, #0d1f15" : "#0a0f1a 0%, #0d1420 50%, #101820")} 100%); " +
        (isMobile ? "grid-template-columns: 1fr; grid-template-rows: auto auto 1fr auto;" : "grid-template-columns: 390px 1fr 442px; grid-template-rows: auto 1fr auto;");

    if (_isFullscreen)
    {
        containerStyle = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; z-index: 99999; display: grid; color: #fff; font-family: 'Space Grotesk', 'Segoe UI', sans-serif; cursor: pointer; user-select: none; overflow: hidden; " +
            $"padding: {(isMobile ? "16px" : "32px")}; gap: {(isMobile ? "12px" : "32px")}; " +
            $"background: linear-gradient(135deg, {(_isBreak ? "#1a2a1a 0%, #1a3320 50%, #0d1f15" : "#0a0f1a 0%, #0d1420 50%, #101820")} 100%); " +
            (isMobile ? "grid-template-columns: 1fr; grid-template-rows: auto 1fr;" : "grid-template-columns: 390px 1fr 442px; grid-template-rows: 1fr;");
    }

    // Font sizes based on screen - desktop increased 130%
    var levelFontSize = isSmallMobile ? "16px" : isMobile ? "20px" : "36px";
    var blindFontSize = isSmallMobile ? "40px" : isMobile ? "56px" : "143px";
    var separatorFontSize = isSmallMobile ? "28px" : isMobile ? "36px" : "91px";
    var timerFontSize = isSmallMobile ? "48px" : isMobile ? "64px" : "182px";
    var timerPadding = isSmallMobile ? "12px 20px" : isMobile ? "16px 32px" : "36px 73px";
}

<div style="@containerStyle" @onclick="ToggleFullscreen">
    @if (_loading)
    {
        <div style="grid-column: 1 / -1; grid-row: 1 / -1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 16px;">
            <MudProgressCircular Color="Color.Success" Size="Size.Large" Indeterminate="true" />
            <span style="font-size: 18px; color: #9ca3af;">Carregando torneio...</span>
        </div>
    }
    else if (_error != null)
    {
        <div style="grid-column: 1 / -1; grid-row: 1 / -1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 16px;">
            <MudAlert Severity="Severity.Error">@_error</MudAlert>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/">Voltar</MudButton>
        </div>
    }
    else
    {
        @* ===== HEADER ===== *@
        @if (!_isFullscreen)
        {
            <header style="grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #1f2937; @(isMobile ? "flex-direction: column; gap: 8px; align-items: flex-start;" : "")">
                <h1 style="font-size: @(isMobile ? "18px" : "31px"); font-weight: 700; letter-spacing: -0.5px; margin: 0;">@_tournamentName</h1>
                <div style="display: flex; align-items: center; gap: @(isMobile ? "12px" : "32px"); @(isMobile ? "width: 100%; justify-content: space-between;" : "")">
                    @if (_isPaused)
                    {
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px 21px; border-radius: 31px; font-size: @(isMobile ? "14px" : "18px"); font-weight: 600; background: rgba(234, 179, 8, 0.15); border: 1px solid rgba(234, 179, 8, 0.3); color: #eab308;">
                            <span style="width: 10px; height: 10px; border-radius: 50%; background: currentColor;"></span>
                            PAUSADO
                        </div>
                    }
                    else if (!_isFinished)
                    {
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px 21px; border-radius: 31px; font-size: @(isMobile ? "14px" : "18px"); font-weight: 600; background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); color: #22c55e;">
                            <span style="width: 10px; height: 10px; border-radius: 50%; background: currentColor;"></span>
                            AO VIVO
                        </div>
                    }
                    <span style="font-family: 'JetBrains Mono', monospace; font-size: @(isMobile ? "14px" : "24px"); color: #9ca3af;">@DateTime.Now.ToString("HH:mm")</span>
                </div>
            </header>
        }

        @* ===== STATS ROW (Mobile/Tablet) ===== *@
        @if (isMobile)
        {
            <div style="display: grid; grid-template-columns: repeat(@(isSmallMobile ? 2 : 4), 1fr); gap: @(isSmallMobile ? "8px" : "10px");">
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; padding: 8px 4px; background: #111827; border-radius: 12px; border: 1px solid #1f2937;">
                    <span>üë•</span>
                    <span style="font-family: 'JetBrains Mono', monospace; font-size: @(isSmallMobile ? "14px" : "16px"); font-weight: 700;">@_playersRemaining/@_totalPlayers</span>
                    <span style="font-size: 9px; color: #6b7280; text-transform: uppercase;">Jogadores</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; padding: 8px 4px; background: #111827; border-radius: 12px; border: 1px solid #1f2937;">
                    <span>üí∞</span>
                    <span style="font-family: 'JetBrains Mono', monospace; font-size: @(isSmallMobile ? "14px" : "16px"); font-weight: 700; color: #22c55e;">@_prizePool.ToString("C0")</span>
                    <span style="font-size: 9px; color: #6b7280; text-transform: uppercase;">Prize Pool</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; padding: 8px 4px; background: #111827; border-radius: 12px; border: 1px solid #1f2937;">
                    <span>üîÑ</span>
                    <span style="font-family: 'JetBrains Mono', monospace; font-size: @(isSmallMobile ? "14px" : "16px"); font-weight: 700;">@_totalRebuys</span>
                    <span style="font-size: 9px; color: #6b7280; text-transform: uppercase;">Rebuys</span>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; padding: 8px 4px; background: #111827; border-radius: 12px; border: 1px solid #1f2937;">
                    <span>‚ûï</span>
                    <span style="font-family: 'JetBrains Mono', monospace; font-size: @(isSmallMobile ? "14px" : "16px"); font-weight: 700;">@_totalAddons</span>
                    <span style="font-size: 9px; color: #6b7280; text-transform: uppercase;">Add-ons</span>
                </div>
            </div>
        }

        @* ===== PAINEL ESQUERDO - PREMIA√á√ÉO ===== *@
        @if (!isMobile)
        {
            <aside style="display: flex; flex-direction: column; gap: 21px; overflow: hidden;">
                <div style="font-size: 18px; font-weight: 600; color: #9ca3af; text-transform: uppercase; letter-spacing: 3px; padding-bottom: 10px; border-bottom: 1px solid #1f2937;">üèÜ Premia√ß√£o</div>
                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, #111827 100%); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 21px; padding: 26px; text-align: center;">
                    <div style="font-size: 16px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">Prize Pool</div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 42px; font-weight: 800; color: #22c55e; text-shadow: 0 0 40px rgba(34, 197, 94, 0.3);">@_prizePool.ToString("C")</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto;">
                    @foreach (var prize in _prizeDistribution.Take(5))
                    {
                        var bgGradient = prize.Position switch { 1 => "linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, #111827 100%)", 2 => "linear-gradient(135deg, rgba(192, 192, 192, 0.08) 0%, #111827 100%)", 3 => "linear-gradient(135deg, rgba(205, 127, 50, 0.08) 0%, #111827 100%)", _ => "#111827" };
                        var borderColor = prize.Position switch { 1 => "rgba(255, 215, 0, 0.3)", 2 => "rgba(192, 192, 192, 0.2)", 3 => "rgba(205, 127, 50, 0.2)", _ => "#1f2937" };
                        var valueColor = prize.Position switch { 1 => "#ffd700", 2 => "#c0c0c0", 3 => "#cd7f32", _ => "#ffffff" };
                        var emoji = prize.Position switch { 1 => "ü•á", 2 => "ü•à", 3 => "ü•â", _ => $"{prize.Position}¬∫" };
                        <div style="display: flex; align-items: center; gap: 16px; padding: 18px 21px; background: @bgGradient; border-radius: 16px; border: 1px solid @borderColor;">
                            <span style="font-size: 31px; width: 47px; text-align: center;">@emoji</span>
                            <div style="flex: 1;">
                                <div style="font-size: 16px; color: #6b7280;">@prize.Position ¬∫ Lugar</div>
                                <div style="font-family: 'JetBrains Mono', monospace; font-size: 26px; font-weight: 700; color: @valueColor;">@prize.Amount.ToString("C")</div>
                            </div>
                            @if (prize.Percentage.HasValue)
                            {
                                <span style="font-family: 'JetBrains Mono', monospace; font-size: 17px; color: #6b7280; padding: 5px 13px; background: #0a0f1a; border-radius: 10px;">@prize.Percentage.Value.ToString("0")%</span>
                            }
                        </div>
                    }
                </div>
            </aside>
        }

        @* ===== CENTRO - TIMER ===== *@
        <main style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: @(isMobile ? "12px" : "16px");">
            @if (_isFinished)
            {
                <div style="text-align: center;">
                    <div style="font-size: @(isMobile ? "80px" : "156px"); margin-bottom: 21px;">üèÜ</div>
                    <div style="font-size: @(isSmallMobile ? "24px" : isMobile ? "32px" : "62px"); font-weight: 800; color: #ffd700; text-shadow: 0 0 52px rgba(255, 215, 0, 0.4);">TORNEIO FINALIZADO</div>
                    <div style="font-size: @(isMobile ? "16px" : "31px"); color: #9ca3af; margin-top: 10px;">Parab√©ns ao campe√£o!</div>
                </div>
            }
            else if (_isBreak)
            {
                <div style="font-size: @levelFontSize; font-weight: 700; color: #eab308; text-transform: uppercase; letter-spacing: @(isMobile ? "4px" : "8px"); text-shadow: 0 0 52px rgba(234, 179, 8, 0.4);">‚òï INTERVALO</div>
                @if (!string.IsNullOrEmpty(_breakDescription))
                {
                    <div style="font-size: @(isMobile ? "14px" : "24px"); color: #9ca3af;">@_breakDescription</div>
                }
                <div style="background: #111827; border: 4px solid @GetTimerBorderColor(); border-radius: 31px; padding: @timerPadding; margin: @(isMobile ? "12px 0" : "26px 0"); box-shadow: 0 0 78px @GetTimerGlowColor();">
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: @timerFontSize; font-weight: 800; letter-spacing: @(isSmallMobile ? "2px" : isMobile ? "4px" : "10px"); line-height: 1; color: @GetTimerTextColor(); text-shadow: 0 0 78px rgba(255, 255, 255, 0.2);">@FormatTime(_secondsRemaining)</div>
                </div>
                @if (_nextLevel != null)
                {
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 5px; padding: @(isMobile ? "10px 20px" : "18px 36px"); background: #1a2332; border-radius: 21px; border: 1px solid #1f2937;">
                        <span style="font-size: @(isMobile ? "11px" : "17px"); color: #22c55e; text-transform: uppercase; letter-spacing: 3px;">Pr√≥ximo N√≠vel</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-size: @(isMobile ? "16px" : "26px"); font-weight: 600;">@FormatChips(_nextLevel.SmallBlind) / @FormatChips(_nextLevel.BigBlind)@(_nextLevel.Ante > 0 ? $" (Ante: {FormatChips(_nextLevel.Ante)})" : "")</span>
                    </div>
                }
            }
            else
            {
                <div style="font-size: @levelFontSize; font-weight: 700; color: #22c55e; text-transform: uppercase; letter-spacing: @(isMobile ? "4px" : "8px"); text-shadow: 0 0 52px rgba(34, 197, 94, 0.4);">N√çVEL @_currentLevel</div>
                <div style="display: flex; align-items: baseline; gap: @(isMobile ? "8px" : "10px");">
                    <span style="font-family: 'JetBrains Mono', monospace; font-size: @blindFontSize; font-weight: 800; line-height: 1; background: linear-gradient(180deg, #ffffff 0%, #a0a0a0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">@FormatChips(_smallBlind)</span>
                    <span style="font-family: 'JetBrains Mono', monospace; font-size: @separatorFontSize; font-weight: 300; color: #6b7280; margin: 0 -10px;">/</span>
                    <span style="font-family: 'JetBrains Mono', monospace; font-size: @blindFontSize; font-weight: 800; line-height: 1; background: linear-gradient(180deg, #ffffff 0%, #a0a0a0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">@FormatChips(_bigBlind)</span>
                </div>
                @if (_ante > 0)
                {
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: @(isSmallMobile ? "14px" : isMobile ? "18px" : "31px"); color: #9ca3af; margin-top: 5px;">ANTE: @FormatChips(_ante)</div>
                }
                <div style="background: #111827; border: 4px solid @GetTimerBorderColor(); border-radius: 31px; padding: @timerPadding; margin: @(isMobile ? "12px 0" : "26px 0"); box-shadow: 0 0 78px @GetTimerGlowColor();">
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: @timerFontSize; font-weight: 800; letter-spacing: @(isSmallMobile ? "2px" : isMobile ? "4px" : "10px"); line-height: 1; color: @GetTimerTextColor(); text-shadow: 0 0 78px rgba(255, 255, 255, 0.2);">@FormatTime(_secondsRemaining)</div>
                </div>
                @if (_nextLevel != null)
                {
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 5px; padding: @(isMobile ? "10px 20px" : "18px 36px"); background: #1a2332; border-radius: 21px; border: 1px solid #1f2937;">
                        <span style="font-size: @(isMobile ? "11px" : "17px"); color: #22c55e; text-transform: uppercase; letter-spacing: 3px;">Pr√≥ximo N√≠vel</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-size: @(isMobile ? "16px" : "26px"); font-weight: 600;">
                            @if (_nextLevel.IsBreak)
                            {
                                <text>Intervalo @(!string.IsNullOrEmpty(_nextLevel.BreakDescription) ? $"({_nextLevel.BreakDescription})" : "")</text>
                            }
                            else
                            {
                                <text>@FormatChips(_nextLevel.SmallBlind) / @FormatChips(_nextLevel.BigBlind)@(_nextLevel.Ante > 0 ? $" (Ante: {FormatChips(_nextLevel.Ante)})" : "")</text>
                            }
                        </span>
                    </div>
                }
            }
        </main>

        @* ===== PAINEL DIREITO - JOGADORES ===== *@
        @if (!isMobile)
        {
            <aside style="display: flex; flex-direction: column; gap: 16px; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #1f2937;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-family: 'JetBrains Mono', monospace; font-size: 31px; font-weight: 700;">@_playersRemaining</span>
                        <span style="font-size: 18px; color: #6b7280;">/ @_totalPlayers jogadores</span>
                    </div>
                    <div style="display: flex; gap: 21px;">
                        <span style="font-size: 17px; color: #9ca3af;">üîÑ <b>@_totalRebuys</b></span>
                        <span style="font-size: 17px; color: #9ca3af;">‚ûï <b>@_totalAddons</b></span>
                    </div>
                </div>
                <div style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; padding-right: 10px;">
                    @foreach (var player in _players.OrderBy(p => p.IsEliminated ? 1 : 0).ThenBy(p => p.Name))
                    {
                        <div style="display: flex; align-items: center; gap: 16px; padding: 13px 18px; background: #111827; border-radius: 13px; border: 1px solid #1f2937; @(player.IsEliminated ? "opacity: 0.4;" : "")">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 20px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@GetDisplayName(player)</div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                @if (player.IsEliminated && player.Position.HasValue)
                                {
                                    <span style="padding: 5px 10px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);">@player.Position ¬∫</span>
                                }
                                @if (player.RebuyCount > 0)
                                {
                                    <span style="padding: 5px 10px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; background: rgba(234, 179, 8, 0.15); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.3);">R√ó@player.RebuyCount</span>
                                }
                                @if (player.HasAddon)
                                {
                                    <span style="padding: 5px 10px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; background: rgba(139, 92, 246, 0.15); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.3);">A</span>
                                }
                            </div>
                        </div>
                    }
                </div>
            </aside>
        }

        @* ===== FOOTER ===== *@
        <footer style="@(_isFullscreen ? "position: absolute; bottom: 21px; left: 0; right: 0;" : "grid-column: 1 / -1; padding-top: 21px; border-top: 1px solid #1f2937;") display: flex; justify-content: center; align-items: center; gap: @(isMobile ? "8px" : "42px"); @(isMobile && !_isFullscreen ? "flex-direction: column;" : "")">
            @if (!_isFullscreen)
            {
                <span style="font-size: @(isMobile ? "11px" : "17px"); color: #6b7280;">Clique para tela cheia</span>
            }
            <div style="display: flex; align-items: center; gap: 10px; font-size: @(isMobile ? "13px" : "17px");">
                @if (_isReconnecting)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Style="@($"width: {(isMobile ? "16px" : "21px")}; height: {(isMobile ? "16px" : "21px")};")" />
                    <span style="color: #eab308;">Reconectando...</span>
                }
                else if (_isDisconnected)
                {
                    <span style="color: #ef4444;">‚óè Offline @(_connectionError != null ? $"({_connectionError})" : "")</span>
                }
                else
                {
                    <span style="color: #22c55e;">‚óè Online</span>
                }
            </div>
            @if (_isFullscreen)
            {
                <span style="font-size: @(isMobile ? "11px" : "14px"); color: #6b7280;">ESC para sair</span>
            }
        </footer>
    }
</div>

@code {
    [Parameter] public Guid TournamentId { get; set; }

    private HubConnection? _hubConnection;
    private bool _loading = true;
    private string? _error;
    private bool _isFullscreen;
    private System.Timers.Timer? _clockTimer;
    private int _screenWidth = 1920;

    // Connection state
    private bool _isReconnecting;
    private bool _isDisconnected;
    private string? _connectionError;

    // Handler disposables
    private IDisposable? _timerTickHandler;
    private IDisposable? _levelChangedHandler;
    private IDisposable? _pausedHandler;
    private IDisposable? _resumedHandler;
    private IDisposable? _eliminatedHandler;
    private IDisposable? _prizePoolHandler;
    private IDisposable? _finishedHandler;
    private IDisposable? _timerStateHandler;
    private IDisposable? _playerUpdatedHandler;

    // Tournament info
    private string? _tournamentName;
    private bool _isPaused;
    private bool _isFinished;
    private int _playersRemaining;
    private int _totalPlayers;
    private decimal _prizePool;
    private int _totalRebuys;
    private int _totalAddons;
    private string? _prizeStructure;
    private Guid _leagueId;
    private bool _usePrizeTable;

    // Timer state
    private int _secondsRemaining;
    private int _currentLevel;
    private decimal _smallBlind;
    private decimal _bigBlind;
    private decimal _ante;
    private bool _isBreak;
    private string? _breakDescription;
    private BlindLevelDto? _nextLevel;

    // Prize distribution
    private List<PrizeInfo> _prizeDistribution = new();

    // Players
    private List<PlayerInfo> _players = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get full tournament details
            var detail = await TournamentService.GetTournamentDetailAsync(TournamentId);
            if (detail == null)
            {
                var tournament = await TournamentService.GetTournamentByIdAsync(TournamentId);
                if (tournament == null)
                {
                    _error = "Torneio n√£o encontrado";
                    _loading = false;
                    return;
                }
                _tournamentName = tournament.Name;
                _prizePool = tournament.PrizePool;
                _totalPlayers = tournament.PlayerCount;
                _playersRemaining = tournament.CheckedInCount;
                _isFinished = tournament.Status == TournamentStatus.Finished;
                _leagueId = tournament.LeagueId;
            }
            else
            {
                _tournamentName = detail.Name;
                _prizePool = detail.PrizePool;
                _totalPlayers = detail.Players.Count;
                _playersRemaining = detail.Players.Count(p => p.EliminatedAt == null);
                _totalRebuys = detail.Players.Sum(p => p.RebuyCount);
                _totalAddons = detail.Players.Count(p => p.HasAddon);
                _isFinished = detail.Status == TournamentStatus.Finished;
                _isPaused = detail.Status == TournamentStatus.Paused;
                _prizeStructure = detail.PrizeStructure;
                _leagueId = detail.LeagueId;
                _usePrizeTable = detail.UsePrizeTable;
                _currentLevel = detail.CurrentLevel;
                _secondsRemaining = detail.TimeRemainingSeconds ?? 0;

                _players = detail.Players.Select(p => new PlayerInfo
                {
                    Id = p.PlayerId,
                    Name = p.PlayerName,
                    Nickname = p.Nickname,
                    RebuyCount = p.RebuyCount,
                    HasAddon = p.HasAddon,
                    IsEliminated = p.EliminatedAt.HasValue,
                    Position = p.Position
                }).ToList();

                var currentBlind = detail.BlindLevels.FirstOrDefault(b => b.Order == detail.CurrentLevel);
                if (currentBlind != null)
                {
                    _smallBlind = currentBlind.SmallBlind;
                    _bigBlind = currentBlind.BigBlind;
                    _ante = currentBlind.Ante;
                    _isBreak = currentBlind.IsBreak;
                    _breakDescription = currentBlind.BreakDescription;
                }

                _nextLevel = detail.BlindLevels.FirstOrDefault(b => b.Order == detail.CurrentLevel + 1);
            }

            await CalculatePrizeDistribution();

            var timerState = await TournamentService.GetTimerStateAsync(TournamentId);
            if (timerState != null)
            {
                UpdateTimerState(timerState);
            }

            await SetupSignalR();

            _clockTimer = new System.Timers.Timer(1000);
            _clockTimer.Elapsed += async (s, e) =>
            {
                try { _screenWidth = await JS.InvokeAsync<int>("eval", "window.innerWidth"); } catch { }
                await InvokeAsync(StateHasChanged);
            };
            _clockTimer.Start();

            _loading = false;
        }
        catch (Exception ex)
        {
            _error = $"Erro ao carregar: {ex.Message}";
            _loading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try { _screenWidth = await JS.InvokeAsync<int>("eval", "window.innerWidth"); StateHasChanged(); } catch { }
        }
    }

    private async Task CalculatePrizeDistribution()
    {
        try
        {
            var result = await PrizeTableService.CalculatePrizeDistributionAsync(_leagueId, _prizePool, _prizeStructure, _usePrizeTable);
            _prizeDistribution = result.Allocations.Select(a => new PrizeInfo { Position = a.Position, Amount = a.Amount, Percentage = _prizePool > 0 ? (a.Amount / _prizePool) * 100 : null }).ToList();
        }
        catch
        {
            if (!string.IsNullOrEmpty(_prizeStructure))
            {
                var percentages = _prizeStructure.Split(',').Select(s => decimal.TryParse(s.Trim(), out var val) ? val : 0).ToList();
                _prizeDistribution = percentages.Select((p, i) => new PrizeInfo { Position = i + 1, Amount = _prizePool * (p / 100), Percentage = p }).Where(p => p.Amount > 0).ToList();
            }
        }
    }

    private async Task SetupSignalR()
    {
        try
        {
            _connectionError = null;
            _isDisconnected = false;

            _hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/hubs/torneio"), options =>
                {
                    options.HttpMessageHandlerFactory = (handler) =>
                    {
                        if (handler is HttpClientHandler clientHandler)
                        {
                            clientHandler.ServerCertificateCustomValidationCallback =
                                HttpClientHandler.DangerousAcceptAnyServerCertificateValidator;
                        }
                        return handler;
                    };
                })
                .WithAutomaticReconnect(new[] { TimeSpan.Zero, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(10), TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(60), TimeSpan.FromSeconds(120), TimeSpan.FromSeconds(300) })
                .Build();

            _hubConnection.Reconnecting += async (error) =>
            {
                _isReconnecting = true;
                _isDisconnected = false;
                _connectionError = error?.Message;
                await InvokeAsync(StateHasChanged);
            };

            _hubConnection.Reconnected += async (connectionId) =>
            {
                _isReconnecting = false;
                _isDisconnected = false;
                _connectionError = null;
                await _hubConnection.SendAsync("JoinTorneio", TournamentId);
                await RefreshData();
                await InvokeAsync(StateHasChanged);
            };

            _hubConnection.Closed += async (error) =>
            {
                _isDisconnected = true;
                _isReconnecting = false;
                _connectionError = error?.Message;
                await InvokeAsync(StateHasChanged);
            };

            RegisterHubHandlers();

            await _hubConnection.StartAsync();
            _isDisconnected = false;
            _connectionError = null;
            Console.WriteLine($"[Timer] SignalR connected, joining tournament group {TournamentId}");
            await _hubConnection.SendAsync("JoinTorneio", TournamentId);
            Console.WriteLine($"[Timer] Successfully joined tournament group {TournamentId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR connection failed: {ex.Message}");
            _isDisconnected = true;
            _connectionError = ex.Message;
        }
    }

    private void RegisterHubHandlers()
    {
        if (_hubConnection == null) return;

        _timerTickHandler = _hubConnection.On<object>("TimerTick", async (data) =>
        {
            try
            {
                var json = System.Text.Json.JsonSerializer.Serialize(data);
                var tickData = System.Text.Json.JsonSerializer.Deserialize<TimerTickData>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (tickData != null)
                {
                    _secondsRemaining = tickData.SecondsRemaining;
                    _currentLevel = tickData.CurrentLevel;
                    _smallBlind = tickData.SmallBlind;
                    _bigBlind = tickData.BigBlind;
                    _ante = tickData.Ante;
                    _isBreak = tickData.IsBreak;
                    _breakDescription = tickData.BreakDescription;
                    await InvokeAsync(StateHasChanged);
                }
            }
            catch { }
        });

        _levelChangedHandler = _hubConnection.On<object>("NivelAlterado", async (data) =>
        {
            try
            {
                Console.WriteLine($"[Timer] NivelAlterado event received: {System.Text.Json.JsonSerializer.Serialize(data)}");
                var json = System.Text.Json.JsonSerializer.Serialize(data);
                var levelData = System.Text.Json.JsonSerializer.Deserialize<LevelChangedData>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                Console.WriteLine($"[Timer] NivelAlterado deserialized: NewLevel={levelData?.NewLevel?.Order}, IsBreak={levelData?.NewLevel?.IsBreak}");
                if (levelData?.NewLevel != null)
                {
                    _currentLevel = levelData.NewLevel.Order;
                    _smallBlind = levelData.NewLevel.SmallBlind;
                    _bigBlind = levelData.NewLevel.BigBlind;
                    _ante = levelData.NewLevel.Ante;
                    _isBreak = levelData.NewLevel.IsBreak;
                    _breakDescription = levelData.NewLevel.BreakDescription;
                    _nextLevel = levelData.NextLevel != null
                        ? new BlindLevelDto(levelData.NextLevel.Id, levelData.NextLevel.Order, levelData.NextLevel.SmallBlind, levelData.NextLevel.BigBlind, levelData.NextLevel.Ante, levelData.NextLevel.DurationMinutes, levelData.NextLevel.IsBreak, levelData.NextLevel.BreakDescription)
                        : null;
                    Console.WriteLine($"[Timer] NivelAlterado updated state: Level={_currentLevel}, IsBreak={_isBreak}, SB={_smallBlind}, BB={_bigBlind}");
                    await PlayLevelChangeSound();
                    await InvokeAsync(StateHasChanged);
                }
                else
                {
                    Console.WriteLine("[Timer] NivelAlterado: NewLevel is null after deserialization!");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[Timer] NivelAlterado ERROR: {ex.GetType().Name}: {ex.Message}");
            }
        });

        _pausedHandler = _hubConnection.On<int>("TorneioPausado", async (timeRemainingSeconds) =>
        {
            _isPaused = true;
            _secondsRemaining = timeRemainingSeconds;
            await InvokeAsync(StateHasChanged);
        });

        _resumedHandler = _hubConnection.On("TorneioRetomado", async () =>
        {
            _isPaused = false;
            await InvokeAsync(StateHasChanged);
        });

        _eliminatedHandler = _hubConnection.On<object>("JogadorEliminado", async (data) =>
        {
            try
            {
                Console.WriteLine($"[Timer] JogadorEliminado event received: {System.Text.Json.JsonSerializer.Serialize(data)}");
                await RefreshData();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[Timer] JogadorEliminado handler error: {ex.Message}");
            }
        });

        _prizePoolHandler = _hubConnection.On<object>("PrizePoolAtualizado", async (data) =>
        {
            try
            {
                Console.WriteLine($"[Timer] PrizePoolAtualizado event received: {System.Text.Json.JsonSerializer.Serialize(data)}");
                await RefreshData();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[Timer] PrizePoolAtualizado handler error: {ex.Message}");
            }
        });

        _finishedHandler = _hubConnection.On("TorneioFinalizado", async () =>
        {
            _isFinished = true;
            await PlayFinishedSound();
            await InvokeAsync(StateHasChanged);
        });

        _timerStateHandler = _hubConnection.On<TimerStateDto>("TimerStateUpdated", async (state) =>
        {
            UpdateTimerState(state);
            await InvokeAsync(StateHasChanged);
        });

        _playerUpdatedHandler = _hubConnection.On("PlayerUpdated", async () =>
        {
            try
            {
                Console.WriteLine("[Timer] PlayerUpdated event received");
                await RefreshData();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[Timer] PlayerUpdated handler error: {ex.Message}");
            }
        });
    }

    private void UpdateTimerState(TimerStateDto state)
    {
        _tournamentName = state.TournamentName;
        _secondsRemaining = state.TimeRemainingSeconds;
        _currentLevel = state.CurrentLevel;
        _isPaused = state.Status == TournamentStatus.Paused;
        _isFinished = state.Status == TournamentStatus.Finished;
        _playersRemaining = state.PlayersRemaining;
        _totalPlayers = state.TotalPlayers;
        _prizePool = state.PrizePool;
        _totalRebuys = state.TotalRebuys;
        _totalAddons = state.TotalAddons;

        if (state.CurrentBlindLevel != null)
        {
            _smallBlind = state.CurrentBlindLevel.SmallBlind;
            _bigBlind = state.CurrentBlindLevel.BigBlind;
            _ante = state.CurrentBlindLevel.Ante;
            _isBreak = state.CurrentBlindLevel.IsBreak;
            _breakDescription = state.CurrentBlindLevel.BreakDescription;
        }

        _nextLevel = state.NextBlindLevel;
    }

    private async Task RefreshData()
    {
        try
        {
            Console.WriteLine($"[Timer] RefreshData START for tournament {TournamentId}");
            var detail = await TournamentService.GetTournamentDetailAsync(TournamentId);
            Console.WriteLine($"[Timer] RefreshData got detail: {(detail != null ? "OK" : "NULL")}");
            if (detail != null)
            {
                Console.WriteLine($"[Timer] RefreshData detail has {detail.Players.Count} players, PrizePool={detail.PrizePool}");
                _players = detail.Players.Select(p => new PlayerInfo
                {
                    Id = p.PlayerId,
                    Name = p.PlayerName,
                    Nickname = p.Nickname,
                    RebuyCount = p.RebuyCount,
                    HasAddon = p.HasAddon,
                    IsEliminated = p.EliminatedAt.HasValue,
                    Position = p.Position
                }).ToList();

                _playersRemaining = _players.Count(p => !p.IsEliminated);
                _totalRebuys = detail.Players.Sum(p => p.RebuyCount);
                _totalAddons = detail.Players.Count(p => p.HasAddon);
                _prizePool = detail.PrizePool;
                _totalPlayers = detail.Players.Count;

                await CalculatePrizeDistribution();
                Console.WriteLine($"[Timer] RefreshData COMPLETE: {_totalRebuys} rebuys, {_totalAddons} addons, {_playersRemaining} players remaining, prize pool: {_prizePool}");
            }
            else
            {
                Console.WriteLine($"[Timer] RefreshData: detail was null!");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Timer] RefreshData ERROR: {ex.GetType().Name}: {ex.Message}");
            Console.WriteLine($"[Timer] RefreshData STACK: {ex.StackTrace}");
        }
    }

    private string GetDisplayName(PlayerInfo player)
    {
        if (!string.IsNullOrEmpty(player.Nickname)) return player.Nickname;
        var parts = player.Name.Split(' ');
        return parts.Length > 1 ? $"{parts[0]} {parts[^1][0]}." : player.Name;
    }

    private string FormatTime(int totalSeconds)
    {
        if (totalSeconds < 0) totalSeconds = 0;
        return $"{totalSeconds / 60:D2}:{totalSeconds % 60:D2}";
    }

    private string FormatChips(decimal value)
    {
        if (value >= 1000000) return $"{value / 1000000:0.#}M";
        if (value >= 1000) return $"{value / 1000:0.#}K";
        return value.ToString("0");
    }

    private string GetTimerBorderColor() => _secondsRemaining <= 10 ? "#ef4444" : _secondsRemaining <= 60 ? "#eab308" : "#22c55e";
    private string GetTimerTextColor() => _secondsRemaining <= 10 ? "#ef4444" : _secondsRemaining <= 60 ? "#eab308" : "#ffffff";
    private string GetTimerGlowColor() => _secondsRemaining <= 10 ? "rgba(239, 68, 68, 0.4)" : _secondsRemaining <= 60 ? "rgba(234, 179, 8, 0.4)" : "rgba(34, 197, 94, 0.2)";

    private async Task ToggleFullscreen()
    {
        _isFullscreen = !_isFullscreen;
        try
        {
            if (_isFullscreen)
            {
                await JS.InvokeVoidAsync("document.documentElement.requestFullscreen");
                await JS.InvokeVoidAsync("requestWakeLock");
            }
            else
            {
                await JS.InvokeVoidAsync("document.exitFullscreen");
                await JS.InvokeVoidAsync("releaseWakeLock");
            }
        }
        catch { }
    }

    private async Task PlayLevelChangeSound() { try { await JS.InvokeVoidAsync("timerSounds.playLevelChange"); } catch { } }
    private async Task PlayFinishedSound() { try { await JS.InvokeVoidAsync("timerSounds.playFinished"); } catch { } }

    public async ValueTask DisposeAsync()
    {
        _clockTimer?.Stop();
        _clockTimer?.Dispose();
        try { await JS.InvokeVoidAsync("releaseWakeLock"); } catch { }

        _timerTickHandler?.Dispose();
        _levelChangedHandler?.Dispose();
        _pausedHandler?.Dispose();
        _resumedHandler?.Dispose();
        _eliminatedHandler?.Dispose();
        _prizePoolHandler?.Dispose();
        _finishedHandler?.Dispose();
        _timerStateHandler?.Dispose();
        _playerUpdatedHandler?.Dispose();

        if (_hubConnection != null)
        {
            try { await _hubConnection.SendAsync("LeaveTorneio", TournamentId); } catch { }
            await _hubConnection.DisposeAsync();
        }
    }

    private class PrizeInfo { public int Position { get; set; } public decimal Amount { get; set; } public decimal? Percentage { get; set; } }
    private class PlayerInfo { public Guid Id { get; set; } public string Name { get; set; } = ""; public string? Nickname { get; set; } public int RebuyCount { get; set; } public bool HasAddon { get; set; } public bool IsEliminated { get; set; } public int? Position { get; set; } }
    private class TimerTickData { public int SecondsRemaining { get; set; } public int CurrentLevel { get; set; } public decimal SmallBlind { get; set; } public decimal BigBlind { get; set; } public decimal Ante { get; set; } public bool IsBreak { get; set; } public string? BreakDescription { get; set; } }
    private class LevelChangedData { public BlindLevelInfo? NewLevel { get; set; } public BlindLevelInfo? NextLevel { get; set; } }
    private class BlindLevelInfo { public Guid Id { get; set; } public int Order { get; set; } public int SmallBlind { get; set; } public int BigBlind { get; set; } public int Ante { get; set; } public int DurationMinutes { get; set; } public bool IsBreak { get; set; } public string? BreakDescription { get; set; } }
    private class PrizePoolData { public decimal PrizePool { get; set; } public int TotalRebuys { get; set; } public int TotalAddons { get; set; } }
}
