@page "/jogador/{PlayerId:guid}/stats"
@rendermode InteractiveServer
@attribute [Authorize]
@implements IBrowserViewportObserver
@implements IAsyncDisposable
@inject IRankingService RankingService
@inject IPlayerService PlayerService
@inject ILeagueService LeagueService
@inject IBrowserViewportService BrowserViewportService
@inject NavigationManager Navigation

<PageTitle>@(_stats?.PlayerName ?? "Jogador") - Estatisticas</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="player-stats-page mt-4">
    @if (_loading)
    {
        <div class="loading-container">
            <MudProgressCircular Color="Color.Success" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-3">Carregando estatisticas...</MudText>
        </div>
    }
    else if (_stats == null)
    {
        <div class="error-container">
            <MudIcon Icon="@Icons.Material.Filled.PersonOff" Size="Size.Large" Color="Color.Warning" />
            <MudText Typo="Typo.h6" Class="mt-3">Jogador nao encontrado</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Nao ha historico de torneios para este jogador.</MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Class="mt-4" OnClick="@(() => Navigation.NavigateTo("/"))">
                Voltar
            </MudButton>
        </div>
    }
    else
    {
        @* ===== HEADER ===== *@
        <div class="stats-header">
            <div class="player-avatar" style="@GetAvatarStyle()">
                @GetInitials(_stats.PlayerName)
            </div>
            <div class="player-info">
                <div class="player-name">@GetDisplayName()</div>
                <div class="player-league">@(_leagueName ?? "Liga") - @_stats.TournamentsPlayed torneios</div>
            </div>
            @if (_rankingPosition.HasValue)
            {
                <div class="rank-badge">
                    <div class="rank-position">#@_rankingPosition</div>
                    <div class="rank-label">No Ranking</div>
                </div>
            }
        </div>

        @if (_isMobile)
        {
            @* ===== MOBILE LAYOUT ===== *@

            @* Hero Stats *@
            <div class="hero-stats">
                <div class="hero-stat">
                    <div class="hero-stat-icon">üéØ</div>
                    <div class="hero-stat-value">@_stats.TournamentsPlayed</div>
                    <div class="hero-stat-label">Torneios</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-icon">üèÜ</div>
                    <div class="hero-stat-value gold">@_stats.Wins</div>
                    <div class="hero-stat-label">Vitorias</div>
                </div>
                <div class="hero-stat highlight">
                    <div class="hero-stat-icon">üìà</div>
                    <div class="hero-stat-value @(_stats.Profit >= 0 ? "positive" : "negative")">
                        @(_stats.Profit >= 0 ? "+" : "")@_stats.Profit.ToString("C0")
                    </div>
                    <div class="hero-stat-label">Lucro Total</div>
                </div>
            </div>

            @* Podios *@
            <div class="section-title">üèÖ Podios</div>
            <div class="podium-stats">
                <div class="podium-item gold">
                    <div class="podium-medal">ü•á</div>
                    <div class="podium-count">@_stats.Wins</div>
                </div>
                <div class="podium-item silver">
                    <div class="podium-medal">ü•à</div>
                    <div class="podium-count">@_stats.SecondPlaces</div>
                </div>
                <div class="podium-item bronze">
                    <div class="podium-medal">ü•â</div>
                    <div class="podium-count">@_stats.ThirdPlaces</div>
                </div>
            </div>

            @* ROI Card *@
            <div class="roi-card">
                <div class="roi-label">ROI (Return on Investment)</div>
                <div class="roi-value @(_roi >= 0 ? "" : "negative")">@(_roi >= 0 ? "+" : "")@_roi.ToString("N1")%</div>
                <div class="roi-message @(_roi >= 0 ? "" : "negative")">
                    @GetRoiMessage()
                </div>
            </div>

            @* Performance *@
            <div class="section-title">üìä Performance</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">@_itm.ToString("N0")%</div>
                    <div class="stat-label">ITM</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">@_winRate.ToString("N0")%</div>
                    <div class="stat-label">Taxa Vitoria</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">@_stats.AveragePosition.ToString("N1")¬∫</div>
                    <div class="stat-label">Pos. Media</div>
                </div>
            </div>

            @* Financeiro *@
            <div class="section-title">üí∞ Financeiro</div>
            <div class="stats-list">
                <div class="stat-row">
                    <span class="stat-row-label">Total Investido</span>
                    <span class="stat-row-value">@_stats.TotalBuyIns.ToString("C")</span>
                </div>
                <div class="stat-row">
                    <span class="stat-row-label">Total em Premios</span>
                    <span class="stat-row-value">@_stats.TotalPrizes.ToString("C")</span>
                </div>
                <div class="stat-row">
                    <span class="stat-row-label">Lucro/Prejuizo</span>
                    <span class="stat-row-value @(_stats.Profit >= 0 ? "positive" : "negative")">
                        @(_stats.Profit >= 0 ? "+" : "")@_stats.Profit.ToString("C")
                    </span>
                </div>
                @if (_stats.BestResult.HasValue)
                {
                    <div class="stat-row">
                        <span class="stat-row-label">Melhor Resultado</span>
                        <span class="stat-row-value positive">+@_stats.BestResult.Value.ToString("C")</span>
                    </div>
                }
                @if (_stats.WorstResult.HasValue)
                {
                    <div class="stat-row">
                        <span class="stat-row-label">Pior Resultado</span>
                        <span class="stat-row-value negative">@_stats.WorstResult.Value.ToString("C")</span>
                    </div>
                }
            </div>

            @* Historico Mobile *@
            @if (_stats.RecentResults.Any())
            {
                <div class="section-title">üìÖ Ultimos Torneios</div>
                <div class="history-list">
                    @foreach (var result in _stats.RecentResults.Take(10))
                    {
                        <div class="history-item" @onclick="() => NavigateToTournament(result.TournamentId)">
                            <div class="history-header">
                                <div>
                                    <div class="history-name">@result.TournamentName</div>
                                    <div class="history-date">@result.Date.ToString("dd/MM/yyyy")</div>
                                </div>
                                <div class="history-result @(result.Profit >= 0 ? "positive" : "negative")">
                                    @(result.Profit >= 0 ? "+" : "")@result.Profit.ToString("C")
                                </div>
                            </div>
                            <div class="history-details">
                                <div class="history-detail">
                                    <span class="position-badge @GetPositionClass(result.Position)">
                                        @(result.Position.HasValue ? $"{result.Position}¬∫" : "-") / @result.TotalPlayers
                                    </span>
                                </div>
                                <div class="history-detail">
                                    Invest: @result.Investment.ToString("C0")
                                </div>
                                <div class="history-detail">
                                    Premio: @result.Prize.ToString("C0")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }
        else
        {
            @* ===== DESKTOP LAYOUT ===== *@

            @* Hero Stats - 4 columns *@
            <div class="hero-stats desktop">
                <div class="hero-stat">
                    <div class="hero-stat-icon">üéØ</div>
                    <div class="hero-stat-value">@_stats.TournamentsPlayed</div>
                    <div class="hero-stat-label">Torneios</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-icon">üèÜ</div>
                    <div class="hero-stat-value gold">@_stats.Wins</div>
                    <div class="hero-stat-label">Vitorias</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-icon">‚≠ê</div>
                    <div class="hero-stat-value">@_stats.Top3Finishes</div>
                    <div class="hero-stat-label">Top 3</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-icon">üìà</div>
                    <div class="hero-stat-value @(_stats.Profit >= 0 ? "positive" : "negative")">
                        @(_stats.Profit >= 0 ? "+" : "")@_stats.Profit.ToString("C0")
                    </div>
                    <div class="hero-stat-label">Lucro</div>
                </div>
            </div>

            @* Two Column Layout *@
            <div class="desktop-grid">
                @* Left Column *@
                <div class="desktop-left">
                    @* Podios + ROI side by side *@
                    <div class="podium-roi-row">
                        <div class="podium-section">
                            <div class="section-title">üèÖ Podios</div>
                            <div class="podium-stats compact">
                                <div class="podium-item gold">
                                    <div class="podium-medal">ü•á</div>
                                    <div class="podium-count">@_stats.Wins</div>
                                </div>
                                <div class="podium-item silver">
                                    <div class="podium-medal">ü•à</div>
                                    <div class="podium-count">@_stats.SecondPlaces</div>
                                </div>
                                <div class="podium-item bronze">
                                    <div class="podium-medal">ü•â</div>
                                    <div class="podium-count">@_stats.ThirdPlaces</div>
                                </div>
                            </div>
                        </div>
                        <div class="roi-section">
                            <div class="section-title">üí∞ ROI</div>
                            <div class="roi-card compact">
                                <div class="roi-value @(_roi >= 0 ? "" : "negative")">@(_roi >= 0 ? "+" : "")@_roi.ToString("N1")%</div>
                                <div class="roi-message @(_roi >= 0 ? "" : "negative")">
                                    @GetRoiMessageShort()
                                </div>
                            </div>
                        </div>
                    </div>

                    @* Estatisticas Financeiras *@
                    <div class="section-title">üíµ Estatisticas Financeiras</div>
                    <div class="stats-list">
                        <div class="stat-row">
                            <span class="stat-row-label">Total em Buy-ins</span>
                            <span class="stat-row-value">@_stats.TotalBuyIns.ToString("C")</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Total em Premios</span>
                            <span class="stat-row-value">@_stats.TotalPrizes.ToString("C")</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Lucro/Prejuizo</span>
                            <span class="stat-row-value @(_stats.Profit >= 0 ? "positive" : "negative")">
                                @(_stats.Profit >= 0 ? "+" : "")@_stats.Profit.ToString("C")
                            </span>
                        </div>
                        @if (_stats.BestResult.HasValue)
                        {
                            <div class="stat-row">
                                <span class="stat-row-label">Melhor Resultado</span>
                                <span class="stat-row-value positive">+@_stats.BestResult.Value.ToString("C")</span>
                            </div>
                        }
                        @if (_stats.WorstResult.HasValue)
                        {
                            <div class="stat-row">
                                <span class="stat-row-label">Pior Resultado</span>
                                <span class="stat-row-value negative">@_stats.WorstResult.Value.ToString("C")</span>
                            </div>
                        }
                    </div>
                </div>

                @* Right Column *@
                <div class="desktop-right">
                    @* Performance with Progress Bars *@
                    <div class="section-title">üìä Performance</div>
                    <div class="performance-card">
                        <div class="performance-item">
                            <div class="performance-label">
                                <span>Posicao Media</span>
                                <span class="performance-value">@_stats.AveragePosition.ToString("N1")¬∫</span>
                            </div>
                        </div>
                        <div class="performance-item">
                            <div class="performance-label">
                                <span>Taxa de Vitoria</span>
                                <span class="performance-value">@_winRate.ToString("N1")%</span>
                            </div>
                            <MudProgressLinear Color="Color.Primary" Value="@((double)_winRate)" Max="100" Class="performance-bar" />
                        </div>
                        <div class="performance-item">
                            <div class="performance-label">
                                <span>ITM (In The Money)</span>
                                <span class="performance-value">@_itm.ToString("N1")%</span>
                            </div>
                            <MudProgressLinear Color="Color.Info" Value="@((double)_itm)" Max="100" Class="performance-bar" />
                        </div>
                    </div>

                    @* Second Performance Card with colored bars *@
                    <div class="performance-card mt-3">
                        <div class="performance-item">
                            <div class="performance-label">
                                <span>Taxa de Vitoria</span>
                                <span class="performance-value">@_winRate.ToString("N0")%</span>
                            </div>
                            <MudProgressLinear Color="Color.Primary" Value="@((double)_winRate)" Max="100" Class="performance-bar" />
                        </div>
                        <div class="performance-item">
                            <div class="performance-label">
                                <span>ITM</span>
                                <span class="performance-value">@_itm.ToString("N0")%</span>
                            </div>
                            <MudProgressLinear Color="Color.Info" Value="@((double)_itm)" Max="100" Class="performance-bar" />
                        </div>
                        <div class="performance-item">
                            <div class="performance-label">
                                <span>Top 3</span>
                                <span class="performance-value">@_topThreePercentage.ToString("N0")%</span>
                            </div>
                            <MudProgressLinear Color="Color.Warning" Value="@((double)_topThreePercentage)" Max="100" Class="performance-bar" />
                        </div>
                    </div>

                    @* Evolution Chart *@
                    @if (_stats.RecentResults.Any())
                    {
                        <div class="section-title mt-4">üìà Evolucao (Ultimos @Math.Min(6, _stats.RecentResults.Count))</div>
                        <div class="evolution-card">
                            <div class="evolution-chart">
                                @foreach (var result in _stats.RecentResults.Take(6).Reverse())
                                {
                                    var maxProfit = _stats.RecentResults.Take(6).Max(r => Math.Abs(r.Profit));
                                    var height = maxProfit > 0 ? (Math.Abs(result.Profit) / maxProfit) * 100 : 0;
                                    var isPositive = result.Profit >= 0;
                                    <div class="evolution-bar-container">
                                        <div class="evolution-bar @(isPositive ? "positive" : "negative")"
                                             style="height: @height.ToString("N0")%;">
                                        </div>
                                        <div class="evolution-label">@result.Date.ToString("MMM").Substring(0, 3)</div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            @* Historico Desktop - Full Width Table *@
            @if (_stats.RecentResults.Any())
            {
                <div class="section-title mt-4">üìÖ Historico de Torneios</div>
                <div class="history-table">
                    <MudTable Items="@_stats.RecentResults.Take(10)" Hover="true" Dense="true" Elevation="0" Class="stats-table">
                        <HeaderContent>
                            <MudTh>Torneio</MudTh>
                            <MudTh>Data</MudTh>
                            <MudTh Style="text-align: center;">Posicao</MudTh>
                            <MudTh Style="text-align: right;">Investimento</MudTh>
                            <MudTh Style="text-align: right;">Premio</MudTh>
                            <MudTh Style="text-align: right;">Resultado</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Torneio">
                                <MudLink Href="@($"/torneio/{context.TournamentId}")" Color="Color.Success">
                                    @context.TournamentName
                                </MudLink>
                            </MudTd>
                            <MudTd DataLabel="Data">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @context.Date.ToString("dd/MM/yyyy")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Posicao" Style="text-align: center;">
                                <MudChip T="string"
                                         Size="Size.Small"
                                         Color="@GetPositionColor(context.Position)"
                                         Variant="Variant.Filled">
                                    @(context.Position.HasValue ? $"{context.Position}¬∫" : "-") / @context.TotalPlayers
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Investimento" Style="text-align: right;">
                                <MudText Typo="Typo.body2" Class="mono-font">
                                    @context.Investment.ToString("C")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Premio" Style="text-align: right;">
                                <MudText Typo="Typo.body2" Class="mono-font">
                                    @context.Prize.ToString("C")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Resultado" Style="text-align: right;">
                                <MudText Typo="Typo.body2"
                                         Class="mono-font font-weight-bold"
                                         Color="@(context.Profit >= 0 ? Color.Success : Color.Error)">
                                    @(context.Profit >= 0 ? "+" : "")@context.Profit.ToString("C")
                                </MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </div>
            }
        }
    }
</MudContainer>

@code {
    [Parameter] public Guid PlayerId { get; set; }

    private PlayerStatsDto? _stats;
    private string? _leagueName;
    private int? _rankingPosition;
    private decimal _topThreePercentage;
    private decimal _roi;
    private decimal _itm;
    private decimal _winRate;
    private bool _loading = true;
    private bool _isMobile;

    public Guid Id { get; } = Guid.NewGuid();

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await BrowserViewportService.SubscribeAsync(this, fireImmediately: true);
        }
    }

    Task IBrowserViewportObserver.NotifyBrowserViewportChangeAsync(BrowserViewportEventArgs args)
    {
        _isMobile = args.Breakpoint <= Breakpoint.Sm;
        return InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        await BrowserViewportService.UnsubscribeAsync(this);
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadStats();
    }

    private async Task LoadStats()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _stats = await RankingService.GetPlayerStatsAsync(PlayerId);

            if (_stats != null)
            {
                // Calculate derived stats
                _roi = _stats.TotalBuyIns > 0
                    ? (_stats.Profit / _stats.TotalBuyIns) * 100
                    : 0;

                _winRate = _stats.TournamentsPlayed > 0
                    ? ((decimal)_stats.Wins / _stats.TournamentsPlayed) * 100
                    : 0;

                // Calculate ITM (In The Money) - aproximado como Top 3 quando temos dados legados
                // Para dados de torneios usamos quem recebeu premio, para legados usamos Top 3
                _itm = _stats.TournamentsPlayed > 0
                    ? ((decimal)_stats.Top3Finishes / _stats.TournamentsPlayed) * 100
                    : 0;

                // Top 3 percentage (SecondPlaces e ThirdPlaces agora vem do DTO)
                _topThreePercentage = _stats.TournamentsPlayed > 0
                    ? ((decimal)_stats.Top3Finishes / _stats.TournamentsPlayed) * 100
                    : 0;

                // Try to get player details for league info
                try
                {
                    var player = await PlayerService.GetPlayerByIdAsync(PlayerId);
                    if (player != null)
                    {
                        // Get league name
                        var league = await LeagueService.GetLeagueByIdAsync(player.LeagueId);
                        _leagueName = league?.Name;

                        // Get league ranking position
                        var ranking = await RankingService.GetLeagueRankingAsync(player.LeagueId);
                        var playerRank = ranking.FirstOrDefault(r => r.PlayerId == PlayerId);
                        if (playerRank != null)
                        {
                            _rankingPosition = ranking.ToList().IndexOf(playerRank) + 1;
                        }
                    }
                }
                catch (Exception) { /* Silently ignore - league info is optional */ }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading stats: {ex.Message}");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private string GetDisplayName()
    {
        if (_stats == null) return "";

        if (!string.IsNullOrEmpty(_stats.Nickname))
            return _stats.Nickname;

        return _stats.PlayerName;
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "?";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();

        return name.Length >= 2 ? name[..2].ToUpper() : name.ToUpper();
    }

    private string GetAvatarStyle()
    {
        if (_stats == null) return "";

        // Generate consistent color based on name hash
        var hash = Math.Abs(_stats.PlayerName.GetHashCode());
        var hue = hash % 360;

        return $"background: linear-gradient(135deg, hsl({hue}, 70%, 45%) 0%, hsl({hue}, 70%, 35%) 100%);";
    }

    private string GetRoiMessage()
    {
        return _roi switch
        {
            >= 100 => "üî• Excelente! Voce esta muito acima da media.",
            >= 50 => "üëç Muito bom! Acima da media.",
            >= 0 => "üìà Positivo! Continue assim.",
            >= -25 => "üìâ Negativo, mas recuperavel.",
            _ => "‚ö†Ô∏è Momento dificil. Paciencia!"
        };
    }

    private string GetRoiMessageShort()
    {
        return _roi switch
        {
            >= 50 => "üî• Acima da media",
            >= 0 => "üìà Positivo",
            _ => "üìâ Negativo"
        };
    }

    private string GetPositionClass(int? position) => position switch
    {
        1 => "gold",
        2 => "silver",
        3 => "bronze",
        _ => "default"
    };

    private Color GetPositionColor(int? position) => position switch
    {
        1 => Color.Warning,
        2 => Color.Default,
        3 => Color.Tertiary,
        _ => Color.Default
    };

    private void NavigateToTournament(Guid tournamentId)
    {
        Navigation.NavigateTo($"/torneio/{tournamentId}");
    }
}
