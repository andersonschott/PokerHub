@page "/torneios/{TournamentId:guid}"
@rendermode InteractiveServer
@attribute [Authorize]
@implements IAsyncDisposable
@implements IBrowserViewportObserver
@inject ITournamentService TournamentService
@inject IBrowserViewportService BrowserViewportService
@inject IPlayerService PlayerService
@inject ITournamentExpenseService ExpenseService
@inject ILeagueService LeagueService
@inject TournamentTimerService TimerService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@(_tournament?.Name ?? "Torneio") - PokerHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_tournament == null)
    {
        <MudAlert Severity="Severity.Error">Torneio nao encontrado</MudAlert>
    }
    else
    {
        <MudGrid>
            @* Header - apenas em desktop *@
            @if (!_isSmallScreen)
            {
                <MudItem xs="12">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                        <div>
                            <MudText Typo="Typo.h4">@_tournament.Name</MudText>
                            <MudChip T="string" Color="@GetStatusColor(_tournament.Status)" Size="Size.Small">
                                @GetStatusText(_tournament.Status)
                            </MudChip>
                        </div>
                        <div class="d-flex flex-wrap gap-2 justify-end">
                            @if (_canManage && _tournament.Status == TournamentStatus.Scheduled)
                            {
                                <MudButton Variant="Variant.Outlined"
                                          Color="Color.Default"
                                          StartIcon="@Icons.Material.Filled.Edit"
                                          Href="@($"/torneios/{TournamentId}/editar")">
                                    Editar
                                </MudButton>
                                <MudButton Variant="Variant.Outlined"
                                          Color="Color.Primary"
                                          StartIcon="@Icons.Material.Filled.Share"
                                          OnClick="ShowInviteDialog">
                                    Convidar
                                </MudButton>
                                <MudButton Variant="Variant.Filled"
                                          Color="Color.Success"
                                          StartIcon="@Icons.Material.Filled.PlayArrow"
                                          OnClick="StartTournament"
                                          Disabled="_processing">
                                    Iniciar Torneio
                                </MudButton>
                            }
                            else if (_tournament.Status == TournamentStatus.InProgress)
                            {
                                @if (_canManage)
                                {
                                    <MudButton Variant="Variant.Outlined"
                                              Color="Color.Warning"
                                              StartIcon="@Icons.Material.Filled.Pause"
                                              OnClick="PauseTournament"
                                              Disabled="_processing">
                                        Pausar
                                    </MudButton>
                                }
                                <MudButton Variant="Variant.Filled"
                                          Color="Color.Primary"
                                          StartIcon="@Icons.Material.Filled.Tv"
                                          Href="@($"/timer/{TournamentId}")"
                                          Target="_blank">
                                    Abrir Timer
                                </MudButton>
                            }
                            else if (_canManage && _tournament.Status == TournamentStatus.Paused)
                            {
                                <MudButton Variant="Variant.Filled"
                                          Color="Color.Success"
                                          StartIcon="@Icons.Material.Filled.PlayArrow"
                                          OnClick="ResumeTournament"
                                          Disabled="_processing">
                                    Retomar
                                </MudButton>
                            }
                            else if (_tournament.Status == TournamentStatus.Finished)
                            {
                                <MudButton Variant="Variant.Filled"
                                          Color="Color.Primary"
                                          StartIcon="@Icons.Material.Filled.Payments"
                                          Href="@($"/torneios/{TournamentId}/pagamentos")">
                                    Ver Pagamentos
                                </MudButton>
                            }
                            @* Self-Registration for League Members (Desktop) *@
                            @if (!_canManage && _isUserInLeague && _tournament.Status == TournamentStatus.Scheduled)
                            {
                                @if (_isUserRegistered)
                                {
                                    <MudChip T="string" Color="Color.Success" Size="Size.Medium">
                                        Inscrito
                                    </MudChip>
                                    <MudButton Variant="Variant.Outlined"
                                              Color="Color.Warning"
                                              Size="Size.Small"
                                              OnClick="CancelSelfRegistration"
                                              Disabled="_processing">
                                        Cancelar Inscricao
                                    </MudButton>
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Filled"
                                              Color="Color.Primary"
                                              Size="Size.Medium"
                                              StartIcon="@Icons.Material.Filled.HowToReg"
                                              OnClick="SelfRegister"
                                              Disabled="_processing">
                                        Inscrever-me
                                    </MudButton>
                                }
                            }
                        </div>
                    </MudStack>
                </MudItem>
            }

            @* Conteudo condicional: Mobile vs Desktop *@
            @if (_isSmallScreen)
            {
                <MudItem xs="12">
                    <TournamentMobileDashboard
                        Tournament="_tournament"
                        Detail="_detail"
                        TimerState="_timerState"
                        Expenses="_expenses"
                        CanManage="_canManage"
                        RebuyAllowed="_rebuyAllowed"
                        Processing="_processing"
                        IsUserInLeague="_isUserInLeague"
                        IsUserRegistered="_isUserRegistered"
                        OnEditClick="@(() => Navigation.NavigateTo($"/torneios/{TournamentId}/editar"))"
                        OnInviteClick="ShowInviteDialog"
                        OnStartClick="StartTournament"
                        OnPauseClick="PauseTournament"
                        OnResumeClick="ResumeTournament"
                        OnOpenTimerClick="@(() => Navigation.NavigateTo($"/timer/{TournamentId}", true))"
                        OnAddPlayerClick="OpenAddPlayerDialog"
                        OnCheckInClick="CheckIn"
                        OnCheckOutClick="CheckOut"
                        OnAddRebuyClick="AddRebuyWithConfirm"
                        OnRemoveRebuyClick="RemoveRebuyWithConfirm"
                        OnToggleAddonClick="ToggleAddon"
                        OnEliminateClick="EliminatePlayer"
                        OnAddExpenseClick="OpenAddExpenseDialog"
                        OnViewPaymentsClick="@(() => Navigation.NavigateTo($"/torneios/{TournamentId}/pagamentos"))"
                        OnCancelClick="CancelTournament"
                        OnFinishClick="FinishTournament"
                        OnSelfRegisterClick="SelfRegister"
                        OnCancelSelfRegistrationClick="CancelSelfRegistration" />
                </MudItem>
            }
            else
            {
            <!-- Info Cards -->
            <MudItem xs="6" sm="6" md="3">
                <MudCard Elevation="2">
                    <MudCardContent Class="pa-2 pa-sm-4">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.People" Color="Color.Primary" Size="Size.Medium" Class="d-sm-none"/>
                            <MudIcon Icon="@Icons.Material.Filled.People" Color="Color.Primary" Size="Size.Large" Class="d-none d-sm-flex"/>
                            <MudText Typo="Typo.h5" Class="d-sm-none">@GetPlayersRemaining()/@(_detail?.Players.Count ?? 0)</MudText>
                            <MudText Typo="Typo.h4" Class="d-none d-sm-block">@GetPlayersRemaining() / @(_detail?.Players.Count ?? 0)</MudText>
                            <MudText Typo="Typo.caption" Class="d-sm-none" Color="Color.Secondary">Jogadores</MudText>
                            <MudText Typo="Typo.body2" Class="d-none d-sm-block" Color="Color.Secondary">Jogadores</MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="6" sm="6" md="3">
                <MudCard Elevation="2">
                    <MudCardContent Class="pa-2 pa-sm-4">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Payments" Color="Color.Success" Size="Size.Medium" Class="d-sm-none"/>
                            <MudIcon Icon="@Icons.Material.Filled.Payments" Color="Color.Success" Size="Size.Large" Class="d-none d-sm-flex"/>
                            <MudText Typo="Typo.h6" Class="d-sm-none">R$ @(_detail?.PrizePool.ToString("N0") ?? "0")</MudText>
                            <MudText Typo="Typo.h4" Class="d-none d-sm-block">R$ @(_detail?.PrizePool.ToString("N2") ?? "0,00")</MudText>
                            <MudText Typo="Typo.caption" Class="d-sm-none" Color="Color.Secondary">Prize Pool</MudText>
                            <MudText Typo="Typo.body2" Class="d-none d-sm-block" Color="Color.Secondary">Prize Pool</MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="6" sm="6" md="3">
                <MudCard Elevation="2">
                    <MudCardContent Class="pa-2 pa-sm-4">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Refresh" Color="Color.Warning" Size="Size.Medium" Class="d-sm-none"/>
                            <MudIcon Icon="@Icons.Material.Filled.Refresh" Color="Color.Warning" Size="Size.Large" Class="d-none d-sm-flex"/>
                            <MudText Typo="Typo.h5" Class="d-sm-none">@GetTotalRebuys()</MudText>
                            <MudText Typo="Typo.h4" Class="d-none d-sm-block">@GetTotalRebuys()</MudText>
                            <MudText Typo="Typo.caption" Class="d-sm-none" Color="Color.Secondary">Rebuys</MudText>
                            <MudText Typo="Typo.body2" Class="d-none d-sm-block" Color="Color.Secondary">Rebuys</MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="6" sm="6" md="3">
                <MudCard Elevation="2">
                    <MudCardContent Class="pa-2 pa-sm-4">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.AddCircle" Color="Color.Info" Size="Size.Medium" Class="d-sm-none"/>
                            <MudIcon Icon="@Icons.Material.Filled.AddCircle" Color="Color.Info" Size="Size.Large" Class="d-none d-sm-flex"/>
                            <MudText Typo="Typo.h5" Class="d-sm-none">@GetTotalAddons()</MudText>
                            <MudText Typo="Typo.h4" Class="d-none d-sm-block">@GetTotalAddons()</MudText>
                            <MudText Typo="Typo.caption" Class="d-sm-none" Color="Color.Secondary">Add-ons</MudText>
                            <MudText Typo="Typo.body2" Class="d-none d-sm-block" Color="Color.Secondary">Add-ons</MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Timer Display (when in progress) -->
            @if (_tournament.Status == TournamentStatus.InProgress || _tournament.Status == TournamentStatus.Paused)
            {
                <MudItem xs="12" md="4">
                    <MudCard Elevation="3" Class="pa-4" Style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.h6" Style="color: #4CAF50;">NIVEL @_timerState?.CurrentLevel</MudText>
                            @if (_timerState?.CurrentBlindLevel != null)
                            {
                                @if (_timerState.CurrentBlindLevel.IsBreak)
                                {
                                    <MudText Typo="Typo.h4" Style="color: #FFD54F;">INTERVALO</MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.h3" Style="color: white;">
                                        @FormatChips(_timerState.CurrentBlindLevel.SmallBlind) / @FormatChips(_timerState.CurrentBlindLevel.BigBlind)
                                    </MudText>
                                    @if (_timerState.CurrentBlindLevel.Ante > 0)
                                    {
                                        <MudText Style="color: #FFD54F;">Ante: @FormatChips(_timerState.CurrentBlindLevel.Ante)</MudText>
                                    }
                                }
                            }
                            <MudText Typo="Typo.h2" Style="color: white; font-family: 'Courier New', monospace;">
                                @FormatTime(_timerState?.TimeRemainingSeconds ?? 0)
                            </MudText>
                            <MudStack Row="true" Spacing="2" Class="mt-2">
                                <MudButton Variant="Variant.Outlined"
                                          Color="Color.Primary"
                                          Size="Size.Small"
                                          OnClick="AdvanceLevel">
                                    Proximo Nivel
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudCard>
                </MudItem>
            }

            <!-- Players Table -->
            <MudItem xs="12" md="@(_tournament.Status == TournamentStatus.InProgress || _tournament.Status == TournamentStatus.Paused ? 8 : 12)">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Jogadores</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            @{
                                var canAddPlayer = _canManage && (
                                    _tournament.Status == TournamentStatus.Scheduled ||
                                    ((_tournament.Status == TournamentStatus.InProgress || _tournament.Status == TournamentStatus.Paused) &&
                                     (_isOrganizer || _detail?.IsCheckInAllowed == true)));
                            }
                            @if (canAddPlayer)
                            {
                                <MudButton Variant="Variant.Outlined"
                                          Color="Color.Primary"
                                          StartIcon="@Icons.Material.Filled.PersonAdd"
                                          OnClick="OpenAddPlayerDialog">
                                    Adicionar
                                </MudButton>
                            }
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (_isSmallScreen && (_tournament.Status == TournamentStatus.InProgress || _tournament.Status == TournamentStatus.Paused))
                        {
                            <!-- Mobile Compact View for In-Progress Tournament -->
                            <MudStack Spacing="2">
                                @foreach (var player in _detail?.Players?.OrderBy(p => p.Position.HasValue ? 0 : 1).ThenBy(p => p.Position).ThenBy(p => p.PlayerName) ?? Enumerable.Empty<TournamentPlayerDto>())
                                {
                                    <MudPaper Elevation="1" Class="pa-2" Style="@(IsPlayerEliminated(player) ? "opacity: 0.6;" : "")">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <!-- Player Info -->
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Style="flex: 1; min-width: 0;">
                                                <MudAvatar Color="@GetPlayerStatusColor(player)" Size="Size.Small">
                                                    @player.PlayerName[0]
                                                </MudAvatar>
                                                <div style="overflow: hidden;">
                                                    <MudText Typo="Typo.body2" Style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                        @(!string.IsNullOrEmpty(player.Nickname) ? player.Nickname : player.PlayerName)
                                                    </MudText>
                                                    @if (player.Position.HasValue)
                                                    {
                                                        <MudChip T="string" Color="@GetPositionColor(player.Position.Value)" Size="Size.Small" Class="pa-0 ma-0">
                                                            @player.Position.Value o
                                                        </MudChip>
                                                    }
                                                </div>
                                            </MudStack>

                                            <!-- Actions for playing players -->
                                            @if (IsPlayerPlaying(player))
                                            {
                                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                                    @if (_canManage && _rebuyAllowed)
                                                    {
                                                        <!-- Rebuy Controls -->
                                                        <MudButtonGroup Color="Color.Warning" Variant="Variant.Outlined" Size="Size.Small">
                                                            <MudIconButton Icon="@Icons.Material.Filled.Remove"
                                                                          Size="Size.Small"
                                                                          Disabled="@(player.RebuyCount <= 0 || _rebuyAddonInProgress)"
                                                                          OnClick="@(() => RemoveRebuy(player.PlayerId))" />
                                                            <MudButton Disabled="true" Style="min-width: 32px; padding: 0;">@player.RebuyCount</MudButton>
                                                            <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                                          Size="Size.Small"
                                                                          Disabled="_rebuyAddonInProgress"
                                                                          OnClick="@(() => AddRebuy(player.PlayerId))" />
                                                        </MudButtonGroup>
                                                    }
                                                    @if (_canManage && _detail?.AddonValue != null)
                                                    {
                                                        <!-- Addon Toggle -->
                                                        <MudToggleIconButton Toggled="@player.HasAddon"
                                                                            ToggledChanged="@((bool val) => SetAddon(player.PlayerId, val))"
                                                                            Icon="@Icons.Material.Outlined.AddCircleOutline"
                                                                            ToggledIcon="@Icons.Material.Filled.AddCircle"
                                                                            Color="Color.Default"
                                                                            ToggledColor="Color.Info"
                                                                            Size="Size.Small"
                                                                            Disabled="_rebuyAddonInProgress" />
                                                    }
                                                    @if (_canManage)
                                                    {
                                                        <!-- Eliminate -->
                                                        <MudIconButton Icon="@Icons.Material.Filled.PersonOff"
                                                                      Color="Color.Error"
                                                                      Size="Size.Small"
                                                                      OnClick="@(() => EliminatePlayer(player))" />
                                                    }
                                                </MudStack>
                                            }
                                        </MudStack>
                                    </MudPaper>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <!-- Desktop Table View -->
                            <div style="overflow-x: auto;">
                                <MudTable Items="@GetSortedPlayers()" Dense="true" Hover="true" Breakpoint="Breakpoint.None">
                                    <HeaderContent>
                                        <MudTh>Jogador</MudTh>
                                        <MudTh>Status</MudTh>
                                        <MudTh>Rebuys</MudTh>
                                        <MudTh>Add-on</MudTh>
                                        <MudTh>Posicao</MudTh>
                                        <MudTh Style="min-width: 150px;">Acoes</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudAvatar Color="Color.Primary" Size="Size.Small">
                                                    @context.PlayerName[0]
                                                </MudAvatar>
                                                <div>
                                                    <MudText>@context.PlayerName</MudText>
                                                    @if (!string.IsNullOrEmpty(context.Nickname))
                                                    {
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Nickname</MudText>
                                                    }
                                                </div>
                                            </MudStack>
                                        </MudTd>
                                        <MudTd>
                                            <MudChip T="string" Color="@GetPlayerStatusColor(context)" Size="Size.Small">
                                                @GetPlayerStatusText(context)
                                            </MudChip>
                                        </MudTd>
                                        <MudTd>
                                            @if (_canManage && _tournament.Status != TournamentStatus.Finished && IsPlayerPlaying(context) && _rebuyAllowed)
                                            {
                                                <MudStack Row="true" Spacing="1">
                                                    <MudIconButton Icon="@Icons.Material.Filled.Remove"
                                                                  Size="Size.Small"
                                                                  Color="Color.Error"
                                                                  Disabled="@(context.RebuyCount <= 0 || _rebuyAddonInProgress)"
                                                                  OnClick="@(() => RemoveRebuy(context.PlayerId))" />
                                                    <MudText>@context.RebuyCount</MudText>
                                                    <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                                  Size="Size.Small"
                                                                  Color="Color.Success"
                                                                  Disabled="_rebuyAddonInProgress"
                                                                  OnClick="@(() => AddRebuy(context.PlayerId))" />
                                                </MudStack>
                                            }
                                            else
                                            {
                                                @context.RebuyCount
                                            }
                                        </MudTd>
                                        <MudTd>
                                            @if (_canManage && _tournament.Status != TournamentStatus.Finished && IsPlayerPlaying(context) && _detail?.AddonValue != null)
                                            {
                                                <MudSwitch T="bool"
                                                          Value="@context.HasAddon"
                                                          ValueChanged="@((bool val) => SetAddon(context.PlayerId, val))"
                                                          Color="Color.Primary"
                                                          Disabled="_rebuyAddonInProgress" />
                                            }
                                            else
                                            {
                                                @(context.HasAddon ? "Sim" : "Nao")
                                            }
                                        </MudTd>
                                        <MudTd>
                                            @if (context.Position.HasValue)
                                            {
                                                <MudChip T="string" Color="@GetPositionColor(context.Position.Value)" Size="Size.Small">
                                                    @context.Position.Value o
                                                </MudChip>
                                            }
                                            else
                                            {
                                                <text>-</text>
                                            }
                                        </MudTd>
                                        <MudTd>
                                            @{
                                                var canCheckIn = _canManage && (
                                                    _tournament.Status == TournamentStatus.Scheduled ||
                                                    ((_tournament.Status == TournamentStatus.InProgress || _tournament.Status == TournamentStatus.Paused) &&
                                                     (_isOrganizer || _detail?.IsCheckInAllowed == true)));
                                            }
                                            @if (canCheckIn)
                                            {
                                                @if (!context.IsCheckedIn)
                                                {
                                                    <MudButton Variant="Variant.Text"
                                                              Color="Color.Success"
                                                              Size="Size.Small"
                                                              OnClick="@(() => CheckIn(context.PlayerId))">
                                                        Check-in
                                                    </MudButton>
                                                }
                                                else if (_tournament.Status == TournamentStatus.Scheduled)
                                                {
                                                    <MudButton Variant="Variant.Text"
                                                              Color="Color.Warning"
                                                              Size="Size.Small"
                                                              OnClick="@(() => CheckOut(context.PlayerId))">
                                                        Check-out
                                                    </MudButton>
                                                }
                                                @if (_tournament.Status == TournamentStatus.Scheduled)
                                                {
                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                                  Color="Color.Error"
                                                                  Size="Size.Small"
                                                                  OnClick="@(() => RemovePlayer(context.PlayerId))" />
                                                }
                                            }
                                            @if (_canManage && (_tournament.Status == TournamentStatus.InProgress || _tournament.Status == TournamentStatus.Paused) && IsPlayerPlaying(context))
                                            {
                                                <MudButton Variant="Variant.Text"
                                                          Color="Color.Error"
                                                          Size="Size.Small"
                                                          OnClick="@(() => EliminatePlayer(context))">
                                                    Eliminar
                                                </MudButton>
                                            }
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Expenses Section -->
            @if (_tournament.Status != TournamentStatus.Scheduled && _tournament.Status != TournamentStatus.Cancelled)
            {
                <MudItem xs="12">
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Despesas Extras</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                @if (_canManage)
                                {
                                    <MudButton Variant="Variant.Outlined"
                                              Color="Color.Primary"
                                              StartIcon="@Icons.Material.Filled.Add"
                                              OnClick="OpenAddExpenseDialog">
                                        Adicionar Despesa
                                    </MudButton>
                                }
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent Style="overflow-x: auto;">
                            @if (_expenses == null || !_expenses.Any())
                            {
                                <MudText Color="Color.Secondary">Nenhuma despesa registrada</MudText>
                            }
                            else
                            {
                                <MudTable Items="_expenses" Dense="true" Hover="true" Breakpoint="Breakpoint.None">
                                    <HeaderContent>
                                        <MudTh>Descricao</MudTh>
                                        <MudTh>Pago por</MudTh>
                                        <MudTh Style="text-align: right;">Valor</MudTh>
                                        <MudTh>Dividido entre</MudTh>
                                        <MudTh>Acoes</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>@context.Description</MudTd>
                                        <MudTd>@context.PaidByPlayerName</MudTd>
                                        <MudTd Style="text-align: right;">R$ @context.TotalAmount.ToString("N2")</MudTd>
                                        <MudTd>
                                            <MudTooltip Text="@string.Join(", ", context.Shares.Select(s => $"{s.PlayerName}: R$ {s.Amount:N2}"))">
                                                <MudChip T="string" Size="Size.Small" Color="Color.Info">@context.Shares.Count jogadores</MudChip>
                                            </MudTooltip>
                                        </MudTd>
                                        <MudTd>
                                            @if (_canManage)
                                            {
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                              Color="Color.Error"
                                                              Size="Size.Small"
                                                              OnClick="@(() => DeleteExpense(context.Id))" />
                                            }
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>

                                <MudDivider Class="my-3" />
                                <MudText Typo="Typo.subtitle2">
                                    Total de Despesas: R$ @_expenses.Sum(e => e.TotalAmount).ToString("N2")
                                </MudText>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }

            <!-- Actions -->
            @if (_canManage && (_tournament.Status == TournamentStatus.InProgress || _tournament.Status == TournamentStatus.Paused))
            {
                <MudItem xs="12">
                    <div class="d-flex flex-wrap gap-2 justify-end">
                        <MudButton Variant="Variant.Outlined"
                                  Color="Color.Error"
                                  OnClick="CancelTournament">
                            Cancelar Torneio
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Success"
                                  OnClick="FinishTournament"
                                  Disabled="@(GetPlayersRemaining() > 1)">
                            Finalizar Torneio
                        </MudButton>
                    </div>
                </MudItem>
            }
            } @* Fecha else do _isSmallScreen *@
        </MudGrid>
    }
</MudContainer>

<MudDialog @bind-Visible="_inviteDialogVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">Convidar Jogadores</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body1" Class="mb-4">
            Compartilhe este link para que jogadores possam se inscrever no torneio:
        </MudText>
        <MudTextField Value="@GetInviteUrl()"
                     Label="Link de Convite"
                     Variant="Variant.Outlined"
                     ReadOnly="true"
                     Adornment="Adornment.End"
                     AdornmentIcon="@Icons.Material.Filled.ContentCopy"
                     OnAdornmentClick="CopyInviteLink"/>
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
            Codigo: @_tournament?.InviteCode
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _inviteDialogVisible = false)">Fechar</MudButton>
        <MudButton Color="Color.Primary" OnClick="CopyInviteLink">Copiar Link</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public Guid TournamentId { get; set; }

    private HubConnection? _hubConnection;
    private TournamentDto? _tournament;
    private TournamentDetailDto? _detail;
    private TimerStateDto? _timerState;
    private IReadOnlyList<TournamentExpenseDto>? _expenses;
    private bool _loading = true;
    private bool _processing;
    private bool _rebuyAllowed;
    private bool _canManage;
    private bool _isOrganizer;
    private string? _currentUserId;
    private bool _rebuyAddonInProgress;
    private bool _refreshInProgress;
    private bool _inviteDialogVisible;

    // Self-registration state
    private bool _isUserInLeague;
    private bool _isUserRegistered;

    // Connection state
    private bool _isReconnecting;
    private bool _isDisconnected;

    // Mobile detection
    private bool _isSmallScreen;
    Guid IBrowserViewportObserver.Id { get; } = Guid.NewGuid();

    // Handler disposables (prevent memory leak)
    private IDisposable? _timerStateHandler;
    private IDisposable? _timerTickHandler;
    private IDisposable? _prizePoolHandler;
    private IDisposable? _eliminatedHandler;
    private IDisposable? _levelChangedHandler;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        await LoadTournament();
        await SetupSignalR();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await BrowserViewportService.SubscribeAsync(this, fireImmediately: true);
        }
    }

    Task IBrowserViewportObserver.NotifyBrowserViewportChangeAsync(BrowserViewportEventArgs browserViewportEventArgs)
    {
        _isSmallScreen = browserViewportEventArgs.Breakpoint <= Breakpoint.Sm;
        return InvokeAsync(StateHasChanged);
    }

    private async Task SetupSignalR()
    {
        try
        {
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/hubs/torneio"), options =>
                {
                    options.HttpMessageHandlerFactory = (handler) =>
                    {
                        if (handler is HttpClientHandler clientHandler)
                        {
                            clientHandler.ServerCertificateCustomValidationCallback =
                                HttpClientHandler.DangerousAcceptAnyServerCertificateValidator;
                        }
                        return handler;
                    };
                })
                .WithAutomaticReconnect(new[] {
                    TimeSpan.Zero,
                    TimeSpan.FromSeconds(2),
                    TimeSpan.FromSeconds(5),
                    TimeSpan.FromSeconds(10),
                    TimeSpan.FromSeconds(30),
                    TimeSpan.FromSeconds(60),
                    TimeSpan.FromSeconds(120),
                    TimeSpan.FromSeconds(300)  // 5 min max - keeps retrying
                })
                .Build();

            // Setup reconnection handlers
            _hubConnection.Reconnecting += async (error) =>
            {
                _isReconnecting = true;
                _isDisconnected = false;
                await InvokeAsync(StateHasChanged);
            };

            _hubConnection.Reconnected += async (connectionId) =>
            {
                _isReconnecting = false;
                _isDisconnected = false;
                // Re-join tournament group and sync state
                await _hubConnection.SendAsync("JoinTorneio", TournamentId);
                await RefreshPlayerData();
                await InvokeAsync(StateHasChanged);
            };

            _hubConnection.Closed += async (error) =>
            {
                _isDisconnected = true;
                _isReconnecting = false;
                await InvokeAsync(StateHasChanged);
            };

            RegisterHubHandlers();

            await _hubConnection.StartAsync();
            await _hubConnection.SendAsync("JoinTorneio", TournamentId);
        }
        catch (Exception ex)
        {
            // SignalR connection failed - continue without real-time updates
            Console.WriteLine($"SignalR connection failed: {ex.Message}");
        }
    }

    private async Task LoadTournament()
    {
        _loading = true;
        _tournament = await TournamentService.GetTournamentByIdAsync(TournamentId);
        _detail = await TournamentService.GetTournamentDetailAsync(TournamentId);
        _timerState = await TournamentService.GetTimerStateAsync(TournamentId);
        _rebuyAllowed = await TournamentService.IsRebuyAllowedAsync(TournamentId);
        _expenses = await ExpenseService.GetExpensesByTournamentAsync(TournamentId);

        // Check if user can manage this tournament (organizer or checked-in player)
        if (!string.IsNullOrEmpty(_currentUserId) && _tournament != null)
        {
            _canManage = await TournamentService.CanUserManageTournamentAsync(TournamentId, _currentUserId);
            _isOrganizer = await LeagueService.IsUserOrganizerAsync(_tournament.LeagueId, _currentUserId);

            // Check self-registration state for league members
            _isUserInLeague = await LeagueService.CanUserAccessLeagueAsync(_tournament.LeagueId, _currentUserId);
            _isUserRegistered = await TournamentService.IsUserRegisteredInTournamentAsync(TournamentId, _currentUserId);
        }

        _loading = false;
    }

    /// <summary>
    /// Atualiza apenas os dados dos jogadores sem afetar o timer ou mostrar loading
    /// </summary>
    private async Task RefreshPlayerData()
    {
        // Prevent concurrent database operations
        if (_refreshInProgress) return;
        _refreshInProgress = true;
        try
        {
            _detail = await TournamentService.GetTournamentDetailAsync(TournamentId);
            _rebuyAllowed = await TournamentService.IsRebuyAllowedAsync(TournamentId);
        }
        finally
        {
            _refreshInProgress = false;
        }
    }

    private void RegisterHubHandlers()
    {
        if (_hubConnection == null) return;

        _timerStateHandler = _hubConnection.On<TimerStateDto>("TimerStateUpdated", async (state) =>
        {
            try
            {
                _timerState = state;
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"TimerStateUpdated handler error: {ex.Message}");
            }
        });

        _timerTickHandler = _hubConnection.On<object>("TimerTick", async (data) =>
        {
            try
            {
                var json = System.Text.Json.JsonSerializer.Serialize(data);
                var tick = System.Text.Json.JsonSerializer.Deserialize<TimerTickData>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (tick != null && _timerState != null)
                {
                    _timerState = _timerState with { TimeRemainingSeconds = tick.SecondsRemaining };
                    await InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"TimerTick handler error: {ex.Message}");
            }
        });

        _prizePoolHandler = _hubConnection.On<object>("PrizePoolAtualizado", async (data) =>
        {
            try
            {
                await RefreshPlayerData();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"PrizePoolAtualizado handler error: {ex.Message}");
            }
        });

        _eliminatedHandler = _hubConnection.On<object>("JogadorEliminado", async (data) =>
        {
            try
            {
                await RefreshPlayerData();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"JogadorEliminado handler error: {ex.Message}");
            }
        });

        _levelChangedHandler = _hubConnection.On<object>("NivelAlterado", async (data) =>
        {
            try
            {
                var json = System.Text.Json.JsonSerializer.Serialize(data);
                var levelData = System.Text.Json.JsonSerializer.Deserialize<LevelChangedData>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (levelData?.NewLevel != null && _timerState != null)
                {
                    _timerState = _timerState with
                    {
                        CurrentLevel = levelData.NewLevel.Order,
                        TimeRemainingSeconds = levelData.NewLevel.DurationMinutes * 60,
                        CurrentBlindLevel = levelData.NewLevel,
                        NextBlindLevel = levelData.NextLevel
                    };
                    await InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"NivelAlterado handler error: {ex.Message}");
            }
        });
    }

    // Helper methods to derive data from DTOs
    private int GetPlayersRemaining()
    {
        if (_detail?.Players == null) return 0;
        return _detail.Players.Count(p => IsPlayerPlaying(p));
    }

    private int GetTotalRebuys()
    {
        if (_detail?.Players == null) return 0;
        return _detail.Players.Sum(p => p.RebuyCount);
    }

    private int GetTotalAddons()
    {
        if (_detail?.Players == null) return 0;
        return _detail.Players.Count(p => p.HasAddon);
    }

    private bool IsPlayerPlaying(TournamentPlayerDto player)
    {
        return player.IsCheckedIn && !player.Position.HasValue && player.EliminatedAt == null;
    }

    private bool IsPlayerEliminated(TournamentPlayerDto player)
    {
        return player.Position.HasValue || player.EliminatedAt != null;
    }

    private IEnumerable<TournamentPlayerDto> GetSortedPlayers()
    {
        if (_detail?.Players == null) return Enumerable.Empty<TournamentPlayerDto>();

        // Quando o torneio estiver finalizado, ordenar por posição
        if (_tournament?.Status == TournamentStatus.Finished)
        {
            return _detail.Players
                .OrderBy(p => p.Position ?? int.MaxValue)
                .ThenBy(p => p.PlayerName);
        }

        // Para outros status, ordenar por status de jogo
        return _detail.Players
            .OrderBy(p => p.Position.HasValue ? 0 : 1)
            .ThenBy(p => p.Position)
            .ThenBy(p => p.PlayerName);
    }

    private async Task StartTournament()
    {
        _processing = true;
        try
        {
            await TournamentService.StartTournamentAsync(TournamentId);
            Snackbar.Add("Torneio iniciado!", Severity.Success);
            await LoadTournament();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task PauseTournament()
    {
        _processing = true;
        try
        {
            await TournamentService.PauseTournamentAsync(TournamentId);
            TimerService.PauseTournament(TournamentId);
            Snackbar.Add("Torneio pausado", Severity.Info);
            await LoadTournament();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task ResumeTournament()
    {
        _processing = true;
        try
        {
            await TournamentService.ResumeTournamentAsync(TournamentId);
            TimerService.ResumeTournament(TournamentId);
            Snackbar.Add("Torneio retomado", Severity.Success);
            await LoadTournament();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task AdvanceLevel()
    {
        try
        {
            var success = await TournamentService.AdvanceToNextLevelAsync(TournamentId);
            if (success)
            {
                // Sync timer service state and broadcast to all clients
                await TimerService.ManualAdvanceLevel(TournamentId);
                await LoadTournament();
                Snackbar.Add("Nivel avancado", Severity.Success);
            }
            else
            {
                Snackbar.Add("Nao ha mais niveis para avancar", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenAddPlayerDialog()
    {
        var leaguePlayers = await PlayerService.GetPlayersByLeagueAsync(_tournament!.LeagueId);
        var existingPlayerIds = _detail!.Players.Select(p => p.PlayerId).ToHashSet();
        var availablePlayers = leaguePlayers.Where(p => !existingPlayerIds.Contains(p.Id)).ToList();

        if (!availablePlayers.Any())
        {
            Snackbar.Add("Todos os jogadores da liga ja estao no torneio", Severity.Info);
            return;
        }

        var parameters = new DialogParameters<AddTournamentPlayerDialog>
        {
            { x => x.AvailablePlayers, availablePlayers },
            { x => x.TournamentId, TournamentId }
        };

        var dialog = await DialogService.ShowAsync<AddTournamentPlayerDialog>("Adicionar Jogador", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadTournament();
        }
    }

    private async Task CheckIn(Guid playerId)
    {
        try
        {
            await TournamentService.CheckInPlayerAsync(TournamentId, playerId);
            await LoadTournament();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
    }

    private async Task CheckOut(Guid playerId)
    {
        try
        {
            await TournamentService.CheckOutPlayerAsync(TournamentId, playerId);
            await LoadTournament();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
    }

    private async Task RemovePlayer(Guid playerId)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Remover Jogador",
            "Tem certeza que deseja remover este jogador do torneio?",
            "Sim", "Nao");

        if (confirm == true)
        {
            try
            {
                await TournamentService.RemovePlayerFromTournamentAsync(TournamentId, playerId);
                await LoadTournament();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task AddRebuy(Guid playerId)
    {
        if (_rebuyAddonInProgress) return;
        _rebuyAddonInProgress = true;
        try
        {
            await TournamentService.AddRebuyAsync(TournamentId, playerId);
            await TimerService.NotifyPrizePoolUpdate(TournamentId, _detail!.PrizePool + (_detail.RebuyValue ?? 0), GetTotalRebuys() + 1, GetTotalAddons());
            await TimerService.NotifyPlayerUpdated(TournamentId);
            // RefreshPlayerData is called by SignalR handler when broadcast is received
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _rebuyAddonInProgress = false;
        }
    }

    private async Task RemoveRebuy(Guid playerId)
    {
        if (_rebuyAddonInProgress) return;
        _rebuyAddonInProgress = true;
        try
        {
            await TournamentService.RemoveRebuyAsync(TournamentId, playerId);
            await TimerService.NotifyPrizePoolUpdate(TournamentId, _detail!.PrizePool - (_detail.RebuyValue ?? 0), GetTotalRebuys() - 1, GetTotalAddons());
            await TimerService.NotifyPlayerUpdated(TournamentId);
            // RefreshPlayerData is called by SignalR handler when broadcast is received
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _rebuyAddonInProgress = false;
        }
    }

    private async Task SetAddon(Guid playerId, bool hasAddon)
    {
        if (_rebuyAddonInProgress) return;
        _rebuyAddonInProgress = true;
        try
        {
            await TournamentService.SetAddonAsync(TournamentId, playerId, hasAddon);
            var change = hasAddon ? 1 : -1;
            var prizeChange = hasAddon ? (_detail!.AddonValue ?? 0) : -(_detail!.AddonValue ?? 0);
            await TimerService.NotifyPrizePoolUpdate(TournamentId, _detail!.PrizePool + prizeChange, GetTotalRebuys(), GetTotalAddons() + change);
            await TimerService.NotifyPlayerUpdated(TournamentId);
            // RefreshPlayerData is called by SignalR handler when broadcast is received
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _rebuyAddonInProgress = false;
        }
    }

    // Metodos com confirmacao para uso no mobile
    private async Task AddRebuyWithConfirm(Guid playerId)
    {
        var player = _detail?.Players?.FirstOrDefault(p => p.PlayerId == playerId);
        if (player == null) return;

        var confirm = await DialogService.ShowMessageBox(
            "Confirmar Rebuy",
            $"Adicionar rebuy para {player.PlayerName}? (Total: {player.RebuyCount + 1})",
            "Confirmar", "Cancelar");

        if (confirm == true)
        {
            await AddRebuy(playerId);
        }
    }

    private async Task RemoveRebuyWithConfirm(Guid playerId)
    {
        var player = _detail?.Players?.FirstOrDefault(p => p.PlayerId == playerId);
        if (player == null || player.RebuyCount <= 0) return;

        var confirm = await DialogService.ShowMessageBox(
            "Confirmar Remocao",
            $"Remover rebuy de {player.PlayerName}? (Total: {player.RebuyCount - 1})",
            "Confirmar", "Cancelar");

        if (confirm == true)
        {
            await RemoveRebuy(playerId);
        }
    }

    private async Task ToggleAddon(Guid playerId)
    {
        var player = _detail?.Players?.FirstOrDefault(p => p.PlayerId == playerId);
        if (player == null) return;

        var action = player.HasAddon ? "remover" : "adicionar";
        var confirm = await DialogService.ShowMessageBox(
            "Confirmar Add-on",
            $"Deseja {action} add-on para {player.PlayerName}?",
            "Confirmar", "Cancelar");

        if (confirm == true)
        {
            await SetAddon(playerId, !player.HasAddon);
        }
    }

    private async Task EliminatePlayer(TournamentPlayerDto player)
    {
        var playersRemaining = GetPlayersRemaining();
        var position = playersRemaining;

        var confirm = await DialogService.ShowMessageBox(
            "Eliminar Jogador",
            $"Eliminar {player.PlayerName} na posicao {position}o lugar?",
            "Confirmar", "Cancelar");

        if (confirm == true)
        {
            try
            {
                await TournamentService.EliminatePlayerAsync(TournamentId, player.PlayerId, null, position);
                await TimerService.NotifyPlayerEliminated(TournamentId, player.PlayerId, player.PlayerName, position);
                await TimerService.NotifyPlayerUpdated(TournamentId);
                await LoadTournament();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task FinishTournament()
    {
        // Pegar todas as posicoes dos eliminados
        var positions = _detail!.Players
            .Where(p => p.Position.HasValue)
            .Select(p => (p.PlayerId, p.Position!.Value))
            .ToList();

        // Adicionar o vencedor (ultimo jogador restante) na posicao 1
        var winner = _detail.Players.FirstOrDefault(p => IsPlayerPlaying(p));
        if (winner != null)
        {
            positions.Add((winner.PlayerId, 1));
        }

        try
        {
            await TournamentService.FinishTournamentAsync(TournamentId, positions);
            await TimerService.NotifyTournamentFinished(TournamentId);
            Snackbar.Add("Torneio finalizado!", Severity.Success);
            Navigation.NavigateTo($"/torneios/{TournamentId}/pagamentos");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
    }

    private async Task CancelTournament()
    {
        var confirm = await DialogService.ShowMessageBox(
            "Cancelar Torneio",
            "Tem certeza que deseja cancelar o torneio? Esta acao nao pode ser desfeita.",
            "Sim, Cancelar", "Nao");

        if (confirm == true)
        {
            try
            {
                await TournamentService.CancelTournamentAsync(TournamentId);
                Snackbar.Add("Torneio cancelado", Severity.Warning);
                await LoadTournament();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenAddExpenseDialog()
    {
        var leaguePlayers = await ExpenseService.GetLeaguePlayersAsync(TournamentId);
        var checkedInPlayers = await ExpenseService.GetEligiblePlayersForShareAsync(TournamentId);

        if (!checkedInPlayers.Any())
        {
            Snackbar.Add("Nenhum jogador com check-in para dividir a despesa", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters<AddExpenseDialog>
        {
            { x => x.TournamentId, TournamentId },
            { x => x.LeaguePlayers, leaguePlayers },
            { x => x.CheckedInPlayers, checkedInPlayers }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<AddExpenseDialog>("Adicionar Despesa", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            _expenses = await ExpenseService.GetExpensesByTournamentAsync(TournamentId);
        }
    }

    private async Task DeleteExpense(Guid expenseId)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Remover Despesa",
            "Tem certeza que deseja remover esta despesa?",
            "Sim", "Nao");

        if (confirm == true)
        {
            try
            {
                await ExpenseService.DeleteExpenseAsync(expenseId);
                _expenses = await ExpenseService.GetExpensesByTournamentAsync(TournamentId);
                Snackbar.Add("Despesa removida", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
            }
        }
    }

    private string FormatTime(int totalSeconds)
    {
        if (totalSeconds < 0) totalSeconds = 0;
        var minutes = totalSeconds / 60;
        var seconds = totalSeconds % 60;
        return $"{minutes:D2}:{seconds:D2}";
    }

    private string FormatChips(int value)
    {
        if (value >= 1000000) return $"{value / 1000000.0:0.#}M";
        if (value >= 1000) return $"{value / 1000.0:0.#}K";
        return value.ToString();
    }

    private Color GetStatusColor(TournamentStatus status) => status switch
    {
        TournamentStatus.Scheduled => Color.Info,
        TournamentStatus.InProgress => Color.Success,
        TournamentStatus.Paused => Color.Warning,
        TournamentStatus.Finished => Color.Default,
        TournamentStatus.Cancelled => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(TournamentStatus status) => status switch
    {
        TournamentStatus.Scheduled => "Agendado",
        TournamentStatus.InProgress => "Em Andamento",
        TournamentStatus.Paused => "Pausado",
        TournamentStatus.Finished => "Finalizado",
        TournamentStatus.Cancelled => "Cancelado",
        _ => status.ToString()
    };

    private Color GetPlayerStatusColor(TournamentPlayerDto player)
    {
        if (IsPlayerEliminated(player)) return Color.Error;
        if (IsPlayerPlaying(player)) return Color.Success;
        if (player.IsCheckedIn) return Color.Primary;
        return Color.Info;
    }

    private string GetPlayerStatusText(TournamentPlayerDto player)
    {
        if (IsPlayerEliminated(player)) return "Eliminado";
        if (IsPlayerPlaying(player)) return "Jogando";
        if (player.IsCheckedIn) return "Check-in";
        return "Inscrito";
    }

    private Color GetPositionColor(int position) => position switch
    {
        1 => Color.Warning,
        2 => Color.Default,
        3 => Color.Tertiary,
        _ => Color.Default
    };

    private void ShowInviteDialog()
    {
        _inviteDialogVisible = true;
    }

    private string GetInviteUrl()
    {
        if (_tournament == null) return string.Empty;
        var baseUrl = Navigation.BaseUri.TrimEnd('/');
        return $"{baseUrl}/torneios/entrar/{_tournament.InviteCode}";
    }

    private async Task CopyInviteLink()
    {
        var url = GetInviteUrl();
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", url);
        Snackbar.Add("Link copiado!", Severity.Success);
    }

    private async Task SelfRegister()
    {
        if (string.IsNullOrEmpty(_currentUserId) || _tournament == null) return;

        _processing = true;
        try
        {
            var (success, message) = await TournamentService.SelfRegisterPlayerAsync(TournamentId, _currentUserId);
            if (success)
            {
                Snackbar.Add(message, Severity.Success);
                await LoadTournament();
            }
            else
            {
                Snackbar.Add(message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task CancelSelfRegistration()
    {
        if (string.IsNullOrEmpty(_currentUserId) || _tournament == null) return;

        var confirm = await DialogService.ShowMessageBox(
            "Cancelar Inscricao",
            "Tem certeza que deseja cancelar sua inscricao?",
            "Sim", "Nao");

        if (confirm != true) return;

        _processing = true;
        try
        {
            var success = await TournamentService.SelfUnregisterPlayerAsync(TournamentId, _currentUserId);
            if (success)
            {
                Snackbar.Add("Inscricao cancelada.", Severity.Info);
                await LoadTournament();
            }
            else
            {
                Snackbar.Add("Nao foi possivel cancelar. Voce ja fez check-in?", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    public async ValueTask DisposeAsync()
    {
        // Dispose all handler subscriptions to prevent memory leaks
        _timerStateHandler?.Dispose();
        _timerTickHandler?.Dispose();
        _prizePoolHandler?.Dispose();
        _eliminatedHandler?.Dispose();
        _levelChangedHandler?.Dispose();

        await BrowserViewportService.UnsubscribeAsync(this);

        if (_hubConnection != null)
        {
            try
            {
                await _hubConnection.SendAsync("LeaveTorneio", TournamentId);
            }
            catch
            {
                // Ignore errors when leaving - connection might already be closed
            }
            await _hubConnection.DisposeAsync();
        }
    }

    private class TimerTickData
    {
        public int SecondsRemaining { get; set; }
    }

    private class LevelChangedData
    {
        public BlindLevelDto? NewLevel { get; set; }
        public BlindLevelDto? NextLevel { get; set; }
    }
}
