@page "/torneios/entrar/{InviteCode}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using PokerHub.Domain.Entities
@using PokerHub.Domain.Enums
@inject ITournamentService TournamentService
@inject ILeagueService LeagueService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<User> UserManager

<PageTitle>@GetPageTitle()</PageTitle>

<HeadContent>
    <!-- Open Graph meta tags for WhatsApp preview -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="@GetPageUrl()" />
    <meta property="og:title" content="@GetOgTitle()" />
    <meta property="og:description" content="@GetOgDescription()" />
    <meta property="og:site_name" content="PokerHub" />
    <meta property="og:locale" content="pt_BR" />
    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="@GetOgTitle()" />
    <meta name="twitter:description" content="@GetOgDescription()" />
</HeadContent>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-6">
    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_tournament == null)
    {
        <MudAlert Severity="Severity.Error">
            Torneio nao encontrado. Verifique se o codigo de convite esta correto.
        </MudAlert>
        <MudButton Href="/" Variant="Variant.Text" Color="Color.Primary" Class="mt-4">
            Voltar ao Inicio
        </MudButton>
    }
    else
    {
        <MudPaper Elevation="4" Class="pa-6">
            <MudStack AlignItems="AlignItems.Center" Spacing="4">
                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Size="Size.Large" Color="Color.Warning"/>
                <MudText Typo="Typo.h4">@_tournament.Name</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary">@_tournament.LeagueName</MudText>
            </MudStack>

            <MudDivider Class="my-4"/>

            <MudStack Spacing="2">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" Color="Color.Secondary"/>
                    <MudText>@_tournament.ScheduledDateTime.ToString("dddd, dd/MM/yyyy 'as' HH:mm")</MudText>
                </MudStack>

                @if (!string.IsNullOrEmpty(_tournament.Location))
                {
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Color="Color.Secondary"/>
                        <MudText>@_tournament.Location</MudText>
                    </MudStack>
                }

                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Payments" Size="Size.Small" Color="Color.Secondary"/>
                    <MudText>Buy-in: R$ @_tournament.BuyIn.ToString("N2")</MudText>
                </MudStack>

                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Color="Color.Secondary"/>
                    <MudText>@_tournament.PlayerCount jogadores inscritos</MudText>
                </MudStack>

                <MudChip T="string" Color="@GetStatusColor(_tournament.Status)" Size="Size.Medium" Class="mt-2">
                    @GetStatusText(_tournament.Status)
                </MudChip>
            </MudStack>

            <MudDivider Class="my-4"/>

            <AuthorizeView>
                <Authorized>
                    @if (!_tournament.IsCheckInAllowed)
                    {
                        <MudAlert Severity="Severity.Warning">
                            Este torneio nao esta mais aceitando inscricoes.
                            @if (_tournament.AllowCheckInUntilLevel.HasValue && _tournament.Status is TournamentStatus.InProgress or TournamentStatus.Paused)
                            {
                                <br/>
                                <MudText Typo="Typo.caption">O periodo de inscricao tardio encerrou (nivel @(_tournament.CurrentLevel) de @(_tournament.AllowCheckInUntilLevel)).</MudText>
                            }
                        </MudAlert>
                    }
                    else if (!_isUserInLeague)
                    {
                        <MudAlert Severity="Severity.Info" Class="mb-4">
                            Voce precisa ser membro da liga "@_tournament.LeagueName" para se inscrever neste torneio.
                        </MudAlert>

                        <MudText Typo="Typo.body2" Class="mb-2">Complete seu cadastro como jogador:</MudText>
                        <MudTextField @bind-Value="_playerName"
                                     Label="Nome *"
                                     Variant="Variant.Outlined"
                                     Required="true"
                                     RequiredError="Nome e obrigatorio"
                                     Class="mb-2"/>
                        <MudTextField @bind-Value="_playerNickname"
                                     Label="Apelido"
                                     Variant="Variant.Outlined"
                                     HelperText="Como voce e conhecido nas mesas"
                                     Class="mb-2"/>
                        <MudTextField @bind-Value="_playerPhone"
                                     Label="Telefone"
                                     Variant="Variant.Outlined"
                                     InputType="InputType.Telephone"
                                     Class="mb-2"/>
                        <MudSelect T="PixKeyType?" @bind-Value="_playerPixKeyType"
                                  Label="Tipo de Chave PIX"
                                  Variant="Variant.Outlined"
                                  Class="mb-2">
                            <MudSelectItem T="PixKeyType?" Value="@((PixKeyType?)null)">Nenhum</MudSelectItem>
                            <MudSelectItem T="PixKeyType?" Value="@((PixKeyType?)PixKeyType.CPF)">CPF</MudSelectItem>
                            <MudSelectItem T="PixKeyType?" Value="@((PixKeyType?)PixKeyType.Email)">E-mail</MudSelectItem>
                            <MudSelectItem T="PixKeyType?" Value="@((PixKeyType?)PixKeyType.Phone)">Telefone</MudSelectItem>
                            <MudSelectItem T="PixKeyType?" Value="@((PixKeyType?)PixKeyType.Random)">Chave Aleatoria</MudSelectItem>
                        </MudSelect>
                        @if (_playerPixKeyType.HasValue)
                        {
                            <MudTextField @bind-Value="_playerPixKey"
                                         Label="Chave PIX"
                                         Variant="Variant.Outlined"
                                         HelperText="Para receber premiacoes"
                                         Class="mb-4"/>
                        }

                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  FullWidth="true"
                                  Size="Size.Large"
                                  Disabled="@(_processing || string.IsNullOrWhiteSpace(_playerName))"
                                  OnClick="JoinLeagueAndRegister"
                                  Class="mt-2">
                            @if (_processing)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                            }
                            Entrar na Liga e Inscrever-se
                        </MudButton>
                    }
                    else if (_isRegistered)
                    {
                        <MudAlert Severity="Severity.Success" Class="mb-4">
                            Voce ja esta inscrito neste torneio!
                        </MudAlert>
                        <MudButton Variant="Variant.Outlined"
                                  Color="Color.Error"
                                  FullWidth="true"
                                  Disabled="_processing"
                                  OnClick="Unregister">
                            @if (_processing)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                            }
                            Cancelar Inscricao
                        </MudButton>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  FullWidth="true"
                                  Size="Size.Large"
                                  Disabled="_processing"
                                  OnClick="Register">
                            @if (_processing)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                            }
                            Inscrever-se
                        </MudButton>
                    }

                    <MudButton Href="@($"/torneios/{_tournament.Id}")"
                              Variant="Variant.Text"
                              Color="Color.Default"
                              FullWidth="true"
                              Class="mt-2">
                        Ver Detalhes do Torneio
                    </MudButton>
                </Authorized>
                <NotAuthorized>
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        Faca login para se inscrever neste torneio.
                    </MudAlert>
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Primary"
                              FullWidth="true"
                              Size="Size.Large"
                              Href="@GetLoginUrl()">
                        Entrar
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                              Color="Color.Primary"
                              FullWidth="true"
                              Class="mt-2"
                              Href="@GetRegisterUrl()">
                        Criar Conta
                    </MudButton>
                </NotAuthorized>
            </AuthorizeView>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public string InviteCode { get; set; } = string.Empty;

    private TournamentDto? _tournament;
    private User? _currentUser;
    private bool _loading = true;
    private bool _processing;
    private bool _isRegistered;
    private bool _isUserInLeague;
    private string? _currentUserId;
    private string _playerName = string.Empty;
    private string _playerNickname = string.Empty;
    private string _playerPhone = string.Empty;
    private string _playerPixKey = string.Empty;
    private PixKeyType? _playerPixKeyType;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            _tournament = await TournamentService.GetTournamentByInviteCodeAsync(InviteCode);

            if (_tournament != null)
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

                if (!string.IsNullOrEmpty(_currentUserId))
                {
                    _currentUser = await UserManager.FindByIdAsync(_currentUserId);
                    _isUserInLeague = await LeagueService.CanUserAccessLeagueAsync(_tournament.LeagueId, _currentUserId);
                    _isRegistered = await TournamentService.IsUserRegisteredInTournamentAsync(_tournament.Id, _currentUserId);

                    // Pre-fill form with user data if available
                    if (_currentUser != null)
                    {
                        if (!string.IsNullOrWhiteSpace(_currentUser.Name))
                            _playerName = _currentUser.Name;
                        // Phone from user's phone number if available
                        if (!string.IsNullOrWhiteSpace(_currentUser.PhoneNumber))
                            _playerPhone = _currentUser.PhoneNumber;
                    }
                }
            }
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task Register()
    {
        if (string.IsNullOrEmpty(_currentUserId) || _tournament == null) return;

        _processing = true;
        try
        {
            var (success, message) = await TournamentService.SelfRegisterPlayerAsync(_tournament.Id, _currentUserId);
            if (success)
            {
                Snackbar.Add(message, Severity.Success);
                await LoadData();
            }
            else
            {
                Snackbar.Add(message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task Unregister()
    {
        if (string.IsNullOrEmpty(_currentUserId) || _tournament == null) return;

        _processing = true;
        try
        {
            var success = await TournamentService.SelfUnregisterPlayerAsync(_tournament.Id, _currentUserId);
            if (success)
            {
                Snackbar.Add("Inscricao cancelada.", Severity.Info);
                await LoadData();
            }
            else
            {
                Snackbar.Add("Nao foi possivel cancelar a inscricao. Voce ja fez check-in?", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task JoinLeagueAndRegister()
    {
        if (string.IsNullOrEmpty(_currentUserId) || _tournament == null) return;

        // Validate name
        if (string.IsNullOrWhiteSpace(_playerName))
        {
            Snackbar.Add("Por favor, informe seu nome.", Severity.Warning);
            return;
        }

        _processing = true;
        try
        {
            var playerName = _playerName.Trim();
            var userEmail = _currentUser?.Email;
            var nickname = string.IsNullOrWhiteSpace(_playerNickname) ? null : _playerNickname.Trim();
            var phone = string.IsNullOrWhiteSpace(_playerPhone) ? null : _playerPhone.Trim();
            var pixKey = string.IsNullOrWhiteSpace(_playerPixKey) ? null : _playerPixKey.Trim();

            // Update the User record if name was empty
            if (_currentUser != null && string.IsNullOrWhiteSpace(_currentUser.Name))
            {
                _currentUser.Name = playerName;
                await UserManager.UpdateAsync(_currentUser);
            }

            // Join the league first
            var (joinSuccess, joinMessage) = await LeagueService.JoinLeagueAsync(
                _tournament.LeagueId,
                _currentUserId,
                playerName,
                userEmail,
                nickname,
                phone,
                pixKey,
                _playerPixKeyType);

            if (!joinSuccess)
            {
                Snackbar.Add(joinMessage, Severity.Warning);
                await LoadData();
                return;
            }

            Snackbar.Add(joinMessage, Severity.Success);

            // Now register for the tournament
            var (registerSuccess, registerMessage) = await TournamentService.SelfRegisterPlayerAsync(_tournament.Id, _currentUserId);
            if (registerSuccess)
            {
                Snackbar.Add(registerMessage, Severity.Success);
            }
            else
            {
                Snackbar.Add($"Voce entrou na liga, mas: {registerMessage}", Severity.Warning);
            }

            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private string GetLoginUrl()
    {
        var returnUrl = Uri.EscapeDataString($"/torneios/entrar/{InviteCode}");
        return $"/Account/Login?ReturnUrl={returnUrl}";
    }

    private string GetRegisterUrl()
    {
        var returnUrl = Uri.EscapeDataString($"/torneios/entrar/{InviteCode}");
        return $"/Account/Register?ReturnUrl={returnUrl}";
    }

    private Color GetStatusColor(TournamentStatus status) => status switch
    {
        TournamentStatus.Scheduled => Color.Info,
        TournamentStatus.InProgress => Color.Success,
        TournamentStatus.Paused => Color.Warning,
        TournamentStatus.Finished => Color.Default,
        TournamentStatus.Cancelled => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(TournamentStatus status) => status switch
    {
        TournamentStatus.Scheduled => "Agendado",
        TournamentStatus.InProgress => "Em Andamento",
        TournamentStatus.Paused => "Pausado",
        TournamentStatus.Finished => "Finalizado",
        TournamentStatus.Cancelled => "Cancelado",
        _ => status.ToString()
    };

    // Open Graph meta tag methods
    private string GetPageTitle()
    {
        if (_tournament == null) return "Convite para Torneio - PokerHub";
        return $"{_tournament.Name} - PokerHub";
    }

    private string GetPageUrl()
    {
        return Navigation.Uri;
    }

    private string GetOgTitle()
    {
        if (_tournament == null) return "Convite para Torneio de Poker";
        return $"{_tournament.Name}";
    }

    private string GetOgDescription()
    {
        if (_tournament == null) return "Voce foi convidado para um torneio de poker no PokerHub!";

        var date = _tournament.ScheduledDateTime.ToString("dd/MM/yyyy 'as' HH:mm");
        var buyIn = _tournament.BuyIn.ToString("N2");
        var players = _tournament.PlayerCount;
        var location = !string.IsNullOrEmpty(_tournament.Location) ? $" | Local: {_tournament.Location}" : "";

        return $"{_tournament.LeagueName} | {date} | Buy-in: R$ {buyIn} | {players} jogadores{location}";
    }
}
