@page "/ligas/{LeagueId:guid}/torneios/criar"
@rendermode InteractiveServer
@attribute [Authorize]
@inject ITournamentService TournamentService
@inject ILeagueService LeagueService
@inject IPrizeTableService PrizeTableService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Criar Torneio - PokerHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6">
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-4" />

    <MudText Typo="Typo.h4" Class="mb-4">Criar Torneio</MudText>

    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.Center" Class="mb-4">
            @foreach (var (step, index) in _steps.Select((s, i) => (s, i)))
            {
                var stepIndex = index;
                var stepName = step;
                <MudButton Variant="@(stepIndex == _currentStep ? Variant.Filled : (stepIndex < _currentStep ? Variant.Outlined : Variant.Text))"
                          Color="@(stepIndex <= _currentStep ? Color.Primary : Color.Default)"
                          OnClick="@(() => GoToStep(stepIndex))"
                          Disabled="@(stepIndex > _currentStep)">
                    @(stepIndex + 1). @stepName
                </MudButton>
            }
        </MudStack>

        @switch (_currentStep)
        {
            case 0:
                <MudForm @ref="_form1" @bind-IsValid="_step1Valid">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_model.Name"
                                         Label="Nome do Torneio"
                                         Variant="Variant.Outlined"
                                         Required="true"
                                         RequiredError="O nome e obrigatorio" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudDatePicker @bind-Date="_date"
                                          Label="Data"
                                          Variant="Variant.Outlined"
                                          Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTimePicker @bind-Time="_time"
                                          Label="Horario"
                                          Variant="Variant.Outlined"
                                          Required="true" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_model.Location"
                                         Label="Local (opcional)"
                                         Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                </MudForm>
                break;

            case 1:
                <MudForm @ref="_form2" @bind-IsValid="_step2Valid">
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudNumericField @bind-Value="_model.BuyIn"
                                            Label="Buy-in (R$)"
                                            Variant="Variant.Outlined"
                                            Min="1m"
                                            Step="1m"
                                            Format="N0"
                                            Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudNumericField @bind-Value="_model.StartingStack"
                                            Label="Stack Inicial"
                                            Variant="Variant.Outlined"
                                            Min="100"
                                            Required="true" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.subtitle1" Class="mb-2">Rebuy</MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSwitch @bind-Value="_allowRebuy" Label="Permitir Rebuy" Color="Color.Primary" />
                        </MudItem>
                        @if (_allowRebuy)
                        {
                            <MudItem xs="12" sm="6">
                                <MudNumericField @bind-Value="_model.RebuyValue"
                                                Label="Valor do Rebuy (R$)"
                                                Variant="Variant.Outlined"
                                                Min="1m"
                                                Step="1m"
                                                Format="N0" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudNumericField @bind-Value="_model.RebuyStack"
                                                Label="Stack do Rebuy"
                                                Variant="Variant.Outlined"
                                                Min="100" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="_model.RebuyLimitType"
                                          Label="Limite de Rebuy"
                                          Variant="Variant.Outlined">
                                    <MudSelectItem Value="RebuyLimitType.Level">Por Nivel</MudSelectItem>
                                    <MudSelectItem Value="RebuyLimitType.Time">Por Tempo</MudSelectItem>
                                    <MudSelectItem Value="RebuyLimitType.Both">Ambos</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            @if (_model.RebuyLimitType == RebuyLimitType.Level || _model.RebuyLimitType == RebuyLimitType.Both)
                            {
                                <MudItem xs="12" sm="6">
                                    <MudNumericField @bind-Value="_model.RebuyLimitLevel"
                                                    Label="Rebuy Ate o Nivel"
                                                    Variant="Variant.Outlined"
                                                    Min="1" />
                                </MudItem>
                            }
                            @if (_model.RebuyLimitType == RebuyLimitType.Time || _model.RebuyLimitType == RebuyLimitType.Both)
                            {
                                <MudItem xs="12" sm="6">
                                    <MudNumericField @bind-Value="_model.RebuyLimitMinutes"
                                                    Label="Rebuy Ate (minutos)"
                                                    Variant="Variant.Outlined"
                                                    Min="1" />
                                </MudItem>
                            }
                        }
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.subtitle1" Class="mb-2">Add-on</MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSwitch @bind-Value="_allowAddon" Label="Permitir Add-on" Color="Color.Primary" />
                        </MudItem>
                        @if (_allowAddon)
                        {
                            <MudItem xs="12" sm="6">
                                <MudNumericField @bind-Value="_model.AddonValue"
                                                Label="Valor do Add-on (R$)"
                                                Variant="Variant.Outlined"
                                                Min="1m"
                                                Step="1m"
                                                Format="N0" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudNumericField @bind-Value="_model.AddonStack"
                                                Label="Stack do Add-on"
                                                Variant="Variant.Outlined"
                                                Min="100" />
                            </MudItem>
                        }
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.subtitle1" Class="mb-2">Check-in Tardio</MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSwitch @bind-Value="_allowEarlyCheckIn" Label="Permitir check-in apos inicio" Color="Color.Primary" />
                        </MudItem>
                        @if (_allowEarlyCheckIn)
                        {
                            <MudItem xs="12" sm="6">
                                <MudNumericField @bind-Value="_model.AllowCheckInUntilLevel"
                                                Label="Check-in ate o nivel"
                                                Variant="Variant.Outlined"
                                                HelperText="Jogadores podem entrar ate este nivel"
                                                Min="1"
                                                Max="20" />
                            </MudItem>
                        }
                    </MudGrid>
                </MudForm>
                break;

            case 2:
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle1" Class="mb-3">Escolha um template ou configure manualmente</MudText>
                        <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined" Class="mb-4">
                            <MudButton OnClick="@(() => ApplyTemplate("turbo"))"
                                      Variant="@(_selectedTemplate == "turbo" ? Variant.Filled : Variant.Outlined)">
                                Turbo (10 min)
                            </MudButton>
                            <MudButton OnClick="@(() => ApplyTemplate("regular"))"
                                      Variant="@(_selectedTemplate == "regular" ? Variant.Filled : Variant.Outlined)">
                                Regular (15 min)
                            </MudButton>
                            <MudButton OnClick="@(() => ApplyTemplate("deepstack"))"
                                      Variant="@(_selectedTemplate == "deepstack" ? Variant.Filled : Variant.Outlined)">
                                Deep Stack (20 min)
                            </MudButton>
                            <MudButton OnClick="@(() => ApplyTemplate("custom"))"
                                      Variant="@(_selectedTemplate == "custom" ? Variant.Filled : Variant.Outlined)">
                                Personalizado
                            </MudButton>
                        </MudButtonGroup>
                    </MudItem>

                    <MudItem xs="12">
                        <MudTable Items="_model.BlindLevels" Dense="true" Hover="true" Elevation="0" Bordered="true">
                            <HeaderContent>
                                <MudTh>Nivel</MudTh>
                                <MudTh>SB</MudTh>
                                <MudTh>BB</MudTh>
                                <MudTh>Ante</MudTh>
                                <MudTh>Duracao (min)</MudTh>
                                <MudTh>Tipo</MudTh>
                                @if (_selectedTemplate == "custom")
                                {
                                    <MudTh Style="width: 80px;">Acoes</MudTh>
                                }
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.Order</MudTd>
                                <MudTd>
                                    @if (_selectedTemplate == "custom" && !context.IsBreak)
                                    {
                                        <MudNumericField @bind-Value="context.SmallBlind" Min="0" Margin="Margin.Dense" Variant="Variant.Text" HideSpinButtons="true" />
                                    }
                                    else
                                    {
                                        @(context.IsBreak ? "-" : context.SmallBlind.ToString("N0"))
                                    }
                                </MudTd>
                                <MudTd>
                                    @if (_selectedTemplate == "custom" && !context.IsBreak)
                                    {
                                        <MudNumericField @bind-Value="context.BigBlind" Min="0" Margin="Margin.Dense" Variant="Variant.Text" HideSpinButtons="true" />
                                    }
                                    else
                                    {
                                        @(context.IsBreak ? "-" : context.BigBlind.ToString("N0"))
                                    }
                                </MudTd>
                                <MudTd>
                                    @if (_selectedTemplate == "custom" && !context.IsBreak)
                                    {
                                        <MudNumericField @bind-Value="context.Ante" Min="0" Margin="Margin.Dense" Variant="Variant.Text" HideSpinButtons="true" />
                                    }
                                    else
                                    {
                                        @(context.IsBreak ? "-" : context.Ante.ToString("N0"))
                                    }
                                </MudTd>
                                <MudTd>
                                    @if (_selectedTemplate == "custom")
                                    {
                                        <MudNumericField @bind-Value="context.DurationMinutes" Min="1" Max="60" Margin="Margin.Dense" Variant="Variant.Text" HideSpinButtons="true" />
                                    }
                                    else
                                    {
                                        @context.DurationMinutes
                                    }
                                </MudTd>
                                <MudTd>
                                    @if (context.IsBreak)
                                    {
                                        <MudChip T="string" Color="Color.Warning" Size="Size.Small">Intervalo</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Default" Size="Size.Small">Jogo</MudChip>
                                    }
                                </MudTd>
                                @if (_selectedTemplate == "custom")
                                {
                                    <MudTd>
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                      Size="Size.Small"
                                                      Color="Color.Error"
                                                      OnClick="@(() => RemoveLevel(context))" />
                                    </MudTd>
                                }
                            </RowTemplate>
                        </MudTable>

                        @if (_selectedTemplate == "custom")
                        {
                            <MudStack Row="true" Class="mt-2">
                                <MudButton Variant="Variant.Outlined"
                                          Color="Color.Primary"
                                          StartIcon="@Icons.Material.Filled.Add"
                                          OnClick="AddLevel">
                                    Adicionar Nivel
                                </MudButton>
                                <MudButton Variant="Variant.Outlined"
                                          Color="Color.Warning"
                                          StartIcon="@Icons.Material.Filled.Coffee"
                                          OnClick="AddBreak">
                                    Adicionar Intervalo
                                </MudButton>
                            </MudStack>
                        }
                    </MudItem>
                </MudGrid>
                break;

            case 3:
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle1" Class="mb-3">Estrutura de Premiacao</MudText>
                    </MudItem>

                    <MudItem xs="12">
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">Tipo de distribuicao:</MudText>
                        <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined" Class="mb-4">
                            <MudButton OnClick="@(() => _prizeDistributionType = PrizeDistributionType.Percentage)"
                                      Variant="@(_prizeDistributionType == PrizeDistributionType.Percentage ? Variant.Filled : Variant.Outlined)">
                                Percentual
                            </MudButton>
                            <MudButton OnClick="@(() => _prizeDistributionType = PrizeDistributionType.Fixed)"
                                      Variant="@(_prizeDistributionType == PrizeDistributionType.Fixed ? Variant.Filled : Variant.Outlined)">
                                Valor Fixo (R$)
                            </MudButton>
                        </MudButtonGroup>
                    </MudItem>

                    @if (_prizeDistributionType == PrizeDistributionType.Percentage)
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                Defina o percentual do prize pool para cada posicao:
                            </MudText>
                        </MudItem>

                        @for (var i = 0; i < _payoutStructure.Count; i++)
                        {
                            var index = i;
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField @bind-Value="_payoutStructure[index]"
                                                Label="@($"{index + 1}o Lugar (%)")"
                                                Variant="Variant.Outlined"
                                                Min="0"
                                                Max="100"
                                                Format="N0" />
                            </MudItem>
                        }

                        <MudItem xs="12">
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Outlined"
                                          Size="Size.Small"
                                          OnClick="AddPayoutPosition"
                                          Disabled="_payoutStructure.Count >= 10">
                                    + Posicao
                                </MudButton>
                                <MudButton Variant="Variant.Outlined"
                                          Size="Size.Small"
                                          Color="Color.Error"
                                          OnClick="RemovePayoutPosition"
                                          Disabled="_payoutStructure.Count <= 1">
                                    - Posicao
                                </MudButton>
                            </MudStack>
                        </MudItem>

                        <MudItem xs="12">
                            @{
                                var total = _payoutStructure.Sum();
                                var isValid = Math.Abs(total - 100) < 1;
                            }
                            <MudAlert Severity="@(isValid ? Severity.Success : Severity.Warning)">
                                Total: @total% @(isValid ? "(OK)" : "- deve somar 100%")
                            </MudAlert>
                        </MudItem>
                    }
                    else
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                Defina o valor fixo em R$ para cada posicao:
                            </MudText>
                        </MudItem>

                        @for (var i = 0; i < _fixedPayoutStructure.Count; i++)
                        {
                            var index = i;
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField @bind-Value="_fixedPayoutStructure[index]"
                                                Label="@($"{index + 1}o Lugar (R$)")"
                                                Variant="Variant.Outlined"
                                                Min="0m"
                                                Format="N2" />
                            </MudItem>
                        }

                        <MudItem xs="12">
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Outlined"
                                          Size="Size.Small"
                                          OnClick="AddFixedPayoutPosition"
                                          Disabled="_fixedPayoutStructure.Count >= 10">
                                    + Posicao
                                </MudButton>
                                <MudButton Variant="Variant.Outlined"
                                          Size="Size.Small"
                                          Color="Color.Error"
                                          OnClick="RemoveFixedPayoutPosition"
                                          Disabled="_fixedPayoutStructure.Count <= 1">
                                    - Posicao
                                </MudButton>
                            </MudStack>
                        </MudItem>

                        <MudItem xs="12">
                            @{
                                var fixedTotal = _fixedPayoutStructure.Sum();
                            }
                            <MudAlert Severity="Severity.Info">
                                Total definido: @fixedTotal.ToString("C")
                            </MudAlert>
                        </MudItem>
                    }

                    @if (_prizeTables.Any())
                    {
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudSwitch @bind-Value="_usePrizeTable" Label="Usar tabela de premiacao (sobrescreve a definicao acima quando prize pool coincidir)" Color="Color.Primary" />
                        </MudItem>

                        @if (_usePrizeTable)
                        {
                            <MudItem xs="12">
                                <MudSelect T="Guid?" @bind-Value="_selectedPrizeTableId"
                                          Label="Selecione uma tabela especifica (opcional)"
                                          Variant="Variant.Outlined"
                                          AnchorOrigin="Origin.BottomCenter"
                                          Clearable="true"
                                          HelperText="Se nao selecionar, usara automaticamente a tabela com prize pool igual">
                                    @foreach (var table in _prizeTables.OrderBy(t => t.PrizePoolTotal))
                                    {
                                        <MudSelectItem Value="@((Guid?)table.Id)">
                                            @table.PrizePoolTotal.ToString("C") - @table.Name
                                        </MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>

                            @if (_selectedPrizeTableId.HasValue)
                            {
                                var selectedTable = _prizeTables.FirstOrDefault(t => t.Id == _selectedPrizeTableId.Value);
                                if (selectedTable != null)
                                {
                                    <MudItem xs="12">
                                        <MudCard Elevation="1" Class="mt-2">
                                            <MudCardContent>
                                                <MudSimpleTable Dense="true" Hover="true">
                                                    <thead>
                                                        <tr>
                                                            <th>Posicao</th>
                                                            <th style="text-align: right;">Premio</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var entry in selectedTable.Entries.OrderBy(e => e.Position))
                                                        {
                                                            <tr>
                                                                <td>@entry.Position&ordm; Lugar</td>
                                                                <td style="text-align: right;">@entry.PrizeAmount.ToString("C")</td>
                                                            </tr>
                                                        }
                                                        @if (selectedTable.JackpotAmount > 0)
                                                        {
                                                            <tr>
                                                                <td><MudIcon Icon="@Icons.Material.Filled.Savings" Size="Size.Small" Color="Color.Warning" Class="mr-1" />Caixinha</td>
                                                                <td style="text-align: right;">@selectedTable.JackpotAmount.ToString("C")</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </MudSimpleTable>
                                            </MudCardContent>
                                        </MudCard>
                                    </MudItem>
                                }
                            }
                            else
                            {
                                <MudItem xs="12">
                                    <MudAlert Severity="Severity.Info" Dense="true">
                                        <MudText Typo="Typo.body2">
                                            Ao finalizar o torneio, o sistema buscara automaticamente uma tabela com prize pool igual ao total arrecadado.
                                        </MudText>
                                    </MudAlert>
                                </MudItem>
                            }

                            <MudItem xs="12">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        Nao encontrou a tabela ideal?
                                    </MudText>
                                    <MudButton Variant="Variant.Text"
                                              Color="Color.Primary"
                                              Size="Size.Small"
                                              Href="@($"/ligas/{LeagueId}/tabelas-premiacao")"
                                              Target="_blank">
                                        Gerenciar tabelas
                                    </MudButton>
                                </MudStack>
                            </MudItem>
                        }
                    }
                    else
                    {
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Info" Dense="true">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body2">
                                        Voce pode criar tabelas de premiacao com valores fixos para reutilizar em torneios.
                                    </MudText>
                                    <MudButton Variant="Variant.Text"
                                              Color="Color.Primary"
                                              Size="Size.Small"
                                              Href="@($"/ligas/{LeagueId}/tabelas-premiacao")"
                                              Target="_blank">
                                        Gerenciar tabelas
                                    </MudButton>
                                </MudStack>
                            </MudAlert>
                        </MudItem>
                    }
                </MudGrid>
                break;

            case 4:
                <MudCard Elevation="0" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-4">Resumo do Torneio</MudText>

                    <MudSimpleTable Dense="true" Hover="true" Bordered="true">
                        <tbody>
                            <tr><td><strong>Nome</strong></td><td>@_model.Name</td></tr>
                            <tr><td><strong>Data/Hora</strong></td><td>@(_date?.Add(_time ?? TimeSpan.Zero).ToString("dd/MM/yyyy HH:mm"))</td></tr>
                            <tr><td><strong>Local</strong></td><td>@(_model.Location ?? "-")</td></tr>
                            <tr><td><strong>Buy-in</strong></td><td>R$ @_model.BuyIn.ToString("N2")</td></tr>
                            <tr><td><strong>Stack Inicial</strong></td><td>@_model.StartingStack.ToString("N0")</td></tr>
                            <tr><td><strong>Rebuy</strong></td><td>@GetRebuyDescription()</td></tr>
                            <tr><td><strong>Add-on</strong></td><td>@(_allowAddon ? $"R$ {_model.AddonValue:N2} ({_model.AddonStack} fichas)" : "Nao")</td></tr>
                            <tr><td><strong>Check-in Tardio</strong></td><td>@(_allowEarlyCheckIn ? $"Ate nivel {_model.AllowCheckInUntilLevel}" : "Nao")</td></tr>
                            <tr><td><strong>Niveis de Blind</strong></td><td>@_model.BlindLevels.Count niveis (@_model.BlindLevels.Count(bl => bl.IsBreak) intervalos)</td></tr>
                            <tr>
                                <td><strong>Premiacao</strong></td>
                                <td>
                                    @if (_prizeDistributionType == PrizeDistributionType.Percentage)
                                    {
                                        @string.Join(", ", _payoutStructure.Select((p, i) => $"{i+1}o: {p}%"))
                                    }
                                    else
                                    {
                                        @string.Join(", ", _fixedPayoutStructure.Where(v => v > 0).Select((p, i) => $"{i+1}o: {p:C}"))
                                    }
                                </td>
                            </tr>
                            @if (_usePrizeTable)
                            {
                                <tr>
                                    <td><strong>Tabela de Premiacao</strong></td>
                                    <td>
                                        @if (_selectedPrizeTableId.HasValue)
                                        {
                                            var table = _prizeTables.FirstOrDefault(t => t.Id == _selectedPrizeTableId.Value);
                                            @(table != null ? $"{table.Name} ({table.PrizePoolTotal:C})" : "Selecionada")
                                        }
                                        else
                                        {
                                            <text>Automatica (busca por prize pool)</text>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </MudCard>
                break;
        }
    </MudPaper>

    <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-4">
        <MudButton Variant="Variant.Text"
                  OnClick="@(() => Navigation.NavigateTo($"/ligas/{LeagueId}/torneios"))">
            Cancelar
        </MudButton>
        <MudStack Row="true" Spacing="2">
            @if (_currentStep > 0)
            {
                <MudButton Variant="Variant.Outlined"
                          OnClick="PreviousStep">
                    Voltar
                </MudButton>
            }
            @if (_currentStep < 4)
            {
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          OnClick="NextStep"
                          Disabled="!CanProceed()">
                    Proximo
                </MudButton>
            }
            else
            {
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          OnClick="CreateTournament"
                          Disabled="_saving">
                    @if (_saving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Criar Torneio
                </MudButton>
            }
        </MudStack>
    </MudStack>
</MudContainer>

@code {
    [Parameter] public Guid LeagueId { get; set; }

    private readonly string[] _steps = { "Informacoes", "Valores", "Blinds", "Premiacao", "Confirmacao" };
    private int _currentStep;
    private bool _step1Valid;
    private bool _step2Valid;
    private bool _saving;
    private MudForm _form1 = null!;
    private MudForm _form2 = null!;
    private DateTime? _date = DateTime.Today;
    private TimeSpan? _time = new TimeSpan(20, 0, 0);
    private bool _allowRebuy = true;
    private bool _allowAddon = true;
    private bool _allowEarlyCheckIn = false;
    private string _selectedTemplate = "regular";
    private List<BreadcrumbItem> _breadcrumbs = new();
    private LeagueDto? _league;
    private PrizeDistributionType _prizeDistributionType = PrizeDistributionType.Percentage;
    private List<int> _payoutStructure = new() { 50, 30, 20 };
    private List<decimal> _fixedPayoutStructure = new() { 0m, 0m, 0m };
    private List<LeaguePrizeTableDto> _prizeTables = new();
    private bool _usePrizeTable;
    private Guid? _selectedPrizeTableId;

    private TournamentModel _model = new()
    {
        BuyIn = 50,
        StartingStack = 10000,
        RebuyValue = 50,
        RebuyStack = 10000,
        RebuyLimitType = RebuyLimitType.Level,
        RebuyLimitLevel = 4,
        RebuyLimitMinutes = 60,
        AddonValue = 50,
        AddonStack = 10000,
        AllowCheckInUntilLevel = 3
    };

    protected override async Task OnInitializedAsync()
    {
        _league = await LeagueService.GetLeagueByIdAsync(LeagueId);
        if (_league != null)
        {
            _breadcrumbs = new List<BreadcrumbItem>
            {
                new("Ligas", "/ligas", false),
                new(_league.Name, $"/ligas/{LeagueId}", false),
                new("Torneios", $"/ligas/{LeagueId}/torneios", false),
                new("Criar", null, true)
            };

            _prizeTables = (await PrizeTableService.GetPrizeTablesByLeagueAsync(LeagueId)).ToList();
        }

        ApplyTemplate("regular");
    }

    private void ApplyTemplate(string template)
    {
        _selectedTemplate = template;
        _model.BlindLevels = template switch
        {
            "turbo" => TournamentService.GetTurboBlindTemplate().Select(bl => new BlindLevelModel
            {
                Order = bl.Order,
                SmallBlind = bl.SmallBlind,
                BigBlind = bl.BigBlind,
                Ante = bl.Ante,
                DurationMinutes = bl.DurationMinutes,
                IsBreak = bl.IsBreak,
                BreakDescription = bl.BreakDescription
            }).ToList(),
            "deepstack" => TournamentService.GetDeepStackBlindTemplate().Select(bl => new BlindLevelModel
            {
                Order = bl.Order,
                SmallBlind = bl.SmallBlind,
                BigBlind = bl.BigBlind,
                Ante = bl.Ante,
                DurationMinutes = bl.DurationMinutes,
                IsBreak = bl.IsBreak,
                BreakDescription = bl.BreakDescription
            }).ToList(),
            "custom" => _model.BlindLevels.Any() ? _model.BlindLevels : GetDefaultCustomLevels(),
            _ => TournamentService.GetRegularBlindTemplate().Select(bl => new BlindLevelModel
            {
                Order = bl.Order,
                SmallBlind = bl.SmallBlind,
                BigBlind = bl.BigBlind,
                Ante = bl.Ante,
                DurationMinutes = bl.DurationMinutes,
                IsBreak = bl.IsBreak,
                BreakDescription = bl.BreakDescription
            }).ToList()
        };
    }

    private List<BlindLevelModel> GetDefaultCustomLevels()
    {
        return new List<BlindLevelModel>
        {
            new() { Order = 1, SmallBlind = 25, BigBlind = 50, Ante = 0, DurationMinutes = 15, IsBreak = false },
            new() { Order = 2, SmallBlind = 50, BigBlind = 100, Ante = 0, DurationMinutes = 15, IsBreak = false },
            new() { Order = 3, SmallBlind = 75, BigBlind = 150, Ante = 0, DurationMinutes = 15, IsBreak = false }
        };
    }

    private void AddLevel()
    {
        var lastLevel = _model.BlindLevels.Where(bl => !bl.IsBreak).OrderByDescending(bl => bl.Order).FirstOrDefault();
        var newOrder = _model.BlindLevels.Count + 1;

        _model.BlindLevels.Add(new BlindLevelModel
        {
            Order = newOrder,
            SmallBlind = (int)((lastLevel?.BigBlind ?? 50) * 1.5),
            BigBlind = (lastLevel?.BigBlind ?? 50) * 2,
            Ante = lastLevel?.Ante ?? 0,
            DurationMinutes = lastLevel?.DurationMinutes ?? 15,
            IsBreak = false
        });
        ReorderLevels();
    }

    private void AddBreak()
    {
        var newOrder = _model.BlindLevels.Count + 1;
        _model.BlindLevels.Add(new BlindLevelModel
        {
            Order = newOrder,
            SmallBlind = 0,
            BigBlind = 0,
            Ante = 0,
            DurationMinutes = 10,
            IsBreak = true,
            BreakDescription = "Intervalo"
        });
        ReorderLevels();
    }

    private void RemoveLevel(BlindLevelModel level)
    {
        _model.BlindLevels.Remove(level);
        ReorderLevels();
    }

    private void ReorderLevels()
    {
        var order = 1;
        foreach (var level in _model.BlindLevels)
        {
            level.Order = order++;
        }
    }

    private void AddPayoutPosition()
    {
        if (_payoutStructure.Count < 10)
            _payoutStructure.Add(0);
    }

    private void RemovePayoutPosition()
    {
        if (_payoutStructure.Count > 1)
            _payoutStructure.RemoveAt(_payoutStructure.Count - 1);
    }

    private void AddFixedPayoutPosition()
    {
        if (_fixedPayoutStructure.Count < 10)
            _fixedPayoutStructure.Add(0m);
    }

    private void RemoveFixedPayoutPosition()
    {
        if (_fixedPayoutStructure.Count > 1)
            _fixedPayoutStructure.RemoveAt(_fixedPayoutStructure.Count - 1);
    }

    private bool CanProceed()
    {
        return _currentStep switch
        {
            0 => !string.IsNullOrWhiteSpace(_model.Name) && _date.HasValue && _time.HasValue,
            1 => _model.BuyIn > 0 && _model.StartingStack > 0,
            2 => _model.BlindLevels.Count > 0,
            3 => ValidatePrizeStep(),
            _ => true
        };
    }

    private bool ValidatePrizeStep()
    {
        // If using prize table, it's always valid (either specific or auto-matching)
        if (_usePrizeTable)
            return true;

        // Validate based on distribution type
        if (_prizeDistributionType == PrizeDistributionType.Percentage)
        {
            return Math.Abs(_payoutStructure.Sum() - 100) < 1;
        }
        else
        {
            // Fixed: at least one position must have value > 0
            return _fixedPayoutStructure.Any(v => v > 0);
        }
    }

    private void GoToStep(int step)
    {
        if (step <= _currentStep)
            _currentStep = step;
    }

    private async Task NextStep()
    {
        if (_currentStep == 0) await _form1.Validate();
        if (_currentStep == 1) await _form2.Validate();

        if (CanProceed())
            _currentStep++;
    }

    private void PreviousStep()
    {
        if (_currentStep > 0)
            _currentStep--;
    }

    private string GetRebuyDescription()
    {
        if (!_allowRebuy) return "Nao";

        var desc = $"R$ {_model.RebuyValue:N2} ({_model.RebuyStack} fichas)";
        if (_model.RebuyLimitType == RebuyLimitType.Level)
            desc += $" ate nivel {_model.RebuyLimitLevel}";
        else if (_model.RebuyLimitType == RebuyLimitType.Time)
            desc += $" ate {_model.RebuyLimitMinutes} min";
        else
            desc += $" ate nivel {_model.RebuyLimitLevel} ou {_model.RebuyLimitMinutes} min";

        return desc;
    }

    private async Task CreateTournament()
    {
        _saving = true;
        try
        {
            var scheduledDateTime = _date!.Value.Add(_time!.Value);

            // Build prize structure based on distribution type
            string? prizeStructure = null;
            if (_prizeDistributionType == PrizeDistributionType.Percentage)
            {
                prizeStructure = string.Join(",", _payoutStructure);
            }
            else
            {
                prizeStructure = string.Join(",", _fixedPayoutStructure.Select(v => v.ToString("F2")));
            }

            var dto = new CreateTournamentDto(
                _model.Name!,
                scheduledDateTime,
                _model.Location,
                _model.BuyIn,
                _model.StartingStack,
                _allowRebuy ? _model.RebuyValue : null,
                _allowRebuy ? _model.RebuyStack : null,
                _allowRebuy ? _model.RebuyLimitLevel : null,
                _allowRebuy ? _model.RebuyLimitMinutes : null,
                _allowRebuy ? _model.RebuyLimitType : RebuyLimitType.Level,
                _allowAddon ? _model.AddonValue : null,
                _allowAddon ? _model.AddonStack : null,
                prizeStructure,
                _prizeDistributionType,
                _usePrizeTable,
                _usePrizeTable ? _selectedPrizeTableId : null,
                _allowEarlyCheckIn ? _model.AllowCheckInUntilLevel : null,
                _model.BlindLevels.Select(bl => new CreateBlindLevelDto(
                    bl.Order,
                    bl.SmallBlind,
                    bl.BigBlind,
                    bl.Ante,
                    bl.DurationMinutes,
                    bl.IsBreak,
                    bl.BreakDescription
                )).ToList()
            );

            var result = await TournamentService.CreateTournamentAsync(LeagueId, dto);
            Snackbar.Add("Torneio criado com sucesso!", Severity.Success);
            Navigation.NavigateTo($"/torneios/{result.Id}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao criar torneio: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private class TournamentModel
    {
        public string? Name { get; set; }
        public string? Location { get; set; }
        public decimal BuyIn { get; set; }
        public int StartingStack { get; set; }
        public decimal? RebuyValue { get; set; }
        public int? RebuyStack { get; set; }
        public RebuyLimitType RebuyLimitType { get; set; }
        public int? RebuyLimitLevel { get; set; }
        public int? RebuyLimitMinutes { get; set; }
        public decimal? AddonValue { get; set; }
        public int? AddonStack { get; set; }
        public int? AllowCheckInUntilLevel { get; set; }
        public List<BlindLevelModel> BlindLevels { get; set; } = new();
    }

    private class BlindLevelModel
    {
        public int Order { get; set; }
        public int SmallBlind { get; set; }
        public int BigBlind { get; set; }
        public int Ante { get; set; }
        public int DurationMinutes { get; set; }
        public bool IsBreak { get; set; }
        public string? BreakDescription { get; set; }
    }
}
