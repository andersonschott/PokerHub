@page "/ligas/{LeagueId:guid}"
@rendermode InteractiveServer
@attribute [Authorize]
@inject ILeagueService LeagueService
@inject IPlayerService PlayerService
@inject ITournamentService TournamentService
@inject ISeasonService SeasonService
@inject IRankingService RankingService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>@(_league?.Name ?? "Liga") - PokerHub</PageTitle>

@if (_loading)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
}
else if (_league == null)
{
    <MudAlert Severity="Severity.Error">Liga nao encontrada</MudAlert>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large">
        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudStack>
                <MudText Typo="Typo.h4">@_league.Name</MudText>
                @if (!string.IsNullOrEmpty(_league.Description))
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_league.Description</MudText>
                }
            </MudStack>
            <MudStack Row Spacing="2">
                <MudButton Variant="Variant.Outlined"
                          Color="Color.Warning"
                          StartIcon="@Icons.Material.Filled.Savings"
                          Href="@($"/ligas/{LeagueId}/jackpot")">
                    Caixinha
                </MudButton>
                @if (_isOrganizer)
                {
                    <MudButton Variant="Variant.Outlined"
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.ContentCopy"
                              OnClick="ShowInviteCode">
                        Convidar
                    </MudButton>
                    <MudMenu Icon="@Icons.Material.Filled.Settings"
                            Variant="Variant.Outlined"
                            Color="Color.Default"
                            Label="Configurar"
                            EndIcon="@Icons.Material.Filled.KeyboardArrowDown">
                        <MudMenuItem Href="@($"/ligas/{LeagueId}/editar")" Icon="@Icons.Material.Filled.Edit">
                            Editar Liga
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Href="@($"/ligas/{LeagueId}/temporadas")" Icon="@Icons.Material.Filled.CalendarMonth">
                            Temporadas
                        </MudMenuItem>
                        <MudMenuItem Href="@($"/ligas/{LeagueId}/tabelas-premiacao")" Icon="@Icons.Material.Filled.TableChart">
                            Tabelas de Premiacao
                        </MudMenuItem>
                    </MudMenu>
                }
            </MudStack>
        </MudStack>

        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3 pa-sm-6"
                 MinimumTabWidth="80px" Position="Position.Top">
            <MudTabPanel Text="Jogadores" Icon="@Icons.Material.Filled.People">
                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h6">Jogadores (@_league.Players.Count)</MudText>
                    @if (_isOrganizer)
                    {
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  StartIcon="@Icons.Material.Filled.PersonAdd"
                                  OnClick="OpenAddPlayerDialog">
                            Adicionar Jogador
                        </MudButton>
                    }
                </MudStack>

                @if (!_league.Players.Any())
                {
                    <MudAlert Severity="Severity.Info">
                        Nenhum jogador cadastrado. Adicione jogadores para comecar a organizar torneios.
                    </MudAlert>
                }
                else
                {
                    <MudGrid>
                        @foreach (var player in _league.Players.OrderBy(p => p.Name))
                        {
                            <MudItem xs="12" sm="6" md="4">
                                <MudCard Elevation="2">
                                    <MudCardHeader>
                                        <CardHeaderContent>
                                            <MudText Typo="Typo.h6">@player.Name</MudText>
                                            @if (!string.IsNullOrEmpty(player.Nickname))
                                            {
                                                <MudText Typo="Typo.body2" Color="Color.Secondary">@player.Nickname</MudText>
                                            }
                                        </CardHeaderContent>
                                        <CardHeaderActions>
                                            @if (player.Wins > 0)
                                            {
                                                <MudChip T="string" Color="Color.Warning" Size="Size.Small" Icon="@Icons.Material.Filled.EmojiEvents">
                                                    @player.Wins
                                                </MudChip>
                                            }
                                        </CardHeaderActions>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <MudStack Spacing="2">
                                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.Casino" Size="Size.Small" Color="Color.Secondary"/>
                                                <MudText Typo="Typo.body2">@player.TournamentsPlayed torneios jogados</MudText>
                                            </MudStack>
                                            @if (player.TournamentsPlayed > 0)
                                            {
                                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" Color="Color.Secondary"/>
                                                    <MudText Typo="Typo.body2">ROI: @player.ROI.ToString("N1")% | ITM: @player.ITMRate.ToString("N1")%</MudText>
                                                </MudStack>
                                            }
                                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Size="Size.Small"
                                                         Color="@(player.TotalProfit >= 0 ? Color.Success : Color.Error)"/>
                                                <MudText Typo="Typo.body2" Color="@(player.TotalProfit >= 0 ? Color.Success : Color.Error)" Style="font-weight: 600;">
                                                    @(player.TotalProfit >= 0 ? "+" : "")R$ @player.TotalProfit.ToString("N2")
                                                </MudText>
                                            </MudStack>
                                        </MudStack>
                                    </MudCardContent>
                                    <MudCardActions>
                                        <MudButton Variant="Variant.Text" Color="Color.Primary"
                                                   Href="@($"/jogador/{player.Id}/stats")" Size="Size.Small">
                                            Estatisticas
                                        </MudButton>
                                        @if (_isOrganizer)
                                        {
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                          Size="Size.Small"
                                                          OnClick="@(() => EditPlayer(player.Id))" />
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                          Size="Size.Small"
                                                          Color="Color.Error"
                                                          OnClick="@(() => DeletePlayer(player))" />
                                        }
                                    </MudCardActions>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                }
            </MudTabPanel>

            <MudTabPanel Text="Torneios" Icon="@Icons.Material.Filled.EmojiEvents">
                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h6">Torneios (@(_tournaments?.Count ?? 0))</MudText>
                    @if (_isOrganizer)
                    {
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  StartIcon="@Icons.Material.Filled.Add"
                                  Href="@($"/ligas/{LeagueId}/torneios/criar")">
                            Criar Torneio
                        </MudButton>
                    }
                </MudStack>

                @if (_tournaments == null || !_tournaments.Any())
                {
                    <MudAlert Severity="Severity.Info">
                        Nenhum torneio criado. Clique em "Criar Torneio" para comecar!
                    </MudAlert>
                }
                else
                {
                    <MudGrid>
                        @foreach (var tournament in _tournaments.OrderByDescending(t => t.ScheduledDateTime))
                        {
                            <MudItem xs="12" sm="6" md="4">
                                <MudCard Elevation="2" Class="cursor-pointer" @onclick="@(() => Navigation.NavigateTo($"/torneios/{tournament.Id}"))">
                                    <MudCardHeader>
                                        <CardHeaderContent>
                                            <MudText Typo="Typo.h6">@tournament.Name</MudText>
                                        </CardHeaderContent>
                                        <CardHeaderActions>
                                            <MudChip T="string" Color="@GetStatusColor(tournament.Status)" Size="Size.Small">
                                                @GetStatusText(tournament.Status)
                                            </MudChip>
                                        </CardHeaderActions>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <MudStack Spacing="2">
                                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" Color="Color.Secondary"/>
                                                <MudText Typo="Typo.body2">@tournament.ScheduledDateTime.ToString("dd/MM/yyyy HH:mm")</MudText>
                                            </MudStack>
                                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.Payments" Size="Size.Small" Color="Color.Secondary"/>
                                                <MudText Typo="Typo.body2">Buy-in: R$ @tournament.BuyIn.ToString("N2")</MudText>
                                            </MudStack>
                                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Color="Color.Secondary"/>
                                                <MudText Typo="Typo.body2">@tournament.CheckedInCount/@tournament.PlayerCount jogadores</MudText>
                                            </MudStack>
                                            @if (tournament.PrizePool > 0)
                                            {
                                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                                    <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Size="Size.Small" Color="Color.Warning"/>
                                                    <MudText Typo="Typo.body2" Color="Color.Warning">Prize Pool: R$ @tournament.PrizePool.ToString("N2")</MudText>
                                                </MudStack>
                                            }
                                        </MudStack>
                                    </MudCardContent>
                                    <MudCardActions>
                                        @if (tournament.Status == TournamentStatus.InProgress || tournament.Status == TournamentStatus.Paused)
                                        {
                                            <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@($"/timer/{tournament.Id}")" Target="_blank" @onclick:stopPropagation="true">
                                                Ver Timer
                                            </MudButton>
                                        }
                                        <MudButton Variant="Variant.Text" Color="Color.Default" Href="@($"/torneios/{tournament.Id}")" @onclick:stopPropagation="true">
                                            @(tournament.Status == TournamentStatus.Scheduled ? "Gerenciar" : "Detalhes")
                                        </MudButton>
                                        @if (_isOrganizer)
                                        {
                                            <span @onclick:stopPropagation="true">
                                                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                                              Size="Size.Small"
                                                              Color="Color.Default"
                                                              OnClick="@(() => DuplicateTournament(tournament.Id))" />
                                            </span>
                                        }
                                    </MudCardActions>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                }
            </MudTabPanel>

            <MudTabPanel Text="Ranking" Icon="@Icons.Material.Filled.Leaderboard">
                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h6">Ranking por Lucro/Prejuizo</MudText>
                    @if (_seasons.Any())
                    {
                        <MudSelect T="Guid?" Value="_selectedSeasonId" ValueChanged="OnSeasonChanged"
                                  Label="Temporada" Variant="Variant.Outlined" Dense="true"
                                  Style="max-width: 250px;">
                            <MudSelectItem T="Guid?" Value="@((Guid?)null)">Ranking Geral (Acumulado)</MudSelectItem>
                            @foreach (var season in _seasons.OrderByDescending(s => s.StartDate))
                            {
                                <MudSelectItem T="Guid?" Value="@season.Id">@season.Name</MudSelectItem>
                            }
                        </MudSelect>
                    }
                </MudStack>

                @if (_selectedSeasonId.HasValue)
                {
                    var selectedSeason = _seasons.FirstOrDefault(s => s.Id == _selectedSeasonId.Value);
                    if (selectedSeason != null)
                    {
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                            <MudText Typo="Typo.body2">
                                Periodo: @selectedSeason.StartDate.ToString("dd/MM/yyyy") - @selectedSeason.EndDate.ToString("dd/MM/yyyy")
                                (@selectedSeason.TournamentCount torneio(s))
                            </MudText>
                        </MudAlert>
                    }
                }

                @if (!_rankingData.Any())
                {
                    <MudAlert Severity="Severity.Info">
                        @if (_selectedSeasonId.HasValue)
                        {
                            <text>Nenhum torneio finalizado nesta temporada.</text>
                        }
                        else
                        {
                            <text>Nenhum jogador cadastrado. Adicione jogadores e realize torneios para ver o ranking.</text>
                        }
                    </MudAlert>
                }
                else
                {
                    <MudTable Items="@_rankingData" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh Style="width: 50px;">#</MudTh>
                            <MudTh>Jogador</MudTh>
                            <MudTh Style="text-align: center;">Torneios</MudTh>
                            <MudTh Style="text-align: center;">1o</MudTh>
                            <MudTh Style="text-align: center;">2o</MudTh>
                            <MudTh Style="text-align: center;">3o</MudTh>
                            <MudTh Style="text-align: right;">ROI</MudTh>
                            <MudTh Style="text-align: right;">ITM</MudTh>
                            <MudTh Style="text-align: right;">Lucro/Prejuizo</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="#">
                                @if (context.Position == 1)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Warning" Size="Size.Small"/>
                                }
                                else if (context.Position == 2)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Default" Size="Size.Small"/>
                                }
                                else if (context.Position == 3)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Tertiary" Size="Size.Small"/>
                                }
                                else
                                {
                                    <MudText>@context.Position</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Jogador">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small">@context.PlayerName[0]</MudAvatar>
                                    <div>
                                        <MudText>@context.PlayerName</MudText>
                                        @if (!string.IsNullOrEmpty(context.Nickname))
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Nickname</MudText>
                                        }
                                    </div>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Torneios" Style="text-align: center;">@context.TournamentsPlayed</MudTd>
                            <MudTd DataLabel="1o" Style="text-align: center;">
                                @if (context.Wins > 0)
                                {
                                    <MudChip T="string" Color="Color.Warning" Size="Size.Small">@context.Wins</MudChip>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </MudTd>
                            <MudTd DataLabel="2o" Style="text-align: center;">
                                @if (context.SecondPlaces > 0)
                                {
                                    <MudChip T="string" Color="Color.Default" Size="Size.Small">@context.SecondPlaces</MudChip>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </MudTd>
                            <MudTd DataLabel="3o" Style="text-align: center;">
                                @if (context.ThirdPlaces > 0)
                                {
                                    <MudChip T="string" Color="Color.Tertiary" Size="Size.Small">@context.ThirdPlaces</MudChip>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </MudTd>
                            <MudTd DataLabel="ROI" Style="text-align: right;">
                                @if (context.TournamentsPlayed > 0)
                                {
                                    <MudText Typo="Typo.body2" Color="@(context.ROI >= 0 ? Color.Success : Color.Error)">
                                        @(context.ROI >= 0 ? "+" : "")@context.ROI.ToString("N1")%
                                    </MudText>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </MudTd>
                            <MudTd DataLabel="ITM" Style="text-align: right;">
                                @if (context.TournamentsPlayed > 0)
                                {
                                    <MudText Typo="Typo.body2">@context.ITMRate.ToString("N1")%</MudText>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </MudTd>
                            <MudTd DataLabel="Lucro/Prejuizo" Style="text-align: right;">
                                <MudText Typo="Typo.body2" Color="@(context.Profit >= 0 ? Color.Success : Color.Error)" Style="font-weight: bold;">
                                    @(context.Profit >= 0 ? "+" : "")R$ @context.Profit.ToString("N2")
                                </MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }

                @if (_isOrganizer && !_seasons.Any())
                {
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mt-4">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                            <MudText Typo="Typo.body2">
                                Crie temporadas para organizar rankings por periodo.
                            </MudText>
                            <MudButton Variant="Variant.Text"
                                      Color="Color.Primary"
                                      Size="Size.Small"
                                      Href="@($"/ligas/{LeagueId}/temporadas")">
                                Gerenciar Temporadas
                            </MudButton>
                        </MudStack>
                    </MudAlert>
                }
            </MudTabPanel>
        </MudTabs>
    </MudContainer>
}

<MudDialog @bind-Visible="_inviteDialogVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">Codigo de Convite</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body1" Class="mb-2">
            Compartilhe este codigo para convidar jogadores:
        </MudText>
        <MudPaper Elevation="0" Class="pa-4 d-flex justify-center" Style="background-color: var(--mud-palette-background-grey);">
            <MudText Typo="Typo.h4" Style="font-family: monospace; letter-spacing: 0.3em;">
                @_league?.InviteCode
            </MudText>
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _inviteDialogVisible = false)">Fechar</MudButton>
        @if (_isOrganizer)
        {
            <MudButton Color="Color.Primary" OnClick="RegenerateInviteCode">Gerar Novo Codigo</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public Guid LeagueId { get; set; }

    private LeagueWithPlayersDto? _league;
    private IReadOnlyList<TournamentDto>? _tournaments;
    private List<SeasonSummaryDto> _seasons = new();
    private List<PlayerRankingDto> _rankingData = new();
    private Guid? _selectedSeasonId;
    private bool _loading = true;
    private bool _inviteDialogVisible;
    private bool _isOrganizer;
    private bool _canAccess;
    private string? _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(_currentUserId))
        {
            _canAccess = await LeagueService.CanUserAccessLeagueAsync(LeagueId, _currentUserId);
            _isOrganizer = await LeagueService.IsUserOrganizerAsync(LeagueId, _currentUserId);

            if (!_canAccess)
            {
                Navigation.NavigateTo("/ligas");
                return;
            }
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            _league = await LeagueService.GetLeagueWithPlayersAsync(LeagueId);
            _tournaments = await TournamentService.GetTournamentsByLeagueAsync(LeagueId);
            _seasons = (await SeasonService.GetSeasonSummariesAsync(LeagueId)).ToList();
            await LoadRankingData();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadRankingData()
    {
        if (_selectedSeasonId.HasValue)
        {
            _rankingData = (await SeasonService.GetSeasonRankingAsync(_selectedSeasonId.Value)).ToList();
        }
        else
        {
            _rankingData = (await RankingService.GetLeagueRankingAsync(LeagueId)).ToList();
        }
    }

    private async Task OnSeasonChanged(Guid? seasonId)
    {
        _selectedSeasonId = seasonId;
        await LoadRankingData();
    }

    private async Task LoadLeague()
    {
        _league = await LeagueService.GetLeagueWithPlayersAsync(LeagueId);
    }

    private Color GetStatusColor(TournamentStatus status) => status switch
    {
        TournamentStatus.Scheduled => Color.Info,
        TournamentStatus.InProgress => Color.Success,
        TournamentStatus.Paused => Color.Warning,
        TournamentStatus.Finished => Color.Default,
        TournamentStatus.Cancelled => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(TournamentStatus status) => status switch
    {
        TournamentStatus.Scheduled => "Agendado",
        TournamentStatus.InProgress => "Em Andamento",
        TournamentStatus.Paused => "Pausado",
        TournamentStatus.Finished => "Finalizado",
        TournamentStatus.Cancelled => "Cancelado",
        _ => status.ToString()
    };

    private void ShowInviteCode()
    {
        _inviteDialogVisible = true;
    }

    private async Task RegenerateInviteCode()
    {
        try
        {
            var newCode = await LeagueService.RegenerateInviteCodeAsync(LeagueId);
            await LoadLeague();
            Snackbar.Add("Novo codigo gerado!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenAddPlayerDialog()
    {
        var parameters = new DialogParameters<AddPlayerDialog>
        {
            { x => x.LeagueId, LeagueId }
        };

        var dialog = await DialogService.ShowAsync<AddPlayerDialog>("Adicionar Jogador", parameters);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadLeague();
            Snackbar.Add("Jogador adicionado!", Severity.Success);
        }
    }

    private void EditPlayer(Guid playerId)
    {
        Navigation.NavigateTo($"/jogadores/{playerId}/editar");
    }

    private async Task DeletePlayer(PlayerDto player)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirmar Exclusao",
            $"Deseja realmente excluir o jogador {player.Name}?",
            yesText: "Excluir",
            cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                await PlayerService.DeletePlayerAsync(player.Id);
                await LoadLeague();
                Snackbar.Add("Jogador excluido!", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DuplicateTournament(Guid tournamentId)
    {
        try
        {
            var newTournament = await TournamentService.DuplicateTournamentAsync(tournamentId, LeagueId);
            if (newTournament != null)
            {
                _tournaments = await TournamentService.GetTournamentsByLeagueAsync(LeagueId);
                Snackbar.Add("Torneio copiado com sucesso!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Erro ao copiar torneio", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
    }
}
