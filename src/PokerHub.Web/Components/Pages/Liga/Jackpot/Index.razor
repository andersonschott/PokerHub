@page "/ligas/{LeagueId:guid}/jackpot"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IJackpotService JackpotService
@inject ILeagueService LeagueService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Caixinha - @(_league?.Name ?? "PokerHub")</PageTitle>

<div class="jackpot-page">
    @if (_loading)
    {
        <div class="loading-container">
            <MudProgressCircular Color="Color.Warning" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-3">Carregando caixinha...</MudText>
        </div>
    }
    else if (_league == null)
    {
        <div class="error-container">
            <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Color="Color.Error" />
            <MudText Typo="Typo.h6" Class="mt-3">Liga nao encontrada</MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Class="mt-4" Href="/">
                Voltar
            </MudButton>
        </div>
    }
    else
    {
        @* ===== HEADER ===== *@
        <div class="page-header">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                           Color="Color.Default"
                           OnClick="@(() => Navigation.NavigateTo($"/ligas/{LeagueId}"))" />
            <div class="page-title">
                <h1>Caixinha</h1>
                <span class="subtitle">@_league.Name</span>
            </div>
            @if (_isOrganizer)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Settings"
                               Color="Color.Default"
                               OnClick="OpenSettingsDialog"
                               Class="desktop-only" />
            }
        </div>

        @* ===== HERO CARD ===== *@
        <div class="jackpot-hero">
            <div class="jackpot-icon">üí∞</div>
            <div class="jackpot-label">Saldo Acumulado</div>
            <div class="jackpot-value">@_jackpotStatus?.AccumulatedPrizePool.ToString("C")</div>
            <div class="jackpot-config">
                <span>‚öôÔ∏è</span>
                <span>Percentual:</span>
                <span class="percent">@_jackpotStatus?.JackpotPercentage.ToString("F0")%</span>
                <span>do prize pool</span>
            </div>
        </div>

        @* ===== QUICK STATS ===== *@
        <div class="quick-stats">
            <div class="quick-stat">
                <div class="quick-stat-value stat-positive">+@_totalEntries.ToString("C0")</div>
                <div class="quick-stat-label">Total Entradas</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-value stat-negative">-@_totalExits.ToString("C0")</div>
                <div class="quick-stat-label">Total Saidas</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-value">@_contributions.Count</div>
                <div class="quick-stat-label">Torneios</div>
            </div>
        </div>

        @* ===== TABS ===== *@
        <div class="tabs">
            <div class="tab @(_activeTab == 0 ? "active entries" : "")" @onclick="@(() => _activeTab = 0)">
                <span>üìà</span>
                <span>Entradas</span>
                <span class="tab-badge">@_contributions.Count</span>
            </div>
            <div class="tab @(_activeTab == 1 ? "active exits" : "")" @onclick="@(() => _activeTab = 1)">
                <span>üìâ</span>
                <span>Saidas</span>
                <span class="tab-badge">@_usages.Count</span>
            </div>
        </div>

        @* ===== TAB CONTENT ===== *@
        @if (_activeTab == 0)
        {
            @* ENTRADAS *@
            @if (_contributions.Count == 0)
            {
                <div class="empty-state">
                    <div class="empty-icon">üìà</div>
                    <div class="empty-title">Nenhuma entrada ainda</div>
                    <div class="empty-text">Quando torneios forem finalizados, as contribuicoes aparecerao aqui.</div>
                </div>
            }
            else
            {
                @* Mobile: Cards *@
                <div class="transaction-list mobile-only">
                    @foreach (var contribution in _contributions)
                    {
                        <div class="transaction-item" @onclick="@(() => NavigateToTournament(contribution.TournamentId))">
                            <div class="transaction-header">
                                <div>
                                    <div class="transaction-title">@contribution.TournamentName</div>
                                    <div class="transaction-date">@contribution.TournamentDate.ToString("dd/MM/yyyy")</div>
                                </div>
                                <div class="transaction-amount positive">+@contribution.Amount.ToString("C")</div>
                            </div>
                            <div class="transaction-details">
                                <div class="transaction-detail">
                                    <span class="label">Prize Pool:</span>
                                    <span>@contribution.TournamentPrizePool.ToString("C0")</span>
                                </div>
                                <div class="transaction-detail">
                                    <span class="label">%:</span>
                                    <span>@contribution.PercentageApplied.ToString("F0")%</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                @* Desktop: Table *@
                <div class="history-table desktop-only">
                    <MudTable Items="@_contributions" Hover="true" Dense="true" Elevation="0" Class="jackpot-table">
                        <HeaderContent>
                            <MudTh>Torneio</MudTh>
                            <MudTh Style="text-align: right;">Prize Pool</MudTh>
                            <MudTh Style="text-align: center;">%</MudTh>
                            <MudTh Style="text-align: right;">Valor</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Torneio">
                                <div>
                                    <MudLink Href="@($"/torneio/{context.TournamentId}")" Color="Color.Success">
                                        @context.TournamentName
                                    </MudLink>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @context.TournamentDate.ToString("dd/MM/yyyy")
                                    </MudText>
                                </div>
                            </MudTd>
                            <MudTd DataLabel="Prize Pool" Style="text-align: right;">
                                <span class="mono-font">@context.TournamentPrizePool.ToString("C")</span>
                            </MudTd>
                            <MudTd DataLabel="%" Style="text-align: center;">
                                <span class="mono-font">@context.PercentageApplied.ToString("F0")%</span>
                            </MudTd>
                            <MudTd DataLabel="Valor" Style="text-align: right;">
                                <span class="mono-font positive">+@context.Amount.ToString("C")</span>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </div>
            }
        }
        else
        {
            @* SAIDAS *@
            @if (_usages.Count == 0)
            {
                <div class="empty-state">
                    <div class="empty-icon">üìâ</div>
                    <div class="empty-title">Nenhuma saida ainda</div>
                    <div class="empty-text">Quando a caixinha for utilizada, os registros aparecerao aqui.</div>
                </div>
            }
            else
            {
                @* Mobile: Cards *@
                <div class="transaction-list mobile-only">
                    @foreach (var usage in _usages)
                    {
                        <div class="exit-item">
                            <div class="transaction-header">
                                <div>
                                    <div class="transaction-title">@(usage.Description ?? "Uso da Caixinha")</div>
                                    <div class="transaction-date">@usage.CreatedAt.ToString("dd/MM/yyyy")</div>
                                </div>
                                <div class="transaction-amount negative">-@usage.Amount.ToString("C")</div>
                            </div>
                            <div class="transaction-details">
                                <div class="transaction-detail">
                                    <span class="label">Saldo apos:</span>
                                    <span>@usage.BalanceAfter.ToString("C")</span>
                                </div>
                            </div>
                            <div class="exit-reason @GetUsageTypeClass(usage.Description)">
                                @GetUsageTypeIcon(usage.Description) @GetUsageTypeLabel(usage.Description)
                            </div>
                        </div>
                    }
                </div>

                @* Desktop: Table *@
                <div class="history-table desktop-only">
                    <MudTable Items="@_usages" Hover="true" Dense="true" Elevation="0" Class="jackpot-table">
                        <HeaderContent>
                            <MudTh>Descricao</MudTh>
                            <MudTh>Data</MudTh>
                            <MudTh>Tipo</MudTh>
                            <MudTh Style="text-align: right;">Valor</MudTh>
                            <MudTh Style="text-align: right;">Saldo Apos</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Descricao">
                                <MudText Typo="Typo.body2">@(context.Description ?? "Uso da Caixinha")</MudText>
                            </MudTd>
                            <MudTd DataLabel="Data">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @context.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Tipo">
                                <MudChip T="string" Size="Size.Small"
                                         Color="@GetUsageTypeColor(context.Description)"
                                         Variant="Variant.Filled">
                                    @GetUsageTypeLabel(context.Description)
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Valor" Style="text-align: right;">
                                <span class="mono-font negative">-@context.Amount.ToString("C")</span>
                            </MudTd>
                            <MudTd DataLabel="Saldo Apos" Style="text-align: right;">
                                <span class="mono-font">@context.BalanceAfter.ToString("C")</span>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </div>
            }

            @* Action Buttons (Organizador) *@
            @if (_isOrganizer && _jackpotStatus?.AccumulatedPrizePool > 0)
            {
                <div class="action-buttons">
                    <MudButton Variant="Variant.Filled"
                               Class="action-btn-tournament"
                               StartIcon="@Icons.Material.Filled.EmojiEvents"
                               OnClick="OpenUseTournamentDialog"
                               FullWidth="true">
                        Usar em Torneio
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Default"
                               StartIcon="@Icons.Material.Filled.ShoppingCart"
                               OnClick="OpenExpenseDialog"
                               FullWidth="true">
                        Registrar Gasto
                    </MudButton>
                </div>
            }
        }

        @* ===== INFO CARD ===== *@
        <div class="info-card">
            <div class="info-icon">‚ÑπÔ∏è</div>
            <div class="info-content">
                <div class="info-title">Como funciona?</div>
                <div class="info-text">
                    A caixinha acumula @_jackpotStatus?.JackpotPercentage.ToString("F0")% de cada prize pool.
                    @if (_isOrganizer)
                    {
                        <text>Use para torneios especiais ou gastos da liga (baralhos, fichas, sistema, etc).</text>
                    }
                    else
                    {
                        <text>O organizador pode usar para torneios especiais ou gastos da liga.</text>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public Guid LeagueId { get; set; }

    private LeagueDto? _league;
    private JackpotStatusDto? _jackpotStatus;
    private List<JackpotContributionDto> _contributions = new();
    private List<JackpotUsageDto> _usages = new();
    private bool _loading = true;
    private bool _isOrganizer;
    private string? _currentUserId;
    private int _activeTab = 0;
    private decimal _totalEntries => _contributions.Sum(c => c.Amount);
    private decimal _totalExits => _usages.Sum(u => u.Amount);

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            _league = await LeagueService.GetLeagueByIdAsync(LeagueId);
            if (_league != null)
            {
                if (!string.IsNullOrEmpty(_currentUserId))
                {
                    _isOrganizer = await LeagueService.IsUserOrganizerAsync(LeagueId, _currentUserId);
                }

                _jackpotStatus = await JackpotService.GetJackpotStatusAsync(LeagueId);
                _contributions = (await JackpotService.GetContributionHistoryAsync(LeagueId)).ToList();
                _usages = (await JackpotService.GetUsageHistoryAsync(LeagueId)).ToList();
            }
        }
        finally
        {
            _loading = false;
        }
    }

    private void NavigateToTournament(Guid tournamentId)
    {
        Navigation.NavigateTo($"/torneio/{tournamentId}");
    }

    private async Task OpenUseTournamentDialog()
    {
        var parameters = new DialogParameters<UseJackpotDialog>
        {
            { x => x.MaxAmount, _jackpotStatus?.AccumulatedPrizePool ?? 0 }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<UseJackpotDialog>("Usar em Torneio Especial", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: UseJackpotDto dto })
        {
            await ProcessUsage(dto);
        }
    }

    private async Task OpenExpenseDialog()
    {
        var parameters = new DialogParameters<UseJackpotDialog>
        {
            { x => x.MaxAmount, _jackpotStatus?.AccumulatedPrizePool ?? 0 }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<UseJackpotDialog>("Registrar Gasto da Liga", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: UseJackpotDto dto })
        {
            await ProcessUsage(dto);
        }
    }

    private async Task OpenSettingsDialog()
    {
        Snackbar.Add("Configuracoes: acesse Editar Liga para alterar o percentual", Severity.Info);
    }

    private async Task ProcessUsage(UseJackpotDto dto)
    {
        try
        {
            await JackpotService.UseJackpotAsync(LeagueId, dto);
            Snackbar.Add($"Caixinha utilizada: {dto.Amount:C}", Severity.Success);
            await LoadData();
            _activeTab = 1; // Switch to exits tab
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
    }

    private string GetUsageTypeClass(string? description)
    {
        if (string.IsNullOrEmpty(description)) return "expense";

        var lower = description.ToLower();
        if (lower.Contains("torneio") || lower.Contains("prize") || lower.Contains("especial"))
            return "tournament";

        return "expense";
    }

    private string GetUsageTypeIcon(string? description)
    {
        var type = GetUsageTypeClass(description);
        return type == "tournament" ? "üèÜ" : "üõí";
    }

    private string GetUsageTypeLabel(string? description)
    {
        var type = GetUsageTypeClass(description);
        return type == "tournament" ? "Torneio Especial" : "Gasto da Liga";
    }

    private Color GetUsageTypeColor(string? description)
    {
        var type = GetUsageTypeClass(description);
        return type == "tournament" ? Color.Secondary : Color.Warning;
    }
}
