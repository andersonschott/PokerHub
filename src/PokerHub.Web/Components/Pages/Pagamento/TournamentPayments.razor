@page "/torneios/{TournamentId:guid}/pagamentos"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IPaymentService PaymentService
@inject ITournamentService TournamentService
@inject ITournamentExpenseService ExpenseService
@inject ILeagueService LeagueService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS

<PageTitle>Pagamentos - PokerHub</PageTitle>

@if (_loading)
{
    <div class="d-flex justify-center align-center pa-8">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </div>
}
else if (_tournament == null)
{
    <MudAlert Severity="Severity.Error">Torneio nao encontrado</MudAlert>
}
else if (_tournament.Status != TournamentStatus.Finished)
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
        <MudAlert Severity="Severity.Info">
            Os pagamentos sao calculados automaticamente apos o termino do torneio.
        </MudAlert>
    </MudContainer>
}
else
{
    <ResponsiveLayout>
        <Mobile>
            @* ===== VERSÃO MOBILE ===== *@
            <MobilePageLayout HasFab="@(_isOrganizer && (_payments == null || !_payments.Any()))">
                <Header>
                    <MudAppBar Fixed="true" Dense="true" Elevation="1" Class="mobile-appbar">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Inherit"
                                       OnClick="@(() => Navigation.NavigateTo($"/torneios/{TournamentId}"))" />
                        <div class="d-flex flex-column ml-2">
                            <MudText Typo="Typo.subtitle1" Class="font-weight-bold">Pagamentos</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@_tournament.Name</MudText>
                        </div>
                        <MudSpacer />
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit">
                            <MudMenuItem Icon="@Icons.Material.Filled.Share">Compartilhar</MudMenuItem>
                            @if (_isOrganizer)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.NotificationsActive">Cobrar Todos</MudMenuItem>
                            }
                        </MudMenu>
                    </MudAppBar>
                </Header>

                <ChildContent>
                    <div class="pa-3">
                        @* Card Resumo Fixo *@
                        <MudPaper Class="pa-3 mb-3" Elevation="1">
                            <div class="d-flex justify-space-around mb-2">
                                <div class="text-center">
                                    <MudText Typo="Typo.h5" Color="Color.Success" Class="font-weight-bold">
                                        R$ @GetTotalToReceive().ToString("N0")
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">A Receber</MudText>
                                </div>
                                <MudDivider Vertical="true" FlexItem="true" Class="mx-2" />
                                <div class="text-center">
                                    <MudText Typo="Typo.h5" Color="Color.Warning" Class="font-weight-bold">
                                        @GetPendingCount()
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Pendentes</MudText>
                                </div>
                                <MudDivider Vertical="true" FlexItem="true" Class="mx-2" />
                                <div class="text-center">
                                    <MudText Typo="Typo.h5" Color="Color.Success" Class="font-weight-bold">
                                        @GetConfirmedCount()
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Confirmados</MudText>
                                </div>
                            </div>
                            @if (_payments != null && _payments.Any())
                            {
                                <MudProgressLinear Color="Color.Success" Rounded="true" Size="Size.Medium"
                                                   Value="@GetProgressPercent()" Class="mt-2" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center" Class="mt-1">
                                    @GetProgressPercent().ToString("N0")% concluído
                                </MudText>
                            }
                        </MudPaper>

                        @* Tabs Mobile *@
                        <MudChipSet T="string" @bind-SelectedValue="_mobileTab" Class="mb-3">
                            <MudChip T="string" Value="@("saldo")" Variant="@(_mobileTab == "saldo" ? Variant.Filled : Variant.Outlined)">
                                Saldo
                            </MudChip>
                            <MudChip T="string" Value="@("pagamentos")" Variant="@(_mobileTab == "pagamentos" ? Variant.Filled : Variant.Outlined)">
                                Pagamentos
                                @if (GetPendingCount() > 0)
                                {
                                    <MudBadge Content="@GetPendingCount()" Color="Color.Warning" Overlap="true" Class="ml-2" />
                                }
                            </MudChip>
                        </MudChipSet>

                        @if (_mobileTab == "saldo")
                        {
                            @* Tab Saldo *@
                            @if (_balances != null && _balances.Any())
                            {
                                <div class="d-flex flex-column gap-2">
                                    @foreach (var balance in _balances.OrderByDescending(b => b.Balance))
                                    {
                                        <MudCard Elevation="1">
                                            <MudCardContent Class="pa-3">
                                                <div class="d-flex align-center gap-3">
                                                    <MudAvatar Color="Color.Primary" Size="Size.Medium">
                                                        @balance.PlayerName[0]
                                                    </MudAvatar>
                                                    <div class="flex-grow-1">
                                                        <MudText Class="font-weight-medium">@balance.PlayerName</MudText>
                                                        <div class="d-flex gap-3">
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                                Inv: R$ @balance.TotalInvestment.ToString("N0")
                                                            </MudText>
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                                Prêmio: R$ @balance.Prize.ToString("N0")
                                                            </MudText>
                                                        </div>
                                                    </div>
                                                    <MudText Class="font-weight-bold"
                                                             Color="@(balance.Balance >= 0 ? Color.Success : Color.Error)">
                                                        @(balance.Balance >= 0 ? "+" : "")R$ @balance.Balance.ToString("N0")
                                                    </MudText>
                                                </div>
                                            </MudCardContent>
                                        </MudCard>
                                    }
                                </div>

                                @if (_jackpotContribution > 0)
                                {
                                    <MudPaper Class="pa-3 mt-3" Elevation="1"
                                              Style="background: rgba(255, 193, 7, 0.1);">
                                        <div class="d-flex justify-space-between align-center">
                                            <div class="d-flex align-center gap-2">
                                                <MudIcon Icon="@Icons.Material.Filled.Savings" Color="Color.Warning" />
                                                <MudText>Caixinha</MudText>
                                            </div>
                                            <MudText Typo="Typo.h6" Color="Color.Warning" Class="font-weight-bold">
                                                R$ @_jackpotContribution.ToString("N0")
                                            </MudText>
                                        </div>
                                    </MudPaper>
                                }

                                <MudPaper Class="pa-3 mt-3" Elevation="1"
                                          Style="background: rgba(76, 175, 80, 0.1);">
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText Class="font-weight-bold">Total Prize Pool</MudText>
                                        <MudText Typo="Typo.h6" Class="font-weight-bold">
                                            R$ @(_balances.Sum(b => b.TotalInvestment).ToString("N0"))
                                        </MudText>
                                    </div>
                                </MudPaper>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Dense="true">
                                    Nenhum saldo disponível.
                                </MudAlert>
                            }
                        }
                        else
                        {
                            @* Tab Pagamentos *@
                            @* Filtros horizontais *@
                            <div class="horizontal-scroll mb-3">
                                <MudChipSet T="string" @bind-SelectedValue="_paymentFilter" Class="d-flex flex-nowrap">
                                    <MudChip T="string" Value="@("todos")" Size="Size.Small"
                                             Variant="@(_paymentFilter == "todos" ? Variant.Filled : Variant.Outlined)">
                                        Todos
                                    </MudChip>
                                    <MudChip T="string" Value="@("pendente")" Size="Size.Small" Color="Color.Warning"
                                             Variant="@(_paymentFilter == "pendente" ? Variant.Filled : Variant.Outlined)">
                                        Pendentes (@GetPendingCount())
                                    </MudChip>
                                    <MudChip T="string" Value="@("confirmado")" Size="Size.Small" Color="Color.Success"
                                             Variant="@(_paymentFilter == "confirmado" ? Variant.Filled : Variant.Outlined)">
                                        Confirmados (@GetConfirmedCount())
                                    </MudChip>
                                </MudChipSet>
                            </div>

                            @if (_payments == null || !FilteredPayments.Any())
                            {
                                <MudAlert Severity="Severity.Info" Dense="true">
                                    Nenhum pagamento encontrado.
                                </MudAlert>
                            }
                            else
                            {
                                <div class="d-flex flex-column gap-2">
                                    @foreach (var payment in FilteredPayments)
                                    {
                                        var statusClass = payment.Status switch
                                        {
                                            PaymentStatus.Pending => "status-bar-warning",
                                            PaymentStatus.Paid => "status-bar-info",
                                            PaymentStatus.Confirmed => "status-bar-success",
                                            _ => ""
                                        };

                                        <MudCard Class="card-with-indicator" Elevation="1"
                                                 Style="position: relative; overflow: hidden;">
                                            <div class="status-bar @statusClass"></div>
                                            <MudCardContent Class="pa-3 pl-4">
                                                @* Fluxo visual: De -> Para *@
                                                <div class="d-flex align-center gap-2 mb-2">
                                                    <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                                        @payment.FromPlayerName[0]
                                                    </MudAvatar>
                                                    <MudText Typo="Typo.body2">@payment.FromPlayerName</MudText>
                                                    <MudIcon Icon="@Icons.Material.Filled.ArrowForward"
                                                             Size="Size.Small" Color="Color.Secondary" />
                                                    @if (payment.IsJackpotContribution)
                                                    {
                                                        <MudIcon Icon="@Icons.Material.Filled.Savings" Color="Color.Warning" Size="Size.Small" />
                                                        <MudText Typo="Typo.body2" Color="Color.Warning" Class="font-weight-medium">
                                                            Caixinha
                                                        </MudText>
                                                    }
                                                    else
                                                    {
                                                        <MudAvatar Size="Size.Small" Color="Color.Primary">
                                                            @payment.ToPlayerName[0]
                                                        </MudAvatar>
                                                        <MudText Typo="Typo.body2">@payment.ToPlayerName</MudText>
                                                    }
                                                </div>

                                                <div class="d-flex justify-space-between align-center">
                                                    <MudText Typo="Typo.h6" Class="font-weight-bold"
                                                             Color="@(payment.IsJackpotContribution ? Color.Warning : Color.Default)">
                                                        R$ @payment.Amount.ToString("N0")
                                                    </MudText>

                                                    <div class="d-flex align-center gap-2">
                                                        @if (!payment.IsJackpotContribution && !string.IsNullOrEmpty(payment.ToPlayerPixKey))
                                                        {
                                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary"
                                                                     OnClick="@(() => CopyToClipboard(payment.ToPlayerPixKey))">
                                                                @GetPixTypeText(payment.ToPlayerPixKeyType)
                                                                <MudIcon Icon="@Icons.Material.Filled.ContentCopy"
                                                                         Size="Size.Small" Class="ml-1" />
                                                            </MudChip>
                                                        }

                                                        @if (_isOrganizer && payment.Status == PaymentStatus.Pending)
                                                        {
                                                            <MudButton Size="Size.Small" Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       OnClick="@(() => AdminMarkPaid(payment.Id))"
                                                                       Disabled="_processingPayment == payment.Id">
                                                                PAGO
                                                            </MudButton>
                                                        }
                                                        else if (_isOrganizer && payment.Status == PaymentStatus.Paid)
                                                        {
                                                            <MudButton Size="Size.Small" Variant="Variant.Outlined"
                                                                       Color="Color.Success"
                                                                       OnClick="@(() => AdminConfirm(payment.Id))"
                                                                       Disabled="_processingPayment == payment.Id">
                                                                Confirmar
                                                            </MudButton>
                                                        }
                                                        else if (payment.Status == PaymentStatus.Confirmed)
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />
                                                        }
                                                    </div>
                                                </div>
                                            </MudCardContent>
                                        </MudCard>
                                    }
                                </div>
                            }
                        }
                    </div>

                    @* FAB para calcular pagamentos *@
                    @if (_isOrganizer && (_payments == null || !_payments.Any()))
                    {
                        <MudFab Class="mobile-fab"
                                Color="Color.Primary"
                                StartIcon="@Icons.Material.Filled.Calculate"
                                OnClick="CalculatePayments"
                                Disabled="_processing" />
                    }
                </ChildContent>

                <BottomNav>
                    <BottomNavigation Items="@GetBottomNavItems()" OnItemClick="OnBottomNavClick" />
                </BottomNav>
            </MobilePageLayout>
        </Mobile>

        <Desktop>
            @* ===== VERSÃO DESKTOP ===== *@
            <MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
                <MudBreadcrumbs Items="_breadcrumbs" Class="pa-0 mb-2">
                    <ItemTemplate Context="item">
                        <MudLink Href="@item.Href" Color="@(item.Disabled ? Color.Default : Color.Primary)">
                            @item.Text
                        </MudLink>
                    </ItemTemplate>
                </MudBreadcrumbs>

                <div class="d-flex justify-space-between align-center mb-4">
                    <div>
                        <MudText Typo="Typo.h4" Class="font-weight-bold">Pagamentos</MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">@_tournament.Name</MudText>
                    </div>
                    <div class="d-flex gap-2">
                        <MudButton Variant="Variant.Outlined" Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.Share">
                            Compartilhar
                        </MudButton>
                        @if (_isOrganizer && (_payments == null || !_payments.Any()))
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Calculate"
                                       OnClick="CalculatePayments" Disabled="_processing">
                                @if (_processing)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                }
                                Calcular Pagamentos
                            </MudButton>
                        }
                        else if (_isOrganizer)
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.NotificationsActive">
                                Cobrar Todos
                            </MudButton>
                        }
                    </div>
                </div>

                <MudGrid>
                    @* Coluna principal (8 colunas) *@
                    <MudItem xs="12" lg="8">
                        @* Card Saldo do Torneio *@
                        @if (_balances != null && _balances.Any())
                        {
                            <MudPaper Class="pa-4 mb-4" Elevation="1">
                                <div class="d-flex justify-space-between align-center mb-3">
                                    <MudText Typo="Typo.h6" Class="font-weight-bold">Saldo do Torneio</MudText>
                                    <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Outlined">
                                        @_balances.Count jogadores
                                    </MudChip>
                                </div>

                                <MudTable Items="@_balances" Hover="true" Elevation="0" Dense="true">
                                    <HeaderContent>
                                        <MudTh>Jogador</MudTh>
                                        <MudTh Style="text-align: right;">Investimento</MudTh>
                                        <MudTh Style="text-align: right;">Prêmio</MudTh>
                                        <MudTh Style="text-align: right;">Saldo</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="Jogador">
                                            <div class="d-flex align-center gap-2">
                                                <MudAvatar Size="Size.Small" Color="Color.Primary">
                                                    @context.PlayerName[0]
                                                </MudAvatar>
                                                <MudText>@context.PlayerName</MudText>
                                            </div>
                                        </MudTd>
                                        <MudTd DataLabel="Investimento" Style="text-align: right;">
                                            <MudText Typo="Typo.body2">R$ @context.TotalInvestment.ToString("N0")</MudText>
                                        </MudTd>
                                        <MudTd DataLabel="Prêmio" Style="text-align: right;">
                                            <MudText Typo="Typo.body2">R$ @context.Prize.ToString("N0")</MudText>
                                        </MudTd>
                                        <MudTd DataLabel="Saldo" Style="text-align: right;">
                                            <MudText Typo="Typo.body2" Class="font-weight-bold"
                                                     Color="@(context.Balance >= 0 ? Color.Success : Color.Error)">
                                                @(context.Balance >= 0 ? "+" : "")R$ @context.Balance.ToString("N0")
                                            </MudText>
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>

                                <MudDivider Class="my-3" />

                                <div class="d-flex flex-column gap-2">
                                    @if (_jackpotContribution > 0)
                                    {
                                        <div class="d-flex justify-space-between align-center">
                                            <div class="d-flex align-center gap-2">
                                                <MudIcon Icon="@Icons.Material.Filled.Savings" Color="Color.Warning" Size="Size.Small" />
                                                <MudText Typo="Typo.body2">Contribuição para Caixinha</MudText>
                                            </div>
                                            <MudText Typo="Typo.body1" Color="Color.Warning" Class="font-weight-bold">
                                                R$ @_jackpotContribution.ToString("N0")
                                            </MudText>
                                        </div>
                                    }
                                    <div class="d-flex justify-space-between align-center pa-2 rounded"
                                         Style="background: rgba(76,175,80,0.1);">
                                        <MudText Typo="Typo.body1" Class="font-weight-bold">Total Prize Pool</MudText>
                                        <MudText Typo="Typo.h6" Class="font-weight-bold">
                                            R$ @_balances.Sum(b => b.TotalInvestment).ToString("N0")
                                        </MudText>
                                    </div>
                                </div>
                            </MudPaper>
                        }

                        @* Card Lista de Pagamentos *@
                        @if (_payments != null && _payments.Any())
                        {
                            <MudPaper Class="pa-4" Elevation="1">
                                <div class="d-flex justify-space-between align-center mb-3">
                                    <MudText Typo="Typo.h6" Class="font-weight-bold">Lista de Pagamentos</MudText>
                                    <div class="d-flex gap-2">
                                        <MudChip T="string" Color="Color.Warning" Size="Size.Small"
                                                 Variant="@(_paymentFilter == "pendente" ? Variant.Filled : Variant.Outlined)"
                                                 OnClick="@(() => _paymentFilter = _paymentFilter == "pendente" ? "todos" : "pendente")">
                                            @GetPendingCount() Pendentes
                                        </MudChip>
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small"
                                                 Variant="@(_paymentFilter == "confirmado" ? Variant.Filled : Variant.Outlined)"
                                                 OnClick="@(() => _paymentFilter = _paymentFilter == "confirmado" ? "todos" : "confirmado")">
                                            @GetConfirmedCount() Confirmados
                                        </MudChip>
                                    </div>
                                </div>

                                <MudTable Items="@FilteredPayments" Hover="true" Elevation="0" Breakpoint="Breakpoint.None">
                                    <HeaderContent>
                                        <MudTh>De</MudTh>
                                        <MudTh>Para</MudTh>
                                        <MudTh Style="text-align: right;">Valor</MudTh>
                                        <MudTh>PIX</MudTh>
                                        <MudTh Style="text-align: center;">Status</MudTh>
                                        @if (_isOrganizer)
                                        {
                                            <MudTh Style="text-align: center;">Ações</MudTh>
                                        }
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="De">
                                            <div class="d-flex align-center gap-2">
                                                <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                                    @context.FromPlayerName[0]
                                                </MudAvatar>
                                                <MudText>@context.FromPlayerName</MudText>
                                            </div>
                                        </MudTd>
                                        <MudTd DataLabel="Para">
                                            @if (context.IsJackpotContribution)
                                            {
                                                <div class="d-flex align-center gap-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Savings" Color="Color.Warning" Size="Size.Small" />
                                                    <MudText Color="Color.Warning" Class="font-weight-medium">Caixinha</MudText>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="d-flex align-center gap-2">
                                                    <MudAvatar Size="Size.Small" Color="Color.Primary">
                                                        @context.ToPlayerName[0]
                                                    </MudAvatar>
                                                    <MudText>@context.ToPlayerName</MudText>
                                                </div>
                                            }
                                        </MudTd>
                                        <MudTd DataLabel="Valor" Style="text-align: right;">
                                            <MudText Typo="Typo.body1" Class="font-weight-bold"
                                                     Color="@(context.IsJackpotContribution ? Color.Warning : Color.Default)">
                                                R$ @context.Amount.ToString("N0")
                                            </MudText>
                                        </MudTd>
                                        <MudTd DataLabel="PIX">
                                            @if (!string.IsNullOrEmpty(context.ToPlayerPixKey))
                                            {
                                                <div class="d-flex align-center gap-1">
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                                        @GetPixTypeText(context.ToPlayerPixKeyType)
                                                    </MudChip>
                                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                                                   OnClick="@(() => CopyToClipboard(context.ToPlayerPixKey))" Color="Color.Default" />
                                                </div>
                                            }
                                            else if (context.IsJackpotContribution)
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Warning">Pote Acumulado</MudText>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Sem PIX</MudText>
                                            }
                                        </MudTd>
                                        <MudTd DataLabel="Status" Style="text-align: center;">
                                            <MudChip T="string" Size="Size.Small"
                                                     Color="@GetStatusColor(context.Status)"
                                                     Variant="Variant.Filled">
                                                @GetStatusText(context.Status)
                                            </MudChip>
                                        </MudTd>
                                        @if (_isOrganizer)
                                        {
                                            <MudTd DataLabel="Ações" Style="text-align: center;">
                                                @if (context.Status == PaymentStatus.Pending)
                                                {
                                                    <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Success"
                                                               OnClick="@(() => AdminMarkPaid(context.Id))"
                                                               Disabled="_processingPayment == context.Id">
                                                        PAGO
                                                    </MudButton>
                                                }
                                                else if (context.Status == PaymentStatus.Paid)
                                                {
                                                    <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Success"
                                                               OnClick="@(() => AdminConfirm(context.Id))"
                                                               Disabled="_processingPayment == context.Id">
                                                        Confirmar
                                                    </MudButton>
                                                }
                                                else
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />
                                                }
                                            </MudTd>
                                        }
                                    </RowTemplate>
                                </MudTable>
                            </MudPaper>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">
                                Nenhum pagamento calculado. Clique em "Calcular Pagamentos" para gerar os pagamentos.
                            </MudAlert>
                        }
                    </MudItem>

                    @* Coluna lateral (4 colunas) *@
                    <MudItem xs="12" lg="4">
                        @* Card Resumo *@
                        <MudPaper Class="pa-4 mb-4" Elevation="1">
                            <MudText Typo="Typo.h6" Class="font-weight-bold mb-3">Resumo</MudText>

                            <div class="d-flex flex-column gap-3">
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Color="Color.Secondary">Total a receber</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Success" Class="font-weight-bold">
                                        R$ @GetTotalToReceive().ToString("N0")
                                    </MudText>
                                </div>
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Color="Color.Secondary">Pagamentos pendentes</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Warning" Class="font-weight-bold">
                                        @GetPendingCount()
                                    </MudText>
                                </div>
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Color="Color.Secondary">Pagamentos confirmados</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Success" Class="font-weight-bold">
                                        @GetConfirmedCount()
                                    </MudText>
                                </div>
                            </div>

                            @if (_payments != null && _payments.Any())
                            {
                                <MudDivider Class="my-3" />
                                <MudProgressLinear Color="Color.Success" Rounded="true" Size="Size.Large"
                                                   Value="@GetProgressPercent()" Class="mb-2" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                                    @GetProgressPercent().ToString("N0")% concluído
                                </MudText>
                            }
                        </MudPaper>

                        @* Card Ações Rápidas *@
                        <MudPaper Class="pa-4" Elevation="1">
                            <MudText Typo="Typo.h6" Class="font-weight-bold mb-3">Ações Rápidas</MudText>

                            <div class="d-flex flex-column gap-2">
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.Send">
                                    Enviar Lembrete
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Default" FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.Download">
                                    Exportar Relatório
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Default" FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.History"
                                           Href="@($"/torneios/{TournamentId}")">
                                    Ver Torneio
                                </MudButton>
                            </div>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudContainer>
        </Desktop>
    </ResponsiveLayout>
}

@code {
    [Parameter] public Guid TournamentId { get; set; }

    private TournamentDto? _tournament;
    private IReadOnlyList<PaymentDto>? _payments;
    private IReadOnlyList<PlayerBalanceDto>? _balances;
    private IReadOnlyList<ExpenseSummaryDto>? _expenseSummary;
    private decimal _jackpotContribution;
    private bool _loading = true;
    private bool _processing;
    private Guid? _processingPayment;
    private bool _isOrganizer;
    private string? _currentUserId;
    private List<BreadcrumbItem> _breadcrumbs = new();

    // Mobile state
    private string _mobileTab = "pagamentos";
    private string _paymentFilter = "todos";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _tournament = await TournamentService.GetTournamentByIdAsync(TournamentId);

        if (_tournament != null)
        {
            _breadcrumbs = new List<BreadcrumbItem>
            {
                new("Torneios", "/torneios", false),
                new(_tournament.Name, $"/torneios/{TournamentId}", false),
                new("Pagamentos", null, true)
            };

            if (!string.IsNullOrEmpty(_currentUserId))
            {
                _isOrganizer = await LeagueService.IsUserOrganizerAsync(_tournament.LeagueId, _currentUserId);
            }

            if (_tournament.Status == TournamentStatus.Finished)
            {
                _payments = await PaymentService.GetPaymentsByTournamentAsync(TournamentId);
                _balances = await PaymentService.GetTournamentPlayerBalancesAsync(TournamentId);
                _expenseSummary = await ExpenseService.GetExpenseSummaryByTournamentAsync(TournamentId);
                _jackpotContribution = await PaymentService.GetJackpotContributionAsync(TournamentId);
            }
        }
        _loading = false;
    }

    // Mobile helpers
    private List<BottomNavigation.NavItem> GetBottomNavItems() => new()
    {
        new("saldo", "Saldo", Icons.Material.Filled.AccountBalance, IsActive: _mobileTab == "saldo"),
        new("pagamentos", "Pagamentos", Icons.Material.Filled.Payment, IsActive: _mobileTab == "pagamentos", Badge: GetPendingCount()),
        new("torneio", "Torneio", Icons.Material.Filled.EmojiEvents, Href: $"/torneios/{TournamentId}")
    };

    private void OnBottomNavClick(string key)
    {
        if (key == "saldo" || key == "pagamentos")
        {
            _mobileTab = key;
            StateHasChanged();
        }
    }

    private IEnumerable<PaymentDto> FilteredPayments => _paymentFilter switch
    {
        "pendente" => _payments?.Where(p => p.Status == PaymentStatus.Pending) ?? Enumerable.Empty<PaymentDto>(),
        "confirmado" => _payments?.Where(p => p.Status == PaymentStatus.Confirmed) ?? Enumerable.Empty<PaymentDto>(),
        _ => _payments ?? Enumerable.Empty<PaymentDto>()
    };

    private int GetPendingCount() => _payments?.Count(p => p.Status == PaymentStatus.Pending) ?? 0;
    private int GetConfirmedCount() => _payments?.Count(p => p.Status == PaymentStatus.Confirmed) ?? 0;

    private decimal GetTotalToReceive()
    {
        if (_payments == null || !_payments.Any()) return 0;
        // Simplificação: retorna soma de pendentes
        return _payments.Where(p => p.Status == PaymentStatus.Pending).Sum(p => p.Amount);
    }

    private double GetProgressPercent()
    {
        if (_payments == null || !_payments.Any()) return 0;
        return (GetConfirmedCount() * 100.0) / _payments.Count;
    }

    private async Task CalculatePayments()
    {
        _processing = true;
        try
        {
            _payments = await PaymentService.CalculateAndCreatePaymentsAsync(TournamentId);
            _balances = await PaymentService.GetTournamentPlayerBalancesAsync(TournamentId);
            Snackbar.Add("Pagamentos calculados com sucesso!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao calcular pagamentos: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private string GetPixTypeText(PixKeyType? type) => type switch
    {
        PixKeyType.CPF => "CPF",
        PixKeyType.Email => "Email",
        PixKeyType.Phone => "Telefone",
        PixKeyType.Random => "Aleatória",
        _ => "PIX"
    };

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            Snackbar.Add("Chave PIX copiada!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Erro ao copiar", Severity.Error);
        }
    }

    private Color GetStatusColor(PaymentStatus status) => status switch
    {
        PaymentStatus.Pending => Color.Warning,
        PaymentStatus.Paid => Color.Info,
        PaymentStatus.Confirmed => Color.Success,
        _ => Color.Default
    };

    private string GetStatusText(PaymentStatus status) => status switch
    {
        PaymentStatus.Pending => "Pendente",
        PaymentStatus.Paid => "Pago",
        PaymentStatus.Confirmed => "Confirmado",
        _ => status.ToString()
    };

    private async Task AdminMarkPaid(Guid paymentId)
    {
        if (string.IsNullOrEmpty(_currentUserId)) return;

        var confirmed = await DialogService.ShowMessageBox(
            "Confirmar Pagamento",
            "Deseja marcar este pagamento como pago?",
            yesText: "Sim", cancelText: "Cancelar");

        if (confirmed != true) return;

        _processingPayment = paymentId;
        try
        {
            var success = await PaymentService.AdminMarkAsPaidAsync(paymentId, _currentUserId);
            if (success)
            {
                Snackbar.Add("Pagamento marcado como pago!", Severity.Success);
                _payments = await PaymentService.GetPaymentsByTournamentAsync(TournamentId);
            }
            else
            {
                Snackbar.Add("Erro ao marcar pagamento", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processingPayment = null;
        }
    }

    private async Task AdminConfirm(Guid paymentId)
    {
        if (string.IsNullOrEmpty(_currentUserId)) return;

        var confirmed = await DialogService.ShowMessageBox(
            "Confirmar Recebimento",
            "Deseja confirmar o recebimento deste pagamento?",
            yesText: "Sim", cancelText: "Cancelar");

        if (confirmed != true) return;

        _processingPayment = paymentId;
        try
        {
            var success = await PaymentService.AdminConfirmPaymentAsync(paymentId, _currentUserId);
            if (success)
            {
                Snackbar.Add("Pagamento confirmado!", Severity.Success);
                _payments = await PaymentService.GetPaymentsByTournamentAsync(TournamentId);
            }
            else
            {
                Snackbar.Add("Erro ao confirmar pagamento", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processingPayment = null;
        }
    }
}
