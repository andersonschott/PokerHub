@page "/torneios/{TournamentId:guid}/pagamentos"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IPaymentService PaymentService
@inject ITournamentService TournamentService
@inject ITournamentExpenseService ExpenseService
@inject ILeagueService LeagueService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS

<PageTitle>Pagamentos - PokerHub</PageTitle>

@if (_loading)
{
    <div class="loading-container">
        <MudProgressCircular Color="Color.Success" Size="Size.Large" Indeterminate="true" />
        <MudText Typo="Typo.body1" Class="mt-3">Carregando pagamentos...</MudText>
    </div>
}
else if (_tournament == null)
{
    <MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
        <div class="empty-state">
            <div class="empty-state-icon">
                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Warning" />
            </div>
            <MudText Typo="Typo.h6">Torneio nao encontrado</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                O torneio solicitado nao existe ou foi removido.
            </MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Class="mt-4"
                       OnClick="@(() => Navigation.NavigateTo("/torneios"))">
                Voltar para Torneios
            </MudButton>
        </div>
    </MudContainer>
}
else if (_tournament.Status != TournamentStatus.Finished)
{
    <MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
        <div class="empty-state">
            <div class="empty-state-icon">
                <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Large" Color="Color.Info" />
            </div>
            <MudText Typo="Typo.h6">Torneio em andamento</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                Os pagamentos sao calculados automaticamente apos o termino do torneio.
            </MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Class="mt-4"
                       Href="@($"/torneios/{TournamentId}")">
                Ver Torneio
            </MudButton>
        </div>
    </MudContainer>
}
else
{
    <ResponsiveLayout>
        <Mobile>
            @* ===== VERSAO MOBILE ===== *@
            <div class="mobile-payments-page">
                <div class="pa-3 payments-page">
                    @* Card Resumo *@
                    <div class="summary-card">
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <div class="summary-stat-value positive">
                                    R$ @GetTotalToReceive().ToString("N0")
                                </div>
                                <div class="summary-stat-label">A Receber</div>
                            </div>
                            <div class="summary-divider"></div>
                            <div class="summary-stat">
                                <div class="summary-stat-value warning">
                                    @GetPendingCount()
                                </div>
                                <div class="summary-stat-label">Pendentes</div>
                            </div>
                            <div class="summary-divider"></div>
                            <div class="summary-stat">
                                <div class="summary-stat-value success">
                                    @GetConfirmedCount()
                                </div>
                                <div class="summary-stat-label">Confirmados</div>
                            </div>
                        </div>
                        @if (_payments != null && _payments.Any())
                        {
                            <div class="progress-section">
                                <MudProgressLinear Color="Color.Success" Rounded="true" Size="Size.Medium"
                                                   Value="@GetProgressPercent()" />
                                <div class="progress-text">
                                    @GetProgressPercent().ToString("N0")% concluido
                                </div>
                            </div>
                        }
                    </div>

                    @* Tabs Mobile *@
                    <div class="tabs-container">
                        <MudChipSet T="string" @bind-SelectedValue="_mobileTab">
                            <MudChip T="string" Value="@("saldo")"
                                     Variant="@(_mobileTab == "saldo" ? Variant.Filled : Variant.Outlined)"
                                     Color="Color.Primary">
                                Saldo
                            </MudChip>
                            <MudChip T="string" Value="@("pagamentos")"
                                     Variant="@(_mobileTab == "pagamentos" ? Variant.Filled : Variant.Outlined)"
                                     Color="Color.Primary">
                                Pagamentos
                                @if (GetPendingCount() > 0)
                                {
                                    <MudBadge Content="@GetPendingCount()" Color="Color.Warning" Overlap="true" Class="ml-2" />
                                }
                            </MudChip>
                        </MudChipSet>
                    </div>

                        @if (_mobileTab == "saldo")
                        {
                            @* Tab Saldo *@
                            @if (_balances != null && _balances.Any())
                            {
                                <div class="balance-list">
                                    @foreach (var balance in _balances.OrderByDescending(b => b.Balance))
                                    {
                                        <div class="balance-card">
                                            <div class="balance-avatar">
                                                @GetInitials(balance.PlayerName)
                                            </div>
                                            <div class="balance-info">
                                                <div class="balance-name">@balance.PlayerName</div>
                                                <div class="balance-details">
                                                    <span>Inv: R$ @balance.TotalInvestment.ToString("N0")</span>
                                                    <span>Premio: R$ @balance.Prize.ToString("N0")</span>
                                                </div>
                                            </div>
                                            <div class="balance-amount @(balance.Balance >= 0 ? "positive" : "negative")">
                                                @(balance.Balance >= 0 ? "+" : "")R$ @balance.Balance.ToString("N0")
                                            </div>
                                        </div>
                                    }
                                </div>

                                @if (_jackpotContribution > 0)
                                {
                                    <div class="jackpot-card">
                                        <div class="jackpot-label">
                                            <MudIcon Icon="@Icons.Material.Filled.Savings" Color="Color.Warning" />
                                            <span>Caixinha</span>
                                        </div>
                                        <div class="jackpot-value">
                                            R$ @_jackpotContribution.ToString("N0")
                                        </div>
                                    </div>
                                }

                                <div class="total-card">
                                    <div class="total-label">Total Prize Pool</div>
                                    <div class="total-value">
                                        R$ @(_balances.Sum(b => b.TotalInvestment).ToString("N0"))
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Color="Color.Secondary" />
                                    </div>
                                    <div class="empty-state-text">Nenhum saldo disponivel.</div>
                                </div>
                            }
                        }
                        else
                        {
                            @* Tab Pagamentos *@
                            @* Filtros horizontais *@
                            <div class="filter-scroll">
                                <div class="filter-chips">
                                    <MudChip T="string" Size="Size.Small"
                                             Variant="@(_paymentFilter == "todos" ? Variant.Filled : Variant.Outlined)"
                                             Color="Color.Default"
                                             OnClick="@(() => _paymentFilter = "todos")">
                                        Todos
                                    </MudChip>
                                    <MudChip T="string" Size="Size.Small"
                                             Color="Color.Warning"
                                             Variant="@(_paymentFilter == "pendente" ? Variant.Filled : Variant.Outlined)"
                                             OnClick="@(() => _paymentFilter = "pendente")">
                                        Pendentes (@GetPendingCount())
                                    </MudChip>
                                    <MudChip T="string" Size="Size.Small"
                                             Color="Color.Success"
                                             Variant="@(_paymentFilter == "confirmado" ? Variant.Filled : Variant.Outlined)"
                                             OnClick="@(() => _paymentFilter = "confirmado")">
                                        Confirmados (@GetConfirmedCount())
                                    </MudChip>
                                </div>
                            </div>

                            @if (_payments == null || !FilteredPayments.Any())
                            {
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <MudIcon Icon="@Icons.Material.Filled.Payment" Color="Color.Secondary" />
                                    </div>
                                    <div class="empty-state-text">Nenhum pagamento encontrado.</div>
                                </div>
                            }
                            else
                            {
                                <div class="payment-list">
                                    @foreach (var payment in FilteredPayments)
                                    {
                                        var statusClass = payment.Status switch
                                        {
                                            PaymentStatus.Pending => "pending",
                                            PaymentStatus.Paid => "paid",
                                            PaymentStatus.Confirmed => "confirmed",
                                            _ => ""
                                        };

                                        <div class="payment-card">
                                            <div class="status-indicator @statusClass"></div>
                                            <div class="payment-content">
                                                @* Tipo do pagamento *@
                                                <div class="payment-type">
                                                    @switch (payment.Type)
                                                    {
                                                        case PaymentType.Poker:
                                                            <MudChip T="string" Color="Color.Success" Size="Size.Small">Poker</MudChip>
                                                            break;
                                                        case PaymentType.Expense:
                                                            <MudChip T="string" Color="Color.Warning" Size="Size.Small">@payment.Description</MudChip>
                                                            break;
                                                        case PaymentType.Jackpot:
                                                            <MudChip T="string" Color="Color.Info" Size="Size.Small">Caixinha</MudChip>
                                                            break;
                                                    }
                                                </div>

                                                @* Fluxo visual: De -> Para *@
                                                <div class="payment-flow">
                                                    <div class="payment-player">
                                                        <div class="payment-player-avatar from">
                                                            @GetInitials(payment.FromPlayerName)
                                                        </div>
                                                        <span class="payment-player-name">@payment.FromPlayerName</span>
                                                    </div>
                                                    <MudIcon Icon="@Icons.Material.Filled.ArrowForward"
                                                             Size="Size.Small" Class="payment-arrow" />
                                                    <div class="payment-player">
                                                        <div class="payment-player-avatar to">
                                                            @GetInitials(payment.ToPlayerName)
                                                        </div>
                                                        <span class="payment-player-name">@payment.ToPlayerName</span>
                                                    </div>
                                                </div>

                                                <div class="payment-footer">
                                                    <div class="payment-amount @(payment.IsJackpotContribution ? "jackpot" : "")">
                                                        R$ @payment.Amount.ToString("N0")
                                                    </div>

                                                    <div class="payment-actions">
                                                        @if (!payment.IsJackpotContribution && !string.IsNullOrEmpty(payment.ToPlayerPixKey))
                                                        {
                                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary"
                                                                     OnClick="@(() => CopyToClipboard(payment.ToPlayerPixKey))">
                                                                @GetPixTypeText(payment.ToPlayerPixKeyType)
                                                                <MudIcon Icon="@Icons.Material.Filled.ContentCopy"
                                                                         Size="Size.Small" Class="ml-1" />
                                                            </MudChip>
                                                        }

                                                        @if (_isOrganizer && payment.Status == PaymentStatus.Pending)
                                                        {
                                                            <MudButton Size="Size.Small" Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       OnClick="@(() => AdminMarkPaid(payment.Id))"
                                                                       Disabled="_processingPayment == payment.Id">
                                                                PAGO
                                                            </MudButton>
                                                        }
                                                        else if (_isOrganizer && payment.Status == PaymentStatus.Paid)
                                                        {
                                                            <MudButton Size="Size.Small" Variant="Variant.Outlined"
                                                                       Color="Color.Success"
                                                                       OnClick="@(() => AdminConfirm(payment.Id))"
                                                                       Disabled="_processingPayment == payment.Id">
                                                                Confirmar
                                                            </MudButton>
                                                        }
                                                        else if (payment.Status == PaymentStatus.Confirmed)
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        }
                </div>

                @* FAB para calcular pagamentos *@
                @if (_isOrganizer && (_payments == null || !_payments.Any()))
                {
                    <MudFab Class="mobile-fab"
                            Color="Color.Primary"
                            StartIcon="@Icons.Material.Filled.Calculate"
                            OnClick="CalculatePayments"
                            Disabled="_processing" />
                }
            </div>
        </Mobile>

        <Desktop>
            @* ===== VERSAO DESKTOP ===== *@
            <MudContainer MaxWidth="MaxWidth.Large" Class="py-4 payments-page">
                <MudBreadcrumbs Items="_breadcrumbs" Class="pa-0 mb-2">
                    <ItemTemplate Context="item">
                        <MudLink Href="@item.Href" Color="@(item.Disabled ? Color.Default : Color.Primary)">
                            @item.Text
                        </MudLink>
                    </ItemTemplate>
                </MudBreadcrumbs>

                <div class="desktop-header">
                    <div class="desktop-header-info">
                        <h1>Pagamentos</h1>
                        <div class="subtitle">@_tournament.Name</div>
                    </div>
                    <div class="desktop-header-actions">
                        <MudButton Variant="Variant.Outlined" Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.Share">
                            Compartilhar
                        </MudButton>
                        @if (_isOrganizer && (_payments == null || !_payments.Any()))
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Calculate"
                                       OnClick="CalculatePayments" Disabled="_processing">
                                @if (_processing)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                }
                                Calcular Pagamentos
                            </MudButton>
                        }
                        else if (_isOrganizer)
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.NotificationsActive">
                                Cobrar Todos
                            </MudButton>
                        }
                    </div>
                </div>

                <MudGrid>
                    @* Coluna principal (8 colunas) *@
                    <MudItem xs="12" lg="8">
                        @* Card Saldo do Torneio *@
                        @if (_balances != null && _balances.Any())
                        {
                            <div class="desktop-card">
                                <div class="desktop-card-header">
                                    <span class="desktop-card-title">Saldo do Torneio</span>
                                    <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Outlined">
                                        @_balances.Count jogadores
                                    </MudChip>
                                </div>

                                <div class="balance-table-container">
                                    <MudTable Items="@_balances" Hover="true" Elevation="0" Dense="true" Class="balance-table">
                                        <HeaderContent>
                                            <MudTh>Jogador</MudTh>
                                            <MudTh Style="text-align: right;">Investimento</MudTh>
                                            <MudTh Style="text-align: right;">Premio</MudTh>
                                            <MudTh Style="text-align: right;">Saldo</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="Jogador">
                                                <div class="d-flex align-center gap-2">
                                                    <MudAvatar Size="Size.Small" Color="Color.Primary">
                                                        @GetInitials(context.PlayerName)
                                                    </MudAvatar>
                                                    <MudText>@context.PlayerName</MudText>
                                                </div>
                                            </MudTd>
                                            <MudTd DataLabel="Investimento" Style="text-align: right;">
                                                <span class="mono-font">R$ @context.TotalInvestment.ToString("N0")</span>
                                            </MudTd>
                                            <MudTd DataLabel="Premio" Style="text-align: right;">
                                                <span class="mono-font">R$ @context.Prize.ToString("N0")</span>
                                            </MudTd>
                                            <MudTd DataLabel="Saldo" Style="text-align: right;">
                                                <span class="mono-font font-weight-bold"
                                                      style="color: @(context.Balance >= 0 ? "#22c55e" : "#ef4444")">
                                                    @(context.Balance >= 0 ? "+" : "")R$ @context.Balance.ToString("N0")
                                                </span>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </div>

                                <div class="totals-section">
                                    @if (_jackpotContribution > 0)
                                    {
                                        <div class="totals-row jackpot">
                                            <div class="totals-row-label">
                                                <MudIcon Icon="@Icons.Material.Filled.Savings" Size="Size.Small" Color="Color.Warning" />
                                                <span>Contribuicao para Caixinha</span>
                                            </div>
                                            <span class="totals-row-value">R$ @_jackpotContribution.ToString("N0")</span>
                                        </div>
                                    }
                                    <div class="totals-row total">
                                        <span class="totals-row-label">Total Prize Pool</span>
                                        <span class="totals-row-value">R$ @_balances.Sum(b => b.TotalInvestment).ToString("N0")</span>
                                    </div>
                                </div>
                            </div>
                        }

                        @* Card Lista de Pagamentos *@
                        @if (_payments != null && _payments.Any())
                        {
                            <div class="desktop-card">
                                <div class="desktop-card-header">
                                    <span class="desktop-card-title">Lista de Pagamentos</span>
                                    <div class="d-flex gap-2">
                                        <MudChip T="string" Color="Color.Warning" Size="Size.Small"
                                                 Variant="@(_paymentFilter == "pendente" ? Variant.Filled : Variant.Outlined)"
                                                 OnClick="@(() => _paymentFilter = _paymentFilter == "pendente" ? "todos" : "pendente")">
                                            @GetPendingCount() Pendentes
                                        </MudChip>
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small"
                                                 Variant="@(_paymentFilter == "confirmado" ? Variant.Filled : Variant.Outlined)"
                                                 OnClick="@(() => _paymentFilter = _paymentFilter == "confirmado" ? "todos" : "confirmado")">
                                            @GetConfirmedCount() Confirmados
                                        </MudChip>
                                    </div>
                                </div>

                                <MudTable Items="@FilteredPayments" Hover="true" Elevation="0" Breakpoint="Breakpoint.None" Class="payments-table">
                                    <HeaderContent>
                                        <MudTh>Tipo</MudTh>
                                        <MudTh>De</MudTh>
                                        <MudTh>Para</MudTh>
                                        <MudTh Style="text-align: right;">Valor</MudTh>
                                        <MudTh>PIX</MudTh>
                                        <MudTh Style="text-align: center;">Status</MudTh>
                                        @if (_isOrganizer)
                                        {
                                            <MudTh Style="text-align: center;">Acoes</MudTh>
                                        }
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="Tipo">
                                            @switch (context.Type)
                                            {
                                                case PaymentType.Poker:
                                                    <MudChip T="string" Color="Color.Success" Size="Size.Small">Poker</MudChip>
                                                    break;
                                                case PaymentType.Expense:
                                                    <MudChip T="string" Color="Color.Warning" Size="Size.Small">@context.Description</MudChip>
                                                    break;
                                                case PaymentType.Jackpot:
                                                    <MudChip T="string" Color="Color.Info" Size="Size.Small">Caixinha</MudChip>
                                                    break;
                                            }
                                        </MudTd>
                                        <MudTd DataLabel="De">
                                            <div class="d-flex align-center gap-2">
                                                <MudAvatar Size="Size.Small" Color="Color.Secondary">
                                                    @GetInitials(context.FromPlayerName)
                                                </MudAvatar>
                                                <MudText>@context.FromPlayerName</MudText>
                                            </div>
                                        </MudTd>
                                        <MudTd DataLabel="Para">
                                            <div class="d-flex align-center gap-2">
                                                <MudAvatar Size="Size.Small" Color="Color.Primary">
                                                    @GetInitials(context.ToPlayerName)
                                                </MudAvatar>
                                                <MudText>@context.ToPlayerName</MudText>
                                            </div>
                                        </MudTd>
                                        <MudTd DataLabel="Valor" Style="text-align: right;">
                                            <span class="mono-font font-weight-bold"
                                                  style="color: @(context.IsJackpotContribution ? "#eab308" : "inherit")">
                                                R$ @context.Amount.ToString("N0")
                                            </span>
                                        </MudTd>
                                        <MudTd DataLabel="PIX">
                                            @if (!string.IsNullOrEmpty(context.ToPlayerPixKey))
                                            {
                                                <div class="d-flex align-center gap-1">
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                                        @GetPixTypeText(context.ToPlayerPixKeyType)
                                                    </MudChip>
                                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                                                   OnClick="@(() => CopyToClipboard(context.ToPlayerPixKey))" Color="Color.Default" />
                                                </div>
                                            }
                                            else if (context.IsJackpotContribution)
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Warning">Pote Acumulado</MudText>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Sem PIX</MudText>
                                            }
                                        </MudTd>
                                        <MudTd DataLabel="Status" Style="text-align: center;">
                                            <MudChip T="string" Size="Size.Small"
                                                     Color="@GetStatusColor(context.Status)"
                                                     Variant="Variant.Filled">
                                                @GetStatusText(context.Status)
                                            </MudChip>
                                        </MudTd>
                                        @if (_isOrganizer)
                                        {
                                            <MudTd DataLabel="Acoes" Style="text-align: center;">
                                                @if (context.Status == PaymentStatus.Pending)
                                                {
                                                    <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Success"
                                                               OnClick="@(() => AdminMarkPaid(context.Id))"
                                                               Disabled="_processingPayment == context.Id">
                                                        PAGO
                                                    </MudButton>
                                                }
                                                else if (context.Status == PaymentStatus.Paid)
                                                {
                                                    <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Success"
                                                               OnClick="@(() => AdminConfirm(context.Id))"
                                                               Disabled="_processingPayment == context.Id">
                                                        Confirmar
                                                    </MudButton>
                                                }
                                                else
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                                }
                                            </MudTd>
                                        }
                                    </RowTemplate>
                                </MudTable>
                            </div>
                        }
                        else
                        {
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.Calculate" Size="Size.Large" Color="Color.Secondary" />
                                </div>
                                <MudText Typo="Typo.h6" Class="mt-2">Nenhum pagamento calculado</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Clique em "Calcular Pagamentos" para gerar os pagamentos.
                                </MudText>
                            </div>
                        }
                    </MudItem>

                    @* Coluna lateral (4 colunas) *@
                    <MudItem xs="12" lg="4">
                        @* Card Resumo *@
                        <div class="summary-sidebar">
                            <div class="summary-sidebar-title">Resumo</div>

                            <div class="summary-row">
                                <span class="summary-row-label">Total a receber</span>
                                <span class="summary-row-value success">
                                    R$ @GetTotalToReceive().ToString("N0")
                                </span>
                            </div>
                            <div class="summary-row">
                                <span class="summary-row-label">Pagamentos pendentes</span>
                                <span class="summary-row-value warning">
                                    @GetPendingCount()
                                </span>
                            </div>
                            <div class="summary-row">
                                <span class="summary-row-label">Pagamentos confirmados</span>
                                <span class="summary-row-value success">
                                    @GetConfirmedCount()
                                </span>
                            </div>

                            @if (_payments != null && _payments.Any())
                            {
                                <MudDivider Class="my-3" />
                                <MudProgressLinear Color="Color.Success" Rounded="true" Size="Size.Large"
                                                   Value="@GetProgressPercent()" Class="mb-2" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                                    @GetProgressPercent().ToString("N0")% concluido
                                </MudText>
                            }
                        </div>

                        @* Card Acoes Rapidas *@
                        <div class="quick-actions">
                            <div class="quick-actions-title">Acoes Rapidas</div>

                            <div class="quick-actions-list">
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.Send">
                                    Enviar Lembrete
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Default" FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.Download">
                                    Exportar Relatorio
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Default" FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.History"
                                           Href="@($"/torneios/{TournamentId}")">
                                    Ver Torneio
                                </MudButton>
                            </div>
                        </div>
                    </MudItem>
                </MudGrid>
            </MudContainer>
        </Desktop>
    </ResponsiveLayout>
}

@code {
    [Parameter] public Guid TournamentId { get; set; }

    private TournamentDto? _tournament;
    private IReadOnlyList<PaymentDto>? _payments;
    private IReadOnlyList<PlayerBalanceDto>? _balances;
    private IReadOnlyList<ExpenseSummaryDto>? _expenseSummary;
    private decimal _jackpotContribution;
    private bool _loading = true;
    private bool _processing;
    private Guid? _processingPayment;
    private bool _isOrganizer;
    private string? _currentUserId;
    private List<BreadcrumbItem> _breadcrumbs = new();

    // Mobile state
    private string _mobileTab = "saldo";
    private string _paymentFilter = "todos";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _tournament = await TournamentService.GetTournamentByIdAsync(TournamentId);

        if (_tournament != null)
        {
            _breadcrumbs = new List<BreadcrumbItem>
            {
                new("Torneios", "/torneios", false),
                new(_tournament.Name, $"/torneios/{TournamentId}", false),
                new("Pagamentos", null, true)
            };

            if (!string.IsNullOrEmpty(_currentUserId))
            {
                _isOrganizer = await LeagueService.IsUserOrganizerAsync(_tournament.LeagueId, _currentUserId);
            }

            if (_tournament.Status == TournamentStatus.Finished)
            {
                _payments = await PaymentService.GetPaymentsByTournamentAsync(TournamentId);
                _balances = await PaymentService.GetTournamentPlayerBalancesAsync(TournamentId);
                _expenseSummary = await ExpenseService.GetExpenseSummaryByTournamentAsync(TournamentId);
                _jackpotContribution = await PaymentService.GetJackpotContributionAsync(TournamentId);
            }
        }
        _loading = false;
    }

    private IEnumerable<PaymentDto> FilteredPayments => _paymentFilter switch
    {
        "pendente" => _payments?.Where(p => p.Status == PaymentStatus.Pending) ?? Enumerable.Empty<PaymentDto>(),
        "confirmado" => _payments?.Where(p => p.Status == PaymentStatus.Confirmed) ?? Enumerable.Empty<PaymentDto>(),
        _ => _payments ?? Enumerable.Empty<PaymentDto>()
    };

    private int GetPendingCount() => _payments?.Count(p => p.Status == PaymentStatus.Pending) ?? 0;
    private int GetConfirmedCount() => _payments?.Count(p => p.Status == PaymentStatus.Confirmed) ?? 0;

    private decimal GetTotalToReceive()
    {
        if (_payments == null || !_payments.Any()) return 0;
        return _payments.Where(p => p.Status == PaymentStatus.Pending).Sum(p => p.Amount);
    }

    private double GetProgressPercent()
    {
        if (_payments == null || !_payments.Any()) return 0;
        return (GetConfirmedCount() * 100.0) / _payments.Count;
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "?";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();

        return name.Length >= 2 ? name[..2].ToUpper() : name.ToUpper();
    }

    private async Task CalculatePayments()
    {
        _processing = true;
        try
        {
            _payments = await PaymentService.CalculateAndCreatePaymentsAsync(TournamentId);
            _balances = await PaymentService.GetTournamentPlayerBalancesAsync(TournamentId);
            Snackbar.Add("Pagamentos calculados com sucesso!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao calcular pagamentos: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private string GetPixTypeText(PixKeyType? type) => type switch
    {
        PixKeyType.CPF => "CPF",
        PixKeyType.Email => "Email",
        PixKeyType.Phone => "Telefone",
        PixKeyType.Random => "Aleatoria",
        _ => "PIX"
    };

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            Snackbar.Add("Chave PIX copiada!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Erro ao copiar", Severity.Error);
        }
    }

    private Color GetStatusColor(PaymentStatus status) => status switch
    {
        PaymentStatus.Pending => Color.Warning,
        PaymentStatus.Paid => Color.Info,
        PaymentStatus.Confirmed => Color.Success,
        _ => Color.Default
    };

    private string GetStatusText(PaymentStatus status) => status switch
    {
        PaymentStatus.Pending => "Pendente",
        PaymentStatus.Paid => "Pago",
        PaymentStatus.Confirmed => "Confirmado",
        _ => status.ToString()
    };

    private async Task AdminMarkPaid(Guid paymentId)
    {
        if (string.IsNullOrEmpty(_currentUserId)) return;

        var confirmed = await DialogService.ShowMessageBox(
            "Confirmar Pagamento",
            "Deseja marcar este pagamento como pago?",
            yesText: "Sim", cancelText: "Cancelar");

        if (confirmed != true) return;

        _processingPayment = paymentId;
        try
        {
            var success = await PaymentService.AdminMarkAsPaidAsync(paymentId, _currentUserId);
            if (success)
            {
                Snackbar.Add("Pagamento marcado como pago!", Severity.Success);
                _payments = await PaymentService.GetPaymentsByTournamentAsync(TournamentId);
            }
            else
            {
                Snackbar.Add("Erro ao marcar pagamento", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processingPayment = null;
        }
    }

    private async Task AdminConfirm(Guid paymentId)
    {
        if (string.IsNullOrEmpty(_currentUserId)) return;

        var confirmed = await DialogService.ShowMessageBox(
            "Confirmar Recebimento",
            "Deseja confirmar o recebimento deste pagamento?",
            yesText: "Sim", cancelText: "Cancelar");

        if (confirmed != true) return;

        _processingPayment = paymentId;
        try
        {
            var success = await PaymentService.AdminConfirmPaymentAsync(paymentId, _currentUserId);
            if (success)
            {
                Snackbar.Add("Pagamento confirmado!", Severity.Success);
                _payments = await PaymentService.GetPaymentsByTournamentAsync(TournamentId);
            }
            else
            {
                Snackbar.Add("Erro ao confirmar pagamento", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processingPayment = null;
        }
    }
}
