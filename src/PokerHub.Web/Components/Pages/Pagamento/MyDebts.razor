@page "/meus-debitos"
@page "/jogador/{PlayerId:guid}/debitos"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IPaymentService PaymentService
@inject IPlayerService PlayerService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Meus Debitos - PokerHub</PageTitle>

<div class="debts-page">
    @if (_loading)
    {
        <div class="loading-container">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-3">Carregando debitos...</MudText>
        </div>
    }
    else if (_noPlayerAssociated && (_organizerPayments == null || !_organizerPayments.Any()))
    {
        <div class="empty-container">
            <div class="empty-icon">üë§</div>
            <MudText Typo="Typo.h6">Nenhum jogador vinculado</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                Peca ao organizador da liga para vincular seu jogador a sua conta.
            </MudText>
        </div>
    }
    else
    {
        @* ===== HEADER ===== *@
        <div class="page-header">
            <div class="page-title">üí≥ Meus Debitos</div>
            <div class="page-subtitle">Todas as ligas ‚Ä¢ Atualizado agora</div>
        </div>

        @* ===== SUMMARY CARDS ===== *@
        <div class="summary-row">
            <div class="summary-card debt">
                <div class="summary-label">A Pagar</div>
                <div class="summary-value">@_totalDebt.ToString("C")</div>
                <div class="summary-count">@_debtCount pendente@(_debtCount != 1 ? "s" : "")</div>
            </div>
            <div class="summary-card credit">
                <div class="summary-label">A Receber</div>
                <div class="summary-value">@_totalCredit.ToString("C")</div>
                <div class="summary-count">@_creditCount pendente@(_creditCount != 1 ? "s" : "")</div>
            </div>
        </div>

        @* ===== BALANCE CARD ===== *@
        <div class="balance-card @(_netBalance >= 0 ? "positive" : "negative")">
            <div class="balance-icon">üìä</div>
            <div class="balance-info">
                <div class="balance-label">Saldo Liquido</div>
                <div class="balance-value">@(_netBalance >= 0 ? "+" : "")@_netBalance.ToString("C")</div>
            </div>
        </div>

        @* ===== TABS ===== *@
        <div class="tabs">
            <div class="tab @(_activeTab == 0 ? "active debt" : "")" @onclick="@(() => _activeTab = 0)">
                <div class="tab-icon">üí∏</div>
                <div class="tab-count">@_totalDebt.ToString("C0")</div>
                <div class="tab-label">A Pagar</div>
            </div>
            <div class="tab @(_activeTab == 1 ? "active credit" : "")" @onclick="@(() => _activeTab = 1)">
                <div class="tab-icon">üí∞</div>
                <div class="tab-count">@_totalCredit.ToString("C0")</div>
                <div class="tab-label">A Receber</div>
            </div>
            @if (_organizerPayments?.Any() == true)
            {
                <div class="tab @(_activeTab == 2 ? "active admin" : "")" @onclick="@(() => _activeTab = 2)">
                    <div class="tab-icon">üëë</div>
                    <div class="tab-count">@_organizerPayments.Count</div>
                    <div class="tab-label">Admin</div>
                </div>
            }
        </div>

        @* ===== TAB CONTENT ===== *@
        @if (_activeTab == 0)
        {
            @* ----- A PAGAR ----- *@
            @if (_debts == null || !_debts.Any())
            {
                <div class="empty-state">
                    <div class="empty-icon">üéâ</div>
                    <div class="empty-title">Nenhum debito pendente!</div>
                    <div class="empty-text">Voce esta em dia com todos os pagamentos.</div>
                </div>
            }
            else
            {
                @* Filters *@
                <div class="filters">
                    <div class="filter-chip @(_debtFilter == "all" ? "active" : "")" @onclick="@(() => _debtFilter = "all")">
                        Todos
                    </div>
                    <div class="filter-chip @(_debtFilter == "poker" ? "active" : "")" @onclick="@(() => _debtFilter = "poker")">
                        üé∞ Poker
                    </div>
                    <div class="filter-chip @(_debtFilter == "lanches" ? "active" : "")" @onclick="@(() => _debtFilter = "lanches")">
                        üçî Lanches
                    </div>
                    <div class="filter-chip @(_debtFilter == "caixinha" ? "active" : "")" @onclick="@(() => _debtFilter = "caixinha")">
                        üê∑ Caixinha
                    </div>
                </div>

                @* Debt Cards *@
                <div class="debt-list">
                    @foreach (var debt in FilteredDebts)
                    {
                        <div class="debt-card @GetDebtCardClass(debt.DaysOpen)">
                            <div class="debt-header">
                                <div class="debt-info">
                                    <div class="debt-tournament">@debt.TournamentName</div>
                                    <div class="debt-date">@debt.TournamentDate.ToString("dd/MM/yyyy")</div>
                                </div>
                                <div class="type-badge @GetTypeBadgeClass(debt)">
                                    @GetTypeIcon(debt) @GetTypeLabel(debt)
                                </div>
                            </div>

                            <div class="debt-body">
                                <div class="debt-recipient">
                                    <div class="debt-recipient-label">Pagar para:</div>
                                    <div class="debt-recipient-name">@debt.CreditorPlayerName</div>
                                </div>
                                <div class="debt-amount">
                                    <div class="debt-amount-label">Valor:</div>
                                    <div class="debt-amount-value">@debt.Amount.ToString("C")</div>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(debt.CreditorPixKey))
                            {
                                <div class="debt-pix">
                                    <span class="debt-pix-label">PIX:</span>
                                    <span class="debt-pix-value">@debt.CreditorPixKey</span>
                                    <span class="debt-pix-copy" @onclick="@(() => CopyToClipboard(debt.CreditorPixKey))">üìã</span>
                                </div>
                            }
                            else if (debt.Type != PaymentType.Jackpot)
                            {
                                <div class="debt-no-pix">
                                    ‚ö†Ô∏è Credor nao cadastrou chave PIX. Entre em contato diretamente.
                                </div>
                            }

                            <div class="debt-action">
                                <button class="btn btn-primary"
                                        @onclick="@(() => MarkAsPaid(debt))"
                                        disabled="@(_processingPaymentId == debt.PaymentId)">
                                    @if (_processingPaymentId == debt.PaymentId)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    }
                                    ‚úì Marcar como Pago
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        }
        else if (_activeTab == 1)
        {
            @* ----- A RECEBER ----- *@
            @if (_toReceive == null || !_toReceive.Any())
            {
                <div class="empty-state">
                    <div class="empty-icon">üí∞</div>
                    <div class="empty-title">Nenhum pagamento a receber</div>
                    <div class="empty-text">Voce nao tem valores pendentes para receber.</div>
                </div>
            }
            else
            {
                <div class="section-header">
                    <div class="section-title">
                        üí∞ Pagamentos a Receber
                        <span class="section-badge green">@_toReceive.Count</span>
                    </div>
                </div>

                <div class="credit-list">
                    @foreach (var payment in _toReceive)
                    {
                        <div class="credit-card">
                            <div class="type-badge-small @GetTypeBadgeClassFromPayment(payment)">
                                @GetTypeIconFromPayment(payment)
                            </div>
                            <div class="credit-info">
                                <div class="credit-tournament">@payment.TournamentName</div>
                                <div class="credit-from">
                                    de <strong>@payment.FromPlayerName</strong>
                                </div>
                            </div>
                            <div class="credit-status">
                                <div class="credit-amount">@payment.Amount.ToString("C")</div>
                                <div class="status-badge @GetStatusClass(payment.Status)">
                                    @GetStatusText(payment.Status)
                                </div>
                                @if (payment.Status == PaymentStatus.Paid)
                                {
                                    <button class="confirm-btn"
                                            @onclick="@(() => ConfirmPayment(payment))"
                                            disabled="@(_processingPaymentId == payment.Id)">
                                        Confirmar
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        }
        else if (_activeTab == 2)
        {
            @* ----- ADMIN ----- *@
            <div class="admin-section">
                <div class="admin-header">
                    <span class="admin-icon">üëë</span>
                    <span class="admin-title">Gerenciar Pagamentos</span>
                    <span class="admin-badge">@_organizerPayments?.Count</span>
                </div>

                <div class="admin-subtitle">
                    Como organizador, confirme os pagamentos das suas ligas.
                </div>

                @* Filters *@
                <div class="filters">
                    <div class="filter-chip @(_adminFilter == "pending" ? "active" : "")" @onclick="@(() => _adminFilter = "pending")">
                        Pendentes
                    </div>
                    <div class="filter-chip @(_adminFilter == "paid" ? "active" : "")" @onclick="@(() => _adminFilter = "paid")">
                        Aguardando
                    </div>
                    <div class="filter-chip @(_adminFilter == "all" ? "active" : "")" @onclick="@(() => _adminFilter = "all")">
                        Todos
                    </div>
                </div>

                @if (FilteredOrganizerPayments?.Any() != true)
                {
                    <div class="empty-state" style="padding: 20px;">
                        <div class="empty-icon">‚úÖ</div>
                        <div class="empty-title">Nenhum pagamento pendente</div>
                    </div>
                }
                else
                {
                    <div class="admin-list">
                        @foreach (var payment in FilteredOrganizerPayments)
                        {
                            <div class="admin-card">
                                <div class="type-badge-small @GetTypeBadgeClassFromPayment(payment)">
                                    @GetTypeIconFromPayment(payment)
                                </div>
                                <div class="admin-card-info">
                                    <div class="admin-card-tournament">@payment.TournamentName</div>
                                    <div class="admin-card-players">
                                        @payment.FromPlayerName ‚Üí @payment.ToPlayerName
                                    </div>
                                </div>
                                <div class="admin-card-values">
                                    <div class="admin-card-amount @(payment.IsJackpotContribution ? "caixinha" : "")">
                                        @payment.Amount.ToString("C")
                                    </div>
                                    <div class="admin-card-days">@payment.DaysOpen dia@(payment.DaysOpen != 1 ? "s" : "")</div>
                                </div>
                                <div class="admin-card-actions">
                                    @if (payment.Status == PaymentStatus.Pending)
                                    {
                                        <button class="action-btn mark-paid"
                                                @onclick="@(() => AdminMarkPaid(payment.Id))"
                                                disabled="@(_processingPaymentId == payment.Id)">
                                            Pago
                                        </button>
                                    }
                                    else if (payment.Status == PaymentStatus.Paid)
                                    {
                                        <button class="action-btn confirm"
                                                @onclick="@(() => AdminConfirm(payment.Id))"
                                                disabled="@(_processingPaymentId == payment.Id)">
                                            Confirmar
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="status-done">‚úì</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    [Parameter] public Guid? PlayerId { get; set; }

    private IReadOnlyList<PendingDebtDto>? _debts;
    private IReadOnlyList<PaymentDto>? _toReceive;
    private IReadOnlyList<PaymentDto>? _organizerPayments;
    private bool _loading = true;
    private bool _noPlayerAssociated;
    private Guid _currentPlayerId;
    private string? _currentUserId;
    private Guid? _processingPaymentId;

    // UI State
    private int _activeTab = 0;
    private string _debtFilter = "all";
    private string _adminFilter = "pending";

    // Calculated values
    private decimal _totalDebt => _debts?.Sum(d => d.Amount) ?? 0;
    private decimal _totalCredit => _toReceive?.Where(p => p.Status != PaymentStatus.Confirmed).Sum(p => p.Amount) ?? 0;
    private decimal _netBalance => _totalCredit - _totalDebt;
    private int _debtCount => _debts?.Count ?? 0;
    private int _creditCount => _toReceive?.Count(p => p.Status != PaymentStatus.Confirmed) ?? 0;

    // Filtered lists
    private IEnumerable<PendingDebtDto> FilteredDebts => _debtFilter switch
    {
        "poker" => _debts?.Where(d => d.Type == PaymentType.Poker && string.IsNullOrEmpty(d.Description)) ?? Enumerable.Empty<PendingDebtDto>(),
        "lanches" => _debts?.Where(d => d.Type == PaymentType.Expense || (!string.IsNullOrEmpty(d.Description) && d.Description.Contains("Lanche", StringComparison.OrdinalIgnoreCase))) ?? Enumerable.Empty<PendingDebtDto>(),
        "caixinha" => _debts?.Where(d => d.Type == PaymentType.Jackpot) ?? Enumerable.Empty<PendingDebtDto>(),
        _ => _debts ?? Enumerable.Empty<PendingDebtDto>()
    };

    private IEnumerable<PaymentDto>? FilteredOrganizerPayments => _adminFilter switch
    {
        "pending" => _organizerPayments?.Where(p => p.Status == PaymentStatus.Pending),
        "paid" => _organizerPayments?.Where(p => p.Status == PaymentStatus.Paid),
        _ => _organizerPayments
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(_currentUserId))
        {
            _organizerPayments = await PaymentService.GetPaymentsForOrganizerAsync(_currentUserId);
        }

        if (PlayerId.HasValue)
        {
            _currentPlayerId = PlayerId.Value;
            _debts = await PlayerService.GetPendingDebtsAsync(_currentPlayerId);
            _toReceive = await PaymentService.GetPendingPaymentsToReceiveAsync(_currentPlayerId);
        }
        else
        {
            if (!string.IsNullOrEmpty(_currentUserId))
            {
                var players = await PlayerService.GetAllPlayersByUserAsync(_currentUserId);

                if (players.Any())
                {
                    var allDebts = new List<PendingDebtDto>();
                    var allToReceive = new List<PaymentDto>();

                    foreach (var player in players)
                    {
                        var playerDebts = await PlayerService.GetPendingDebtsAsync(player.Id);
                        allDebts.AddRange(playerDebts);

                        var playerToReceive = await PaymentService.GetPendingPaymentsToReceiveAsync(player.Id);
                        allToReceive.AddRange(playerToReceive);
                    }

                    _debts = allDebts;
                    _toReceive = allToReceive;
                    _currentPlayerId = players.First().Id;
                }
                else
                {
                    _noPlayerAssociated = _organizerPayments == null || !_organizerPayments.Any();
                }
            }
            else
            {
                _noPlayerAssociated = true;
            }
        }

        _loading = false;
    }

    private string GetDebtCardClass(int daysOpen)
    {
        if (daysOpen > 7) return "critical";
        if (daysOpen > 3) return "warning";
        return "";
    }

    private string GetTypeBadgeClass(PendingDebtDto debt)
    {
        if (debt.Type == PaymentType.Jackpot) return "caixinha";
        if (debt.Type == PaymentType.Expense || (!string.IsNullOrEmpty(debt.Description) && debt.Description.Contains("Lanche", StringComparison.OrdinalIgnoreCase))) return "lanches";
        return "poker";
    }

    private string GetTypeIcon(PendingDebtDto debt)
    {
        if (debt.Type == PaymentType.Jackpot) return "üê∑";
        if (debt.Type == PaymentType.Expense || (!string.IsNullOrEmpty(debt.Description) && debt.Description.Contains("Lanche", StringComparison.OrdinalIgnoreCase))) return "üçî";
        return "üé∞";
    }

    private string GetTypeLabel(PendingDebtDto debt)
    {
        if (debt.Type == PaymentType.Jackpot) return "Caixinha";
        if (debt.Type == PaymentType.Expense || (!string.IsNullOrEmpty(debt.Description) && debt.Description.Contains("Lanche", StringComparison.OrdinalIgnoreCase))) return "Lanches";
        return "Poker";
    }

    private string GetTypeBadgeClassFromPayment(PaymentDto payment)
    {
        if (payment.IsJackpotContribution) return "caixinha";
        if (!string.IsNullOrEmpty(payment.Description) && payment.Description.Contains("Lanche", StringComparison.OrdinalIgnoreCase)) return "lanches";
        return "poker";
    }

    private string GetTypeIconFromPayment(PaymentDto payment)
    {
        if (payment.IsJackpotContribution) return "üê∑";
        if (!string.IsNullOrEmpty(payment.Description) && payment.Description.Contains("Lanche", StringComparison.OrdinalIgnoreCase)) return "üçî";
        return "üé∞";
    }

    private string GetStatusClass(PaymentStatus status) => status switch
    {
        PaymentStatus.Pending => "pending",
        PaymentStatus.Paid => "paid",
        PaymentStatus.Confirmed => "confirmed",
        _ => ""
    };

    private string GetStatusText(PaymentStatus status) => status switch
    {
        PaymentStatus.Pending => "Pendente",
        PaymentStatus.Paid => "Pago",
        PaymentStatus.Confirmed => "Confirmado",
        _ => status.ToString()
    };

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            Snackbar.Add("Chave PIX copiada!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Erro ao copiar", Severity.Error);
        }
    }

    private async Task MarkAsPaid(PendingDebtDto debt)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Confirmar Pagamento",
            $"Voce confirma que pagou {debt.Amount:C} para {debt.CreditorPlayerName}?",
            "Sim, Paguei", "Cancelar");

        if (confirm == true)
        {
            _processingPaymentId = debt.PaymentId;
            try
            {
                await PaymentService.MarkAsPaidAsync(debt.PaymentId, _currentPlayerId);
                Snackbar.Add("Pagamento marcado como pago. Aguardando confirmacao.", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
            }
            finally
            {
                _processingPaymentId = null;
            }
        }
    }

    private async Task ConfirmPayment(PaymentDto payment)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Confirmar Recebimento",
            $"Voce confirma que recebeu {payment.Amount:C} de {payment.FromPlayerName}?",
            "Sim, Recebi", "Cancelar");

        if (confirm == true)
        {
            _processingPaymentId = payment.Id;
            try
            {
                await PaymentService.ConfirmPaymentAsync(payment.Id, _currentPlayerId);
                Snackbar.Add("Pagamento confirmado!", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
            }
            finally
            {
                _processingPaymentId = null;
            }
        }
    }

    private async Task AdminMarkPaid(Guid paymentId)
    {
        if (string.IsNullOrEmpty(_currentUserId)) return;

        var confirmed = await DialogService.ShowMessageBox(
            "Confirmar Pagamento",
            "Deseja marcar este pagamento como pago?",
            yesText: "Sim", cancelText: "Cancelar");

        if (confirmed != true) return;

        _processingPaymentId = paymentId;
        try
        {
            var success = await PaymentService.AdminMarkAsPaidAsync(paymentId, _currentUserId);
            if (success)
            {
                Snackbar.Add("Pagamento marcado como pago!", Severity.Success);
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processingPaymentId = null;
        }
    }

    private async Task AdminConfirm(Guid paymentId)
    {
        if (string.IsNullOrEmpty(_currentUserId)) return;

        var confirmed = await DialogService.ShowMessageBox(
            "Confirmar Recebimento",
            "Deseja confirmar o recebimento deste pagamento?",
            yesText: "Sim", cancelText: "Cancelar");

        if (confirmed != true) return;

        _processingPaymentId = paymentId;
        try
        {
            var success = await PaymentService.AdminConfirmPaymentAsync(paymentId, _currentUserId);
            if (success)
            {
                Snackbar.Add("Pagamento confirmado!", Severity.Success);
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processingPaymentId = null;
        }
    }
}
