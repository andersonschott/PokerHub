@page "/Account/Manage/ChangePassword"
@layout PokerHub.Web.Components.Layout.MainLayout
@rendermode InteractiveServer
@attribute [Authorize]

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using PokerHub.Domain.Entities

@inject UserManager<User> UserManager
@inject SignInManager<User> SignInManager
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject ILogger<ChangePassword> Logger

<PageTitle>Alterar Senha - PokerHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-6">
    <MudPaper Elevation="4" Class="pa-8">
        <MudStack AlignItems="AlignItems.Center" Class="mb-6">
            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Primary"/>
            <MudText Typo="Typo.h5">Alterar Senha</MudText>
        </MudStack>

        @if (!string.IsNullOrEmpty(_message))
        {
            <MudAlert Severity="@(_isSuccess ? Severity.Success : Severity.Error)" Class="mb-4">
                @_message
            </MudAlert>
        }

        <EditForm Model="Input" OnValidSubmit="OnValidSubmitAsync">
            <DataAnnotationsValidator/>

            <MudStack Spacing="3">
                <MudTextField @bind-Value="Input.OldPassword"
                             Label="Senha Atual"
                             Variant="Variant.Outlined"
                             InputType="InputType.Password"
                             For="@(() => Input.OldPassword)"
                             Immediate="true"/>

                <MudTextField @bind-Value="Input.NewPassword"
                             Label="Nova Senha"
                             Variant="Variant.Outlined"
                             InputType="InputType.Password"
                             HelperText="Minimo 6 caracteres"
                             For="@(() => Input.NewPassword)"
                             Immediate="true"/>

                <MudTextField @bind-Value="Input.ConfirmPassword"
                             Label="Confirmar Nova Senha"
                             Variant="Variant.Outlined"
                             InputType="InputType.Password"
                             For="@(() => Input.ConfirmPassword)"
                             Immediate="true"/>

                <MudButton ButtonType="ButtonType.Submit"
                          Variant="Variant.Filled"
                          Color="Color.Primary"
                          FullWidth="true"
                          Size="Size.Large"
                          Class="mt-2"
                          Disabled="_processing">
                    @if (_processing)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                    }
                    Alterar Senha
                </MudButton>
            </MudStack>
        </EditForm>

        <MudDivider Class="my-4"/>

        <MudButton Href="/"
                  Variant="Variant.Text"
                  Color="Color.Default"
                  FullWidth="true"
                  StartIcon="@Icons.Material.Filled.ArrowBack">
            Voltar ao Inicio
        </MudButton>
    </MudPaper>
</MudContainer>

@code {
    private string? _message;
    private bool _isSuccess;
    private bool _processing;
    private User? _user;

    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            _user = await UserManager.FindByIdAsync(userId);
        }

        if (_user == null)
        {
            NavigationManager.NavigateTo("/Account/Login");
        }
    }

    private async Task OnValidSubmitAsync()
    {
        if (_user == null) return;

        _processing = true;
        _message = null;

        try
        {
            var changePasswordResult = await UserManager.ChangePasswordAsync(_user, Input.OldPassword, Input.NewPassword);

            if (changePasswordResult.Succeeded)
            {
                Logger.LogInformation("User changed their password successfully.");
                _isSuccess = true;
                _message = "Senha alterada com sucesso!";
                Input = new InputModel(); // Limpar formulario
            }
            else
            {
                _isSuccess = false;
                _message = $"Erro: {string.Join(", ", changePasswordResult.Errors.Select(error => error.Description))}";
            }
        }
        catch (Exception ex)
        {
            _isSuccess = false;
            _message = $"Erro ao alterar senha: {ex.Message}";
            Logger.LogError(ex, "Error changing password");
        }
        finally
        {
            _processing = false;
        }
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Senha atual e obrigatoria")]
        [DataType(DataType.Password)]
        public string OldPassword { get; set; } = "";

        [Required(ErrorMessage = "Nova senha e obrigatoria")]
        [StringLength(100, ErrorMessage = "A senha deve ter entre {2} e {1} caracteres.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        public string NewPassword { get; set; } = "";

        [Required(ErrorMessage = "Confirmacao e obrigatoria")]
        [DataType(DataType.Password)]
        [Compare("NewPassword", ErrorMessage = "As senhas nao coincidem.")]
        public string ConfirmPassword { get; set; } = "";
    }
}
